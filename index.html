<!DOCTYPE html><html lang="zh-CN"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°çº¢ä¹¦å›¾æ–‡å°é¢ç”Ÿæˆå™¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://unpkg.com/psd.js@3.4.0/dist/psd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&amp;family=Noto+Sans+SC:wght@300;400;500;700&amp;family=ZCOOL+XiaoWei&amp;family=ZCOOL+KuaiLe&amp;family=Ma+Shan+Zheng&amp;family=Liu+Jian+Mao+Cao&amp;family=Long+Cang&amp;family=Zhi+Mang+Xing&amp;family=ZCOOL+QingKe+HuangYou&amp;family=Noto+Serif+TC:wght@400;700&amp;family=Noto+Sans+TC:wght@400;700&amp;family=Rubik+Bubbles&amp;family=Rubik:ital,wght@0,400;0,700;1,700&amp;family=Playfair+Display:ital,wght@0,400;1,400&amp;family=Nunito:wght@600&amp;family=Arizonia&amp;family=Henny+Penny&amp;family=Cinzel:wght@400;700&amp;family=Shrikhand&amp;family=Love+Light&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: {} }
    }
  </script>
  <style>
    /* ğŸ”´ å°çº¢ä¹¦å®˜æ–¹å“ç‰Œè‰²ç³» - æ·¡ç²‰è‰²ä¸»é¢˜ */
    :root {
      --xhs-red: #FF2442;
      --xhs-red-light: #FF4D6A;
      --xhs-red-dark: #E01F3D;
      --xhs-bg: linear-gradient(135deg, #FEF7F8 0%, #FFF5F5 50%, #FEF0F0 100%);
      --xhs-bg-solid: #FEF5F6;
      --xhs-card: #FFFFFF;
      --xhs-border: #FFE4E8;
      --xhs-text: #333333;
      --xhs-text-secondary: #999999;
      --xhs-text-light: #666666;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'PingFang SC', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--xhs-bg);
      min-height: 100vh;
      color: var(--xhs-text);
    }
    .dark body {
      --xhs-bg: #121212;
      --xhs-card: #1E1E1E;
      --xhs-border: #333333;
      --xhs-text: #FFFFFF;
      --xhs-text-secondary: #888888;
      --xhs-text-light: #AAAAAA;
      background: var(--xhs-bg);
    }
    /* å°çº¢ä¹¦ Logo é£æ ¼ */
    .xhs-logo {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .xhs-logo-icon {
      width: 36px;
      height: 36px;
      background: var(--xhs-red);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }
    .xhs-logo-text {
      font-size: 20px;
      font-weight: 700;
      color: var(--xhs-text);
    }
    .xhs-logo-text span {
      color: var(--xhs-red);
    }
    .logo-text {
      color: var(--xhs-red);
      font-weight: 700;
    }
    /* å°çº¢ä¹¦é£æ ¼å¡ç‰‡ */
    .xhs-card {
      background: var(--xhs-card);
      border-radius: 12px;
      border: 1px solid var(--xhs-border);
      transition: all 0.2s ease;
    }
    .xhs-card:hover {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    .template-card {
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
    }
    .template-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(255, 36, 66, 0.12);
    }
    .template-card.active {
      box-shadow: 0 0 0 2px var(--xhs-red);
    }
    .template-delete {
      position: absolute; top: 4px; right: 4px;
      width: 18px; height: 18px;
      background: var(--xhs-red);
      color: white; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; opacity: 0;
      transition: opacity 0.2s; z-index: 10;
    }
    .template-card:hover .template-delete { opacity: 1; }
    .preview-card {
      aspect-ratio: 3/4;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--xhs-border);
    }
    /* å°çº¢ä¹¦é£æ ¼æŒ‰é’® */
    .btn-primary {
      background: var(--xhs-red);
      color: white;
      border: none;
      border-radius: 20px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .btn-primary:hover {
      background: var(--xhs-red-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 36, 66, 0.3);
    }
    .btn-primary:active {
      transform: translateY(0);
    }
    /* å°çº¢ä¹¦é£æ ¼æ¬¡è¦æŒ‰é’® */
    .btn-secondary {
      background: transparent;
      color: var(--xhs-red);
      border: 1px solid var(--xhs-red);
      border-radius: 20px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .btn-secondary:hover {
      background: rgba(255, 36, 66, 0.08);
    }
    .slider-custom::-webkit-slider-thumb {
      appearance: none; width: 16px; height: 16px;
      background: var(--xhs-red);
      border-radius: 50%; cursor: pointer;
      box-shadow: 0 2px 6px rgba(255, 36, 66, 0.3);
    }
    .slider-custom::-webkit-slider-runnable-track {
      height: 4px; background: #E5E5E5; border-radius: 2px;
    }
    .dark .slider-custom::-webkit-slider-runnable-track { background: #374151; }
    .input-file-zone {
      border: 1.5px dashed #DDDDDD;
      background: #FAFAFA;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .input-file-zone:hover, .input-file-zone.dragover {
      border-color: var(--xhs-red);
      background: rgba(255, 36, 66, 0.03);
    }
    .dark .input-file-zone {
      background: #252525;
      border-color: #444;
    }
    .page-indicator { display: flex; gap: 6px; justify-content: center; margin-top: 12px; flex-wrap: wrap; }
    .page-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #DDD; cursor: pointer; transition: all 0.2s ease;
    }
    .page-dot.active {
      background: var(--xhs-red);
      width: 20px;
      border-radius: 4px;
    }
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex; align-items: center; justify-content: center;
      z-index: 50; opacity: 0; visibility: hidden;
      transition: all 0.25s ease;
      backdrop-filter: blur(4px);
    }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal-content {
      background: var(--xhs-card);
      border-radius: 16px;
      padding: 24px;
      max-width: 400px; width: 90%;
      transform: scale(0.95) translateY(10px);
      transition: all 0.25s ease;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    }
    .modal-overlay.show .modal-content {
      transform: scale(1) translateY(0);
    }
    .dark .modal-content { background: #1E1E1E; }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up { animation: fadeInUp 0.4s ease forwards; }
    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(72px, 1fr));
      gap: 8px;
    }
    .upload-template-card {
      border: 1.5px dashed #DDD;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s ease;
      background: #FAFAFA;
      border-radius: 8px;
    }
    .upload-template-card:hover {
      border-color: var(--xhs-red);
      background: rgba(255, 36, 66, 0.05);
    }
    .dark .upload-template-card {
      background: #252525;
      border-color: #444;
    }
    .loading-overlay {
      position: fixed; inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 100; opacity: 0; visibility: hidden;
      transition: all 0.25s ease;
      backdrop-filter: blur(8px);
    }
    .loading-overlay.show { opacity: 1; visibility: visible; }
    .loading-spinner {
      width: 40px; height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top-color: var(--xhs-red);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .file-badge {
      background: rgba(255, 36, 66, 0.08);
      color: var(--xhs-red);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 500;
    }
    .color-btn {
      width: 22px; height: 22px; border-radius: 50%;
      cursor: pointer; transition: all 0.15s ease;
      border: 2px solid transparent; flex-shrink: 0;
    }
    .color-btn:hover { transform: scale(1.1); }
    .color-btn.active {
      border-color: var(--xhs-red);
      box-shadow: 0 0 0 2px white, 0 0 0 4px var(--xhs-red);
    }
    .color-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(22px, 1fr));
      gap: 4px; max-height: 160px; overflow-y: auto; padding: 4px;
      scrollbar-width: thin;
    }
    .color-grid::-webkit-scrollbar { width: 4px; }
    .color-grid::-webkit-scrollbar-thumb { background: #DDD; border-radius: 2px; }
    .color-grid::-webkit-scrollbar-track { background: transparent; }
    .font-option {
      padding: 8px 10px;
      border: 1.5px solid #EEE;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: center;
      background: #FAFAFA;
    }
    .font-option:hover {
      border-color: var(--xhs-red-light);
      background: rgba(255, 36, 66, 0.03);
    }
    .font-option.active {
      border-color: var(--xhs-red);
      background: rgba(255, 36, 66, 0.06);
    }
    .dark .font-option {
      background: #252525;
      border-color: #444;
    }
    .font-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px; max-height: 280px; overflow-y: auto; padding: 4px;
      scrollbar-width: thin;
    }
    .font-grid::-webkit-scrollbar { width: 4px; }
    .font-grid::-webkit-scrollbar-thumb { background: #DDD; border-radius: 2px; }
    .font-grid::-webkit-scrollbar-track { background: transparent; }
    .section-toggle { cursor: pointer; user-select: none; }
    .section-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .section-content.open { max-height: 600px; }
    /* å°çº¢ä¹¦é£æ ¼å¼€å…³ */
    .toggle-switch {
      position: relative; width: 44px; height: 24px;
      background: #E5E5E5; border-radius: 12px;
      cursor: pointer; transition: all 0.2s ease;
    }
    .toggle-switch.active { background: var(--xhs-red); }
    .toggle-switch::after {
      content: ''; position: absolute;
      width: 20px; height: 20px;
      background: white; border-radius: 50%;
      top: 2px; left: 2px;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }
    .toggle-switch.active::after { left: 22px; }
    /* å°çº¢ä¹¦é£æ ¼æ ‡ç­¾é¡µ */
    .tab-btn {
      flex: 1; padding: 8px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
      text-align: center;
    }
    .tab-btn.active {
      background: var(--xhs-red);
      color: white;
    }
    .tab-btn:not(.active) {
      background: #F5F5F5;
      color: #666;
    }
    .dark .tab-btn:not(.active) { background: #333; color: #999; }
    /* å¤šé¡µé¢„è§ˆæ ·å¼ */
    .multi-preview-btn {
      background: var(--xhs-red);
      color: white;
      border-radius: 20px;
      transition: all 0.2s ease;
    }
    .multi-preview-btn:hover {
      background: var(--xhs-red-dark);
      box-shadow: 0 4px 12px rgba(255, 36, 66, 0.3);
    }
    .multi-preview-btn.active {
      background: #10B981;
    }
    .multi-preview-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      width: 100%;
    }
    .multi-preview-item {
      position: relative;
      aspect-ratio: 3/4;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .multi-preview-item:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }
    .multi-preview-item.active {
      border-color: var(--xhs-red);
    }
    .multi-preview-item canvas {
      width: 100%;
      height: 100%;
    }
    .multi-preview-label {
      position: absolute;
      top: 4px;
      left: 4px;
      background: var(--xhs-red);
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      z-index: 5;
    }
    .multi-preview-item.empty .multi-preview-label {
      background: #999;
    }
    .multi-preview-item.empty {
      opacity: 0.5;
      cursor: default;
    }
    .multi-preview-item.empty:hover {
      transform: none;
    }
    .sub-section {
      background: #F8F8F8;
      border-radius: 10px;
      padding: 12px;
      margin-top: 12px;
    }
    .dark .sub-section { background: #252525; }
    /* ç¼–è¾‘æ¨¡å¼æ ·å¼ */
    .edit-mode-btn {
      background: #333;
      color: white;
      border-radius: 20px;
      transition: all 0.2s ease;
    }
    .edit-mode-btn:hover {
      background: #444;
    }
    .edit-mode-btn.active {
      background: var(--xhs-red);
    }
    .edit-canvas-wrapper {
      position: relative;
      cursor: default;
    }
    .edit-canvas-wrapper.edit-mode {
      cursor: crosshair;
    }
    .draggable-element {
      position: absolute;
      cursor: move;
      border: 2px dashed transparent;
      padding: 4px;
      transition: border-color 0.2s;
    }
    .draggable-element:hover,
    .draggable-element.selected {
      border-color: #ff2442;
    }
    .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #ff2442;
      border-radius: 50%;
      display: none;
    }
    .draggable-element.selected .resize-handle {
      display: block;
    }
    .edit-panel {
      background: #f9fafb;
      border-radius: 10px;
      padding: 12px;
      margin-top: 12px;
    }
    .dark .edit-panel { background: #1f2937; }
    .decoration-item {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #e5e5e5;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
    }
    .decoration-item:hover {
      border-color: #ff2442;
      background: rgba(255, 36, 66, 0.1);
    }
    .dark .decoration-item { border-color: #374151; }
    .dark .decoration-item:hover { background: rgba(255, 36, 66, 0.2); }
  </style>
</head>
<body class="min-h-screen">
  <!-- ğŸ” ç™»å½•ä¿æŠ¤å±‚ -->
  <div id="loginOverlay" class="fixed inset-0 z-[100] flex items-center justify-center" style="background: var(--xhs-bg);">
    <div class="xhs-card p-8 w-full max-w-sm mx-4 shadow-2xl animate-fade-in-up">
      <div class="text-center mb-6">
        <div class="w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center" style="background: var(--xhs-red);">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M2 17L12 22L22 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M2 12L12 17L22 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </div>
        <h2 class="text-xl font-bold mb-1" style="color: var(--xhs-text);">å°çº¢ä¹¦å›¾æ–‡å°é¢</h2>
        <p class="text-sm" style="color: var(--xhs-text-secondary);">è¯·è¾“å…¥è®¿é—®å¯†ç </p>
      </div>

      <div class="space-y-4">
        <div class="relative">
          <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " class="w-full px-4 py-3 rounded-xl border-2 text-base outline-none transition-all" style="border-color: var(--xhs-border); background: var(--xhs-card); color: var(--xhs-text);" onkeydown="if(event.key==='Enter') checkPassword()" onfocus="this.style.borderColor='var(--xhs-red)'" onblur="this.style.borderColor='var(--xhs-border)'">
          <i class="fas fa-lock absolute right-4 top-1/2 -translate-y-1/2" style="color: var(--xhs-text-secondary);"></i>
        </div>

        <p id="loginError" class="text-sm text-red-500 hidden text-center">
          <i class="fas fa-exclamation-circle mr-1"></i>å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•
        </p>

        <button onclick="checkPassword()" class="w-full py-3 rounded-xl font-semibold text-white transition-all hover:opacity-90 active:scale-[0.98]" style="background: var(--xhs-red);">
          <i class="fas fa-unlock-alt mr-2"></i>è¿›å…¥åº”ç”¨
        </button>
      </div>

      <p class="text-xs text-center mt-6" style="color: var(--xhs-text-secondary);">
        <i class="fas fa-shield-alt mr-1"></i>ä»…é™æˆæƒç”¨æˆ·è®¿é—®
      </p>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p class="text-white mt-4" id="loadingText">æ­£åœ¨è§£ææ–‡ä»¶...</p>
  </div>

  <div id="app" class="container mx-auto px-3 py-4 max-w-7xl hidden">
    <!-- å°çº¢ä¹¦é£æ ¼ Header -->
    <header class="mb-6 animate-fade-in-up text-center">
      <div class="flex flex-col items-center justify-center">
        <div class="xhs-logo">
          <div class="xhs-logo-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M2 17L12 22L22 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M2 12L12 17L22 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </div>
          <div class="text-left">
            <h1 class="xhs-logo-text">å°çº¢ä¹¦å›¾æ–‡<span>å°é¢</span></h1>
            <p class="text-xs text-gray-400 -mt-1">ä¸€é”®ç”Ÿæˆçˆ†æ¬¾å°é¢</p>
          </div>
        </div>
        <!-- è§’è‰²æŒ‡ç¤ºå™¨ -->
        <div class="absolute left-4 top-4 flex items-center gap-2">
          <div id="roleIndicator" class="hidden flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium" style="background: var(--xhs-card); border: 1px solid var(--xhs-border);">
            <i class="fas fa-user"></i>
            <span>ç”¨æˆ·</span>
          </div>
          <!-- ç®¡ç†å‘˜è®¾ç½®æŒ‰é’® -->
          <button id="adminSettingsBtn" onclick="openAdminPanel()" class="hidden w-8 h-8 rounded-full flex items-center justify-center text-white transition-all hover:opacity-80" style="background: var(--xhs-red);" title="è§’è‰²ç®¡ç†">
            <i class="fas fa-users-cog text-xs"></i>
          </button>
          <!-- æ•°æ®ç®¡ç†æŒ‰é’® -->
          <button id="dataManageBtn" onclick="openDataManager()" class="hidden w-8 h-8 rounded-full flex items-center justify-center text-white transition-all hover:opacity-80" style="background: #8B5CF6;" title="æ•°æ®ç®¡ç†">
            <i class="fas fa-database text-xs"></i>
          </button>
        </div>
        <button onclick="toggleDarkMode()" class="absolute right-4 top-4 w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
          <i class="fas fa-moon dark:hidden"></i>
          <i class="fas fa-sun hidden dark:block"></i>
        </button>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Left Panel -->
      <div class="space-y-3">
        <!-- Title/Content Mode Toggle -->
        <div class="xhs-card p-4 animate-fade-in-up">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-sm font-semibold flex items-center gap-2" style="color: var(--xhs-text);">
              <i class="fas fa-layer-group" style="color: var(--xhs-red);"></i> å†…å®¹æ¨¡å¼
            </h2>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-500">æ ‡é¢˜+æ­£æ–‡åˆ†ç¦»</span>
              <div id="splitModeToggle" class="toggle-switch" onclick="toggleSplitMode()"></div>
            </div>
          </div>

          <!-- Simple Mode (No Split) -->
          <div id="simpleModeContent">
            <textarea id="textInput" class="w-full h-32 p-3 border border-gray-200 dark:border-gray-600 rounded-lg resize-none focus:ring-2 focus:ring-red-400 focus:border-transparent bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-sm" style="font-size: 16px;" placeholder="åœ¨è¿™é‡Œè¾“å…¥æˆ–ç²˜è´´æ–‡å­—å†…å®¹..."></textarea>
          </div>

          <!-- Split Mode (Title + Content) -->
          <div id="splitModeContent" class="hidden">
            <div class="mb-3">
              <label class="block text-xs font-medium mb-1" style="color: var(--xhs-text-light);">æ ‡é¢˜</label>
              <input type="text" id="titleInput" class="w-full p-3 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent bg-white dark:bg-gray-800 text-gray-800 dark:text-white font-semibold" style="font-size: 16px;" placeholder="è¾“å…¥æ ‡é¢˜...">
            </div>
            <div>
              <label class="block text-xs font-medium mb-1" style="color: var(--xhs-text-light);">æ­£æ–‡</label>
              <textarea id="contentInput" class="w-full h-24 p-3 border border-gray-200 dark:border-gray-600 rounded-lg resize-none focus:ring-2 focus:ring-red-400 focus:border-transparent bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-sm" style="font-size: 16px;" placeholder="è¾“å…¥æ­£æ–‡å†…å®¹..."></textarea>
            </div>
          </div>

          <!-- File Upload -->
          <div id="dropZone" class="input-file-zone p-3 mt-3 text-center cursor-pointer">
            <input type="file" id="fileInput" accept=".txt,.md,.pdf,.doc,.docx,.wps" class="hidden">
            <div class="flex items-center justify-center gap-2">
              <i class="fas fa-cloud-upload-alt" style="color: var(--xhs-red);"></i>
              <span class="text-gray-500 text-xs">ä¸Šä¼ æ–‡æ¡£</span>
              <div class="flex gap-1">
                <span class="file-badge">TXT</span>
                <span class="file-badge">PDF</span>
                <span class="file-badge">DOCX</span>
              </div>
            </div>
          </div>

          <div class="flex justify-between items-center mt-2 text-xs text-gray-500">
            <span id="charCount">å·²è¾“å…¥ 0 å­—</span>
            <span id="pageCount">é¢„è®¡ 1 å¼ å›¾</span>
          </div>
        </div>

        <!-- Template Selection -->
        <div class="xhs-card p-4 animate-fade-in-up">
          <h2 class="text-sm font-semibold mb-3 flex items-center gap-2" style="color: var(--xhs-text);">
            <i class="fas fa-palette" style="color: var(--xhs-red);"></i> å°é¢æ¨¡æ¿
          </h2>
          <div class="template-grid" id="templateGrid"></div>
          <div class="flex items-center justify-between mt-2 gap-2">
            <p class="text-xs text-gray-400 flex-shrink-0">æ”¯æŒ JPG/PNG/PSD</p>
            <div class="flex items-center gap-2">
              <button onclick="exportTemplates()" id="exportBtn" class="hidden text-xs px-2 py-1 rounded-full transition-colors flex items-center gap-1" style="background: var(--xhs-red); color: white;">
                <i class="fas fa-download text-[10px]"></i> å¯¼å‡º
              </button>
              <button onclick="triggerImportTemplates()" id="importBtn" class="text-xs px-2 py-1 rounded-full transition-colors flex items-center gap-1 border" style="border-color: var(--xhs-border); color: var(--xhs-text-secondary);">
                <i class="fas fa-upload text-[10px]"></i> å¯¼å…¥
              </button>
            </div>
          </div>
        </div>

        <!-- Style Settings -->
        <div class="xhs-card p-4 animate-fade-in-up">
          <div class="section-toggle flex justify-between items-center" onclick="toggleSection('styleSection')">
            <h2 class="text-sm font-semibold flex items-center gap-2" style="color: var(--xhs-text);">
              <i class="fas fa-sliders-h" style="color: var(--xhs-red);"></i> æ ·å¼è®¾ç½®
            </h2>
            <i class="fas fa-chevron-down text-gray-400 transition-transform text-xs" id="styleSectionIcon"></i>
          </div>

          <div class="section-content open mt-3" id="styleSection">
            <!-- Tab for Title/Content styles when split mode -->
            <div id="styleTabs" class="hidden mb-3">
              <div class="flex gap-2 bg-gray-100 dark:bg-gray-800 p-1 rounded-full">
                <button class="tab-btn active" onclick="switchStyleTab('title')">æ ‡é¢˜æ ·å¼</button>
                <button class="tab-btn" onclick="switchStyleTab('content')">æ­£æ–‡æ ·å¼</button>
              </div>
            </div>

            <!-- Title Style Settings -->
            <div id="titleStyleSection" class="hidden sub-section">
              <div class="space-y-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">æ ‡é¢˜å­—ä½“</label>
                  <select id="titleFontFamily" class="w-full p-2 text-sm border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                  </select>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">å­—å·: <span id="titleFontSizeVal">32</span>px</label>
                  <input type="range" id="titleFontSize" min="24" max="56" value="32" class="w-full slider-custom appearance-none bg-transparent">
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">æ ‡é¢˜é¢œè‰²</label>
                  <div class="flex gap-2 items-center mb-2">
                    <input type="color" id="titleColor" value="#333333" class="w-8 h-8 rounded cursor-pointer border border-gray-200">
                    <span class="text-xs text-gray-400">è‡ªå®šä¹‰</span>
                  </div>
                  <div class="color-grid" id="titleColorGrid"></div>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">å¯¹é½æ–¹å¼</label>
                  <div class="flex gap-2">
                    <button onclick="setTitleAlignment('left')" id="titleAlignLeft" class="flex-1 p-2 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 text-xs">
                      <i class="fas fa-align-left"></i>
                    </button>
                    <button onclick="setTitleAlignment('center')" id="titleAlignCenter" class="flex-1 p-2 rounded-lg border-2 border-pink-500 bg-pink-50 dark:bg-pink-900/30 text-pink-600 text-xs">
                      <i class="fas fa-align-center"></i>
                    </button>
                    <button onclick="setTitleAlignment('right')" id="titleAlignRight" class="flex-1 p-2 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 text-xs">
                      <i class="fas fa-align-right"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Content/Unified Style Settings -->
            <div id="contentStyleSection" class="sub-section">
              <div class="space-y-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1" id="fontLabel">å­—ä½“é£æ ¼</label>
                  <select id="fontFamily" class="w-full p-2 text-sm border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                  </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">å­—å·: <span id="fontSizeValue">20</span>px</label>
                    <input type="range" id="fontSize" min="14" max="36" value="20" class="w-full slider-custom appearance-none bg-transparent">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">è¡Œè·: <span id="lineHeightValue">1.8</span></label>
                    <input type="range" id="lineHeight" min="1.4" max="2.5" step="0.1" value="1.8" class="w-full slider-custom appearance-none bg-transparent">
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">æ–‡å­—é¢œè‰²</label>
                  <div class="flex gap-2 items-center mb-2">
                    <input type="color" id="textColor" value="#333333" class="w-8 h-8 rounded cursor-pointer border border-gray-200">
                    <span class="text-xs text-gray-400">è‡ªå®šä¹‰</span>
                  </div>
                  <div class="color-grid" id="colorGrid"></div>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">å¯¹é½æ–¹å¼</label>
                  <div class="flex gap-2">
                    <button onclick="setAlignment('left')" id="alignLeft" class="flex-1 p-2 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 text-xs">
                      <i class="fas fa-align-left"></i>
                    </button>
                    <button onclick="setAlignment('center')" id="alignCenter" class="flex-1 p-2 rounded-lg border-2 border-pink-500 bg-pink-50 dark:bg-pink-900/30 text-pink-600 text-xs">
                      <i class="fas fa-align-center"></i>
                    </button>
                    <button onclick="setAlignment('right')" id="alignRight" class="flex-1 p-2 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 text-xs">
                      <i class="fas fa-align-right"></i>
                    </button>
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">æ¯é¡µå­—æ•°: <span id="maxCharsValue">500</span></label>
                  <input type="range" id="maxChars" min="200" max="800" step="50" value="500" class="w-full slider-custom appearance-none bg-transparent">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel - Preview -->
      <div class="space-y-3">
        <div class="xhs-card p-4 animate-fade-in-up sticky top-4">
          <div class="flex justify-between items-center mb-3">
            <h2 class="text-sm font-semibold flex items-center gap-2" style="color: var(--xhs-text);">
              <i class="fas fa-eye" style="color: var(--xhs-red);"></i> é¢„è§ˆæ•ˆæœ
            </h2>
            <div class="flex items-center gap-2">
              <button onclick="toggleMultiPreview()" id="multiPreviewBtn" class="multi-preview-btn px-3 py-1.5 text-xs font-medium">
                <i class="fas fa-th-large mr-1"></i> å¤šé¡µ
              </button>
              <button onclick="toggleEditMode()" id="editModeBtn" class="edit-mode-btn px-3 py-1.5 text-xs font-medium">
                <i class="fas fa-edit mr-1"></i> ç¼–è¾‘
              </button>
              <span id="currentPageLabel" class="text-xs text-gray-400">1 / 1</span>
            </div>
          </div>

          <!-- Single Preview Mode -->
          <div id="singlePreviewContainer" class="flex justify-center">
            <div id="canvasWrapper" class="edit-canvas-wrapper preview-card bg-gray-100 dark:bg-gray-700 w-full max-w-[280px]">
              <canvas id="previewCanvas" class="w-full h-full"></canvas>
              <!-- Overlay elements for edit mode -->
              <div id="editOverlay" class="hidden absolute inset-0 pointer-events-none">
                <div id="titleHandle" class="draggable-element hidden pointer-events-auto" data-type="title">
                  <span class="text-xs bg-pink-500 text-white px-1 rounded absolute -top-5 left-0">æ ‡é¢˜</span>
                </div>
                <div id="contentHandle" class="draggable-element hidden pointer-events-auto" data-type="content">
                  <span class="text-xs bg-blue-500 text-white px-1 rounded absolute -top-5 left-0">æ­£æ–‡</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Multi-Page Preview Mode (2x2 Grid) -->
          <div id="multiPreviewContainer" class="hidden">
            <div class="multi-preview-grid">
              <div class="multi-preview-item bg-gray-100 dark:bg-gray-700" id="multiPreview0" onclick="selectMultiPreviewPage(0)" ondblclick="editMultiPreviewPage(0)">
                <span class="multi-preview-label">ç¬¬1é¡µ</span>
                <canvas id="multiCanvas0"></canvas>
              </div>
              <div class="multi-preview-item bg-gray-100 dark:bg-gray-700" id="multiPreview1" onclick="selectMultiPreviewPage(1)" ondblclick="editMultiPreviewPage(1)">
                <span class="multi-preview-label">ç¬¬2é¡µ</span>
                <canvas id="multiCanvas1"></canvas>
              </div>
              <div class="multi-preview-item bg-gray-100 dark:bg-gray-700" id="multiPreview2" onclick="selectMultiPreviewPage(2)" ondblclick="editMultiPreviewPage(2)">
                <span class="multi-preview-label">ç¬¬3é¡µ</span>
                <canvas id="multiCanvas2"></canvas>
              </div>
              <div class="multi-preview-item bg-gray-100 dark:bg-gray-700" id="multiPreview3" onclick="selectMultiPreviewPage(3)" ondblclick="editMultiPreviewPage(3)">
                <span class="multi-preview-label">ç¬¬4é¡µ</span>
                <canvas id="multiCanvas3"></canvas>
              </div>
            </div>
            <div class="mt-3 flex items-center justify-center gap-2">
              <button onclick="prevMultiPage()" id="prevMultiBtn" class="px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 text-xs disabled:opacity-50">
                <i class="fas fa-chevron-left"></i> ä¸Š4é¡µ
              </button>
              <span id="multiPageRange" class="text-xs text-gray-500">1-4 / 4</span>
              <button onclick="nextMultiPage()" id="nextMultiBtn" class="px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 text-xs disabled:opacity-50">
                ä¸‹4é¡µ <i class="fas fa-chevron-right"></i>
              </button>
            </div>
            <p class="text-xs text-gray-400 text-center mt-2"><i class="fas fa-mouse-pointer mr-1"></i>ç‚¹å‡»é€‰æ‹© | åŒå‡»è¿›å…¥ç¼–è¾‘æ¨¡å¼</p>
          </div>

          <!-- Edit Mode Panel -->
          <div id="editModePanel" class="hidden mt-3">
            <!-- Edit Tabs -->
            <div class="flex gap-1 bg-gray-100 dark:bg-gray-700 p-1 rounded-lg mb-3 overflow-x-auto">
              <button class="edit-tab-btn tab-btn active text-xs whitespace-nowrap" onclick="switchEditTab('position')">ä½ç½®</button>
              <button class="edit-tab-btn tab-btn text-xs whitespace-nowrap" onclick="switchEditTab('padding')">è¾¹è·</button>
              <button class="edit-tab-btn tab-btn text-xs whitespace-nowrap" onclick="switchEditTab('text')">æ–‡å­—</button>
              <button class="edit-tab-btn tab-btn text-xs whitespace-nowrap" onclick="switchEditTab('decoration')">è£…é¥°</button>
              <button class="edit-tab-btn tab-btn text-xs whitespace-nowrap" onclick="switchEditTab('watermark')">æ°´å°</button>
            </div>

            <!-- Position Tab -->
            <div id="editTabPosition" class="edit-panel">
              <p class="text-xs text-gray-500 mb-2"><i class="fas fa-info-circle mr-1"></i> ç›´æ¥åœ¨é¢„è§ˆå›¾ä¸Šæ‹–åŠ¨æ–‡å­—è°ƒæ•´ä½ç½®</p>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">æ ‡é¢˜ Y åç§»: <span id="titleYVal">0</span>%</label>
                  <input type="range" id="titleYOffset" min="-30" max="50" value="0" class="w-full slider-custom appearance-none bg-transparent">
                </div>
                <div>
                  <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">æ­£æ–‡ Y åç§»: <span id="contentYVal">0</span>%</label>
                  <input type="range" id="contentYOffset" min="-30" max="50" value="0" class="w-full slider-custom appearance-none bg-transparent">
                </div>
              </div>
              <button onclick="resetPositions()" class="mt-2 w-full py-1 text-xs border border-gray-300 dark:border-gray-600 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                <i class="fas fa-undo mr-1"></i> é‡ç½®ä½ç½®
              </button>
            </div>

            <!-- Padding Tab -->
            <div id="editTabPadding" class="edit-panel hidden">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">ä¸Šè¾¹è·: <span id="paddingTopVal">8</span>%</label>
                  <input type="range" id="paddingTop" min="2" max="25" value="8" class="w-full slider-custom appearance-none bg-transparent">
                </div>
                <div>
                  <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">ä¸‹è¾¹è·: <span id="paddingBottomVal">8</span>%</label>
                  <input type="range" id="paddingBottom" min="2" max="25" value="8" class="w-full slider-custom appearance-none bg-transparent">
                </div>
                <div>
                  <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">å·¦è¾¹è·: <span id="paddingLeftVal">8</span>%</label>
                  <input type="range" id="paddingLeft" min="2" max="20" value="8" class="w-full slider-custom appearance-none bg-transparent">
                </div>
                <div>
                  <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">å³è¾¹è·: <span id="paddingRightVal">8</span>%</label>
                  <input type="range" id="paddingRight" min="2" max="20" value="8" class="w-full slider-custom appearance-none bg-transparent">
                </div>
              </div>
              <button onclick="resetPadding()" class="mt-2 w-full py-1 text-xs border border-gray-300 dark:border-gray-600 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                <i class="fas fa-undo mr-1"></i> é‡ç½®è¾¹è·
              </button>
            </div>

            <!-- Text Edit Tab -->
            <div id="editTabText" class="edit-panel hidden">
              <p class="text-xs text-gray-500 mb-2"><i class="fas fa-info-circle mr-1"></i> ç‚¹å‡»é¢„è§ˆåŒºåŸŸç›´æ¥ç¼–è¾‘æ–‡å­—ï¼Œæˆ–é€‰ä¸­æ–‡å­—åº”ç”¨ç‰¹æ®Šå¤§å°</p>

              <!-- Rich Text Segments -->
              <div class="mb-3">
                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-2">ç‰¹æ®Šæ–‡å­—æ®µè½</label>
                <div id="textSegmentsList" class="space-y-2 max-h-32 overflow-y-auto mb-2">
                  <p class="text-xs text-gray-400 italic">æš‚æ— ç‰¹æ®Šæ–‡å­—æ®µè½</p>
                </div>
                <button onclick="showAddSegmentModal()" class="w-full py-2 text-xs border-2 border-dashed border-pink-300 text-pink-500 rounded-lg hover:bg-pink-50 dark:hover:bg-pink-900/20">
                  <i class="fas fa-plus mr-1"></i> æ·»åŠ ç‰¹æ®Šæ–‡å­—
                </button>
              </div>

              <!-- Quick Size Buttons -->
              <div class="mb-3">
                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-2">å¿«æ·å­—å·</label>
                <div class="grid grid-cols-4 gap-2">
                  <button onclick="addTextSegment('small')" class="py-2 text-xs border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                    <span style="font-size:10px">å°å·</span>
                  </button>
                  <button onclick="addTextSegment('normal')" class="py-2 text-xs border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                    <span>æ­£å¸¸</span>
                  </button>
                  <button onclick="addTextSegment('large')" class="py-2 text-xs border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                    <span style="font-size:14px">å¤§å·</span>
                  </button>
                  <button onclick="addTextSegment('xlarge')" class="py-2 text-xs border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                    <span style="font-size:16px">ç‰¹å¤§</span>
                  </button>
                </div>
              </div>

              <!-- Click to Edit Toggle -->
              <div class="flex items-center justify-between p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <span class="text-xs text-gray-600 dark:text-gray-400">ç‚¹å‡»é¢„è§ˆç›´æ¥ç¼–è¾‘</span>
                <div id="clickEditToggle" class="toggle-switch active" onclick="toggleClickEdit()"></div>
              </div>
            </div>

            <!-- Decoration Tab -->
            <div id="editTabDecoration" class="edit-panel hidden">
              <p class="text-xs text-gray-500 mb-2">ç‚¹å‡»æ·»åŠ è£…é¥°å…ƒç´ </p>
              <div class="grid grid-cols-8 gap-2 mb-3">
                <div class="decoration-item" onclick="addDecoration('line-h')"><i class="fas fa-minus"></i></div>
                <div class="decoration-item" onclick="addDecoration('line-v')"><i class="fas fa-grip-lines-vertical"></i></div>
                <div class="decoration-item" onclick="addDecoration('circle')"><i class="far fa-circle"></i></div>
                <div class="decoration-item" onclick="addDecoration('square')"><i class="far fa-square"></i></div>
                <div class="decoration-item" onclick="addDecoration('star')"><i class="fas fa-star"></i></div>
                <div class="decoration-item" onclick="addDecoration('heart')"><i class="fas fa-heart"></i></div>
                <div class="decoration-item" onclick="addDecoration('dot')"><i class="fas fa-circle" style="font-size:8px"></i></div>
                <div class="decoration-item" onclick="addDecoration('diamond')"><i class="fas fa-diamond"></i></div>
              </div>
              <div class="grid grid-cols-8 gap-2 mb-3">
                <div class="decoration-item" onclick="addDecoration('quote-left')"><i class="fas fa-quote-left"></i></div>
                <div class="decoration-item" onclick="addDecoration('quote-right')"><i class="fas fa-quote-right"></i></div>
                <div class="decoration-item" onclick="addDecoration('leaf')"><i class="fas fa-leaf"></i></div>
                <div class="decoration-item" onclick="addDecoration('flower')"><i class="fas fa-spa"></i></div>
                <div class="decoration-item" onclick="addDecoration('sun')"><i class="fas fa-sun"></i></div>
                <div class="decoration-item" onclick="addDecoration('moon')"><i class="fas fa-moon"></i></div>
                <div class="decoration-item" onclick="addDecoration('cloud')"><i class="fas fa-cloud"></i></div>
                <div class="decoration-item" onclick="addDecoration('bolt')"><i class="fas fa-bolt"></i></div>
              </div>
              <div class="flex gap-2 items-center mb-2">
                <label class="text-xs text-gray-600 dark:text-gray-400">è£…é¥°é¢œè‰²:</label>
                <input type="color" id="decorationColor" value="#ff2442" class="w-6 h-6 rounded cursor-pointer border border-gray-200">
                <label class="text-xs text-gray-600 dark:text-gray-400 ml-2">å¤§å°:</label>
                <input type="range" id="decorationSize" min="10" max="60" value="24" class="w-20 slider-custom appearance-none bg-transparent">
              </div>
              <div class="flex gap-2">
                <button onclick="deleteSelectedDecoration()" class="flex-1 py-1 text-xs border border-red-300 text-red-500 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30">
                  <i class="fas fa-trash mr-1"></i> åˆ é™¤é€‰ä¸­
                </button>
                <button onclick="clearAllDecorations()" class="flex-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                  <i class="fas fa-times mr-1"></i> æ¸…ç©ºå…¨éƒ¨
                </button>
              </div>
            </div>

            <!-- Watermark Tab -->
            <div id="editTabWatermark" class="edit-panel hidden">
              <div class="input-file-zone rounded-lg p-3 text-center cursor-pointer mb-3" onclick="document.getElementById('watermarkInput').click()">
                <input type="file" id="watermarkInput" accept="image/*" class="hidden">
                <i class="fas fa-image text-pink-400 mr-2"></i>
                <span class="text-gray-500 text-xs">ç‚¹å‡»ä¸Šä¼ æ°´å°/Logoå›¾ç‰‡</span>
              </div>
              <div id="watermarkPreview" class="hidden mb-3">
                <div class="flex items-center gap-2 mb-2">
                  <img id="watermarkImg" src="" class="w-12 h-12 object-contain rounded border">
                  <span id="watermarkName" class="text-xs text-gray-600 dark:text-gray-400 flex-1 truncate"></span>
                  <button onclick="removeWatermark()" class="text-red-500 text-xs"><i class="fas fa-times"></i></button>
                </div>
              </div>
              <div id="watermarkControls" class="hidden space-y-2">
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">X ä½ç½®: <span id="watermarkXVal">50</span>%</label>
                    <input type="range" id="watermarkX" min="0" max="100" value="50" class="w-full slider-custom appearance-none bg-transparent">
                  </div>
                  <div>
                    <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Y ä½ç½®: <span id="watermarkYVal">90</span>%</label>
                    <input type="range" id="watermarkY" min="0" max="100" value="90" class="w-full slider-custom appearance-none bg-transparent">
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">å¤§å°: <span id="watermarkSizeVal">15</span>%</label>
                    <input type="range" id="watermarkSize" min="5" max="50" value="15" class="w-full slider-custom appearance-none bg-transparent">
                  </div>
                  <div>
                    <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">é€æ˜åº¦: <span id="watermarkOpacityVal">80</span>%</label>
                    <input type="range" id="watermarkOpacity" min="10" max="100" value="80" class="w-full slider-custom appearance-none bg-transparent">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="page-indicator" id="pageIndicator"></div>

          <div class="flex gap-2 mt-3">
            <button onclick="prevPage()" id="prevBtn" class="flex-1 py-2 rounded-lg border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 text-xs disabled:opacity-50">
              <i class="fas fa-chevron-left"></i> ä¸Šä¸€é¡µ
            </button>
            <button onclick="nextPage()" id="nextBtn" class="flex-1 py-2 rounded-lg border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 text-xs disabled:opacity-50">
              ä¸‹ä¸€é¡µ <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <div class="mt-4 space-y-2">
            <button onclick="downloadCurrent()" data-permission="download" class="w-full btn-primary py-3 font-medium text-sm">
              <i class="fas fa-download mr-2"></i> ä¸‹è½½å½“å‰å›¾ç‰‡
            </button>
            <button onclick="downloadAll()" data-permission="download" class="w-full btn-secondary py-3 font-medium text-sm">
              <i class="fas fa-images mr-2"></i> ä¸‹è½½å…¨éƒ¨
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- å°çº¢ä¹¦é£æ ¼é¡µè„š -->
    <footer class="mt-8 pb-4 text-center">
      <div class="flex items-center justify-center gap-2 mb-2">
        <div class="w-6 h-6 rounded flex items-center justify-center" style="background: var(--xhs-red);">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M2 12L12 17L22 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </div>
        <span class="text-xs font-medium" style="color: var(--xhs-text-secondary);">å°çº¢ä¹¦å›¾æ–‡å°é¢ç”Ÿæˆå™¨</span>
      </div>
      <p class="text-xs" style="color: var(--xhs-text-secondary);">ä¸€é”®ç”Ÿæˆï¿½ï¿½ï¿½çº¢ä¹¦çˆ†æ¬¾å°é¢</p>
      <div class="mt-3 flex items-center justify-center gap-4">
        <a href="#" class="text-xs hover:underline" style="color: var(--xhs-text-secondary);">ä½¿ç”¨å¸®åŠ©</a>
        <span style="color: var(--xhs-text-secondary);">Â·</span>
        <a href="#" class="text-xs hover:underline" style="color: var(--xhs-text-secondary);">åé¦ˆå»ºè®®</a>
      </div>
    </footer>
  </div>

  <!-- ğŸ” ç®¡ç†å‘˜è§’è‰²ç®¡ç†é¢æ¿ -->
  <div id="adminPanelOverlay" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="xhs-card p-5 w-full max-w-lg max-h-[85vh] overflow-y-auto shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-base font-semibold" style="color: var(--xhs-text);">
          <i class="fas fa-users-cog mr-2" style="color: var(--xhs-red);"></i>
          è§’è‰²ç®¡ç†
        </h3>
        <button onclick="closeAdminPanel()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- æ·»åŠ æ–°è§’è‰²æŒ‰é’® -->
      <button onclick="showAddRoleForm()" id="addRoleBtn" class="w-full py-3 rounded-xl border-2 border-dashed flex items-center justify-center gap-2 text-sm font-medium transition-colors hover:bg-gray-50 dark:hover:bg-gray-800" style="border-color: var(--xhs-border); color: var(--xhs-text-secondary);">
        <i class="fas fa-plus-circle" style="color: var(--xhs-red);"></i>
        æ·»åŠ æ–°è§’è‰²
      </button>

      <!-- æ·»åŠ è§’è‰²è¡¨å•ï¼ˆé»˜è®¤éšè—ï¼‰ -->
      <div id="addRoleForm" class="hidden p-4 rounded-xl border-2 mt-3" style="border-color: var(--xhs-red); background: var(--xhs-card);">
        <h4 class="font-semibold text-sm mb-3 flex items-center gap-2" style="color: var(--xhs-text);">
          <i class="fas fa-user-plus" style="color: var(--xhs-red);"></i>
          åˆ›å»ºæ–°è§’è‰²
        </h4>
        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium mb-1" style="color: var(--xhs-text-secondary);">è§’è‰²IDï¼ˆè‹±æ–‡ï¼‰</label>
              <input type="text" id="newRoleId" placeholder="å¦‚: vip" class="w-full px-3 py-2 text-sm rounded-lg border" style="border-color: var(--xhs-border); background: var(--xhs-bg-solid); color: var(--xhs-text);">
            </div>
            <div>
              <label class="block text-xs font-medium mb-1" style="color: var(--xhs-text-secondary);">è§’è‰²åç§°</label>
              <input type="text" id="newRoleName" placeholder="å¦‚: VIPç”¨æˆ·" class="w-full px-3 py-2 text-sm rounded-lg border" style="border-color: var(--xhs-border); background: var(--xhs-bg-solid); color: var(--xhs-text);">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium mb-1" style="color: var(--xhs-text-secondary);">ç™»å½•å¯†ç </label>
              <input type="text" id="newRolePassword" placeholder="è®¾ç½®å¯†ç " class="w-full px-3 py-2 text-sm rounded-lg border" style="border-color: var(--xhs-border); background: var(--xhs-bg-solid); color: var(--xhs-text);">
            </div>
            <div>
              <label class="block text-xs font-medium mb-1" style="color: var(--xhs-text-secondary);">æ ‡è¯†é¢œè‰²</label>
              <input type="color" id="newRoleColor" value="#8B5CF6" class="w-full h-9 rounded-lg cursor-pointer border" style="border-color: var(--xhs-border);">
            </div>
          </div>
          <div>
            <label class="block text-xs font-medium mb-1" style="color: var(--xhs-text-secondary);">
              <i class="fas fa-calendar-alt mr-1"></i> è´¦å·åˆ°æœŸæ—¶é—´ï¼ˆç•™ç©ºä¸ºæ°¸ä¸è¿‡æœŸï¼‰
            </label>
            <input type="date" id="newRoleExpiry" class="w-full px-3 py-2 text-sm rounded-lg border" style="border-color: var(--xhs-border); background: var(--xhs-bg-solid); color: var(--xhs-text);">
          </div>
          <div>
            <label class="block text-xs font-medium mb-2" style="color: var(--xhs-text-secondary);">æƒé™è®¾ç½®</label>
            <div class="grid grid-cols-2 gap-2">
              <label class="flex items-center gap-2 text-xs">
                <input type="checkbox" id="newPerm_generate" checked="" class="w-4 h-4 rounded">
                <span style="color: var(--xhs-text);">ç”Ÿæˆå°é¢</span>
              </label>
              <label class="flex items-center gap-2 text-xs">
                <input type="checkbox" id="newPerm_download" checked="" class="w-4 h-4 rounded">
                <span style="color: var(--xhs-text);">ä¸‹è½½å°é¢</span>
              </label>
              <label class="flex items-center gap-2 text-xs">
                <input type="checkbox" id="newPerm_uploadTemplate" class="w-4 h-4 rounded">
                <span style="color: var(--xhs-text);">ä¸Šä¼ æ¨¡ç‰ˆ</span>
              </label>
              <label class="flex items-center gap-2 text-xs">
                <input type="checkbox" id="newPerm_exportImport" class="w-4 h-4 rounded">
                <span style="color: var(--xhs-text);">å¯¼å‡º/å¯¼å…¥</span>
              </label>
              <label class="flex items-center gap-2 text-xs">
                <input type="checkbox" id="newPerm_styleSettings" checked="" class="w-4 h-4 rounded">
                <span style="color: var(--xhs-text);">æ ·å¼è®¾ç½®</span>
              </label>
              <label class="flex items-center gap-2 text-xs">
                <input type="checkbox" id="newPerm_advancedEdit" checked="" class="w-4 h-4 rounded">
                <span style="color: var(--xhs-text);">é«˜çº§ç¼–è¾‘</span>
              </label>
              <label class="flex items-center gap-2 text-xs">
                <input type="checkbox" id="newPerm_deleteTemplate" class="w-4 h-4 rounded">
                <span style="color: var(--xhs-text);">åˆ é™¤æ¨¡ç‰ˆ</span>
              </label>
            </div>
          </div>
          <div class="flex gap-2 pt-2">
            <button onclick="hideAddRoleForm()" class="flex-1 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 text-sm">å–æ¶ˆ</button>
            <button onclick="createNewRole()" class="flex-1 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--xhs-red);">
              <i class="fas fa-check mr-1"></i> åˆ›å»ºè§’è‰²
            </button>
          </div>
        </div>
      </div>

      <!-- è§’è‰²åˆ—è¡¨ -->
      <div id="rolesList" class="space-y-3 mt-3">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>

      <!-- æ“ä½œæç¤º -->
      <div class="mt-4 p-3 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800">
        <p class="text-xs text-yellow-700 dark:text-yellow-400">
          <i class="fas fa-info-circle mr-1"></i>
          æ³¨æ„ï¼šä¿®æ”¹å°†ç«‹å³ç”Ÿæ•ˆï¼Œä½†åˆ·æ–°é¡µé¢åä¼šæ¢å¤é»˜è®¤è®¾ç½®ã€‚å¦‚éœ€æ°¸ä¹…ä¿®æ”¹ï¼Œè¯·è”ç³»å¼€å‘è€…æ›´æ–°ä»£ç ã€‚
        </p>
      </div>

      <!-- ä½¿ç”¨ç»Ÿè®¡ -->
      <div class="mt-4 p-3 rounded-lg" style="background: linear-gradient(135deg, #8B5CF620, #EC489920); border: 1px solid var(--xhs-border);">
        <div class="flex items-center justify-between mb-2">
          <p class="text-xs font-medium flex items-center gap-2" style="color: var(--xhs-text);">
            <i class="fas fa-chart-bar" style="color: var(--xhs-red);"></i>
            ä½¿ç”¨ç»Ÿè®¡
          </p>
          <button onclick="showUsageDetails()" class="text-[10px] px-2 py-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" style="color: var(--xhs-red);">
            æŸ¥çœ‹è¯¦æƒ… <i class="fas fa-chevron-right ml-1"></i>
          </button>
        </div>
        <div id="usageStatsContent" class="space-y-2">
          <!-- åŠ¨æ€ç”Ÿæˆä½¿ç”¨ç»Ÿè®¡ -->
        </div>
      </div>

      <!-- åœ¨çº¿çŠ¶æ€ -->
      <div class="mt-4 p-3 rounded-lg" style="background: linear-gradient(135deg, #10B98120, #3B82F620); border: 1px solid var(--xhs-border);">
        <p class="text-xs font-medium mb-2 flex items-center gap-2" style="color: var(--xhs-text);">
          <span class="relative flex h-2 w-2">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
          </span>
          åœ¨çº¿çŠ¶æ€
        </p>
        <div id="onlineStatusContent" class="space-y-2">
          <!-- åŠ¨æ€ç”Ÿæˆåœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
        </div>
        <p class="text-[10px] mt-2" style="color: var(--xhs-text-secondary);">
          <i class="fas fa-info-circle mr-1"></i> æ˜¾ç¤ºå½“å‰æ´»è·ƒçš„ç™»å½•ä¼šè¯
        </p>
      </div>

      <!-- å¯¼å‡º/å¯¼å…¥è§’è‰²é…ç½® -->
      <div class="mt-4 p-3 rounded-lg" style="background: var(--xhs-bg-solid); border: 1px solid var(--xhs-border);">
        <p class="text-xs font-medium mb-2" style="color: var(--xhs-text);">
          <i class="fas fa-save mr-1" style="color: var(--xhs-red);"></i> æ°¸ä¹…ä¿å­˜é…ç½®
        </p>
        <div class="flex gap-2">
          <button onclick="exportRolesConfig()" class="flex-1 py-2 rounded-lg text-xs font-medium text-white transition-colors" style="background: var(--xhs-red);">
            <i class="fas fa-download mr-1"></i> å¯¼å‡ºé…ç½®
          </button>
          <button onclick="triggerImportRolesConfig()" class="flex-1 py-2 rounded-lg text-xs font-medium border transition-colors" style="border-color: var(--xhs-border); color: var(--xhs-text);">
            <i class="fas fa-upload mr-1"></i> å¯¼å…¥é…ç½®
          </button>
        </div>
        <p class="text-[10px] mt-2" style="color: var(--xhs-text-secondary);">
          å¯¼å‡ºåä¿å­˜JSONæ–‡ä»¶ï¼Œä¸‹æ¬¡ä½¿ç”¨æ—¶å¯¼å…¥å³å¯æ¢å¤æ‰€æœ‰è§’è‰²è®¾ç½®
        </p>
      </div>

      <div class="mt-4 flex gap-2">
        <button onclick="closeAdminPanel()" class="flex-1 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 text-sm">å…³é—­</button>
        <button onclick="resetRoles()" class="flex-1 py-2 rounded-lg bg-gray-500 text-white text-sm font-semibold hover:bg-gray-600">
          <i class="fas fa-undo mr-1"></i> æ¢å¤é»˜è®¤
        </button>
      </div>
    </div>
  </div>

  <!-- ä½¿ç”¨è¯¦æƒ…å¼¹çª— -->
  <div id="usageDetailsOverlay" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="xhs-card p-5 w-full max-w-lg max-h-[85vh] overflow-y-auto shadow-2xl rounded-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-base font-semibold" style="color: var(--xhs-text);">
          <i class="fas fa-chart-line mr-2" style="color: var(--xhs-red);"></i>
          ä½¿ç”¨ç»Ÿè®¡è¯¦æƒ…
        </h3>
        <button onclick="closeUsageDetails()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- è§’è‰²é€‰æ‹© -->
      <div class="mb-4">
        <label class="block text-xs font-medium mb-2" style="color: var(--xhs-text-secondary);">é€‰æ‹©è§’è‰²æŸ¥çœ‹è¯¦æƒ…ï¼š</label>
        <select id="usageRoleSelect" onchange="updateUsageDetailsView()" class="w-full px-3 py-2 text-sm rounded-lg border" style="border-color: var(--xhs-border); background: var(--xhs-bg-solid); color: var(--xhs-text);">
          <option value="all">å…¨éƒ¨è§’è‰²</option>
        </select>
      </div>

      <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
      <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="p-3 rounded-xl text-center" style="background: linear-gradient(135deg, #FF244220, #FF244210);">
          <div class="text-2xl font-bold" style="color: var(--xhs-red);" id="totalDownloadsDisplay">0</div>
          <div class="text-xs" style="color: var(--xhs-text-secondary);">æ€»ä¸‹è½½é‡</div>
        </div>
        <div class="p-3 rounded-xl text-center" style="background: linear-gradient(135deg, #3B82F620, #3B82F610);">
          <div class="text-2xl font-bold" style="color: #3B82F6;" id="todayDownloadsDisplay">0</div>
          <div class="text-xs" style="color: var(--xhs-text-secondary);">ä»Šæ—¥ä¸‹è½½</div>
        </div>
      </div>

      <!-- æ¯æ—¥è¯¦æƒ…è¡¨æ ¼ -->
      <div class="border rounded-xl overflow-hidden" style="border-color: var(--xhs-border);">
        <div class="px-3 py-2 text-xs font-medium" style="background: var(--xhs-bg-solid); color: var(--xhs-text);">
          <i class="fas fa-calendar-day mr-1"></i> æ¯æ—¥ä¸‹è½½è®°å½•
        </div>
        <div id="usageDetailsTable" class="max-h-64 overflow-y-auto">
          <!-- åŠ¨æ€ç”Ÿæˆè¡¨æ ¼å†…å®¹ -->
        </div>
      </div>

      <!-- å¯¼å‡ºç»Ÿè®¡æŒ‰é’® -->
      <div class="mt-4 flex gap-2">
        <button onclick="exportUsageStats()" class="flex-1 py-2 rounded-lg text-xs font-medium text-white transition-colors" style="background: var(--xhs-red);">
          <i class="fas fa-download mr-1"></i> å¯¼å‡ºç»Ÿè®¡æ•°æ®
        </button>
        <button onclick="clearUsageStats()" class="flex-1 py-2 rounded-lg text-xs font-medium border transition-colors hover:bg-red-50 dark:hover:bg-red-900/20" style="border-color: #EF4444; color: #EF4444;">
          <i class="fas fa-trash-alt mr-1"></i> æ¸…ç©ºç»Ÿè®¡
        </button>
      </div>
    </div>
  </div>

  <!-- æ•°æ®ç®¡ç†å¼¹çª— -->
  <div id="dataManagerOverlay" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="xhs-card p-5 w-full max-w-md max-h-[85vh] overflow-y-auto shadow-2xl rounded-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-base font-semibold" style="color: var(--xhs-text);">
          <i class="fas fa-database mr-2" style="color: #8B5CF6;"></i>
          æ•°æ®ç®¡ç†ä¸­å¿ƒ
        </h3>
        <button onclick="closeDataManager()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- æ•°æ®æ¦‚è§ˆ -->
      <div class="p-4 rounded-xl mb-4" style="background: linear-gradient(135deg, #8B5CF620, #EC489920); border: 1px solid var(--xhs-border);">
        <h4 class="text-xs font-semibold mb-3 flex items-center gap-2" style="color: var(--xhs-text);">
          <i class="fas fa-chart-pie" style="color: #8B5CF6;"></i> æ•°æ®æ¦‚è§ˆ
        </h4>
        <div class="grid grid-cols-3 gap-2 text-center">
          <div class="p-2 rounded-lg" style="background: var(--xhs-card);">
            <div class="text-lg font-bold" style="color: var(--xhs-red);" id="dataRolesCount">0</div>
            <div class="text-[10px]" style="color: var(--xhs-text-secondary);">è§’è‰²é…ç½®</div>
          </div>
          <div class="p-2 rounded-lg" style="background: var(--xhs-card);">
            <div class="text-lg font-bold" style="color: #3B82F6;" id="dataTemplatesCount">0</div>
            <div class="text-[10px]" style="color: var(--xhs-text-secondary);">è‡ªå®šä¹‰æ¨¡ç‰ˆ</div>
          </div>
          <div class="p-2 rounded-lg" style="background: var(--xhs-card);">
            <div class="text-lg font-bold" style="color: #10B981;" id="dataStatsCount">0</div>
            <div class="text-[10px]" style="color: var(--xhs-text-secondary);">ç»Ÿè®¡è®°å½•</div>
          </div>
        </div>
      </div>

      <!-- ä¸€é”®å¤‡ä»½ -->
      <div class="p-4 rounded-xl mb-3" style="background: var(--xhs-card); border: 1px solid var(--xhs-border);">
        <h4 class="text-xs font-semibold mb-2 flex items-center gap-2" style="color: var(--xhs-text);">
          <i class="fas fa-cloud-download-alt" style="color: #10B981;"></i> ä¸€é”®å¤‡ä»½
        </h4>
        <p class="text-[11px] mb-3" style="color: var(--xhs-text-secondary);">
          å¯¼å‡ºæ‰€æœ‰æ•°æ®ï¼ˆè§’è‰²é…ç½®ã€è‡ªå®šä¹‰æ¨¡ç‰ˆã€ä½¿ç”¨ç»Ÿè®¡ï¼‰åˆ°ä¸€ä¸ªæ–‡ä»¶
        </p>
        <button onclick="exportAllData()" class="w-full py-3 rounded-xl text-sm font-semibold text-white transition-all hover:opacity-90 flex items-center justify-center gap-2" style="background: linear-gradient(135deg, #10B981, #059669);">
          <i class="fas fa-download"></i> å¯¼å‡ºå®Œæ•´å¤‡ä»½
        </button>
      </div>

      <!-- ä¸€é”®æ¢å¤ -->
      <div class="p-4 rounded-xl mb-3" style="background: var(--xhs-card); border: 1px solid var(--xhs-border);">
        <h4 class="text-xs font-semibold mb-2 flex items-center gap-2" style="color: var(--xhs-text);">
          <i class="fas fa-cloud-upload-alt" style="color: #3B82F6;"></i> ä¸€é”®æ¢å¤
        </h4>
        <p class="text-[11px] mb-3" style="color: var(--xhs-text-secondary);">
          ä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ‰€æœ‰æ•°æ®ï¼Œä¼šè¦†ç›–å½“å‰è®¾ç½®
        </p>
        <button onclick="triggerImportAllData()" class="w-full py-3 rounded-xl text-sm font-semibold text-white transition-all hover:opacity-90 flex items-center justify-center gap-2" style="background: linear-gradient(135deg, #3B82F6, #2563EB);">
          <i class="fas fa-upload"></i> å¯¼å…¥å¤‡ä»½æ–‡ä»¶
        </button>
        <input type="file" id="allDataImportInput" accept=".json" class="hidden">
      </div>

      <!-- åˆ†é¡¹ç®¡ç† -->
      <div class="p-4 rounded-xl" style="background: var(--xhs-card); border: 1px solid var(--xhs-border);">
        <h4 class="text-xs font-semibold mb-3 flex items-center gap-2" style="color: var(--xhs-text);">
          <i class="fas fa-cogs" style="color: #F59E0B;"></i> åˆ†é¡¹ç®¡ç†
        </h4>
        <div class="space-y-2">
          <!-- è§’è‰²é…ç½® -->
          <div class="flex items-center justify-between p-2 rounded-lg" style="background: var(--xhs-bg-solid);">
            <div class="flex items-center gap-2">
              <i class="fas fa-users text-xs" style="color: var(--xhs-red);"></i>
              <span class="text-xs" style="color: var(--xhs-text);">è§’è‰²é…ç½®</span>
            </div>
            <div class="flex gap-1">
              <button onclick="exportRolesConfig()" class="px-2 py-1 rounded text-[10px] font-medium" style="background: var(--xhs-red); color: white;">å¯¼å‡º</button>
              <button onclick="triggerImportRolesConfig()" class="px-2 py-1 rounded text-[10px] font-medium border" style="border-color: var(--xhs-border); color: var(--xhs-text);">å¯¼å…¥</button>
            </div>
          </div>
          <!-- è‡ªå®šä¹‰æ¨¡ç‰ˆ -->
          <div class="flex items-center justify-between p-2 rounded-lg" style="background: var(--xhs-bg-solid);">
            <div class="flex items-center gap-2">
              <i class="fas fa-images text-xs" style="color: #3B82F6;"></i>
              <span class="text-xs" style="color: var(--xhs-text);">è‡ªå®šä¹‰æ¨¡ç‰ˆ</span>
            </div>
            <div class="flex gap-1">
              <button onclick="exportTemplates()" class="px-2 py-1 rounded text-[10px] font-medium" style="background: #3B82F6; color: white;">å¯¼å‡º</button>
              <button onclick="document.getElementById('templateImportInput').click()" class="px-2 py-1 rounded text-[10px] font-medium border" style="border-color: var(--xhs-border); color: var(--xhs-text);">å¯¼å…¥</button>
            </div>
          </div>
          <!-- ä½¿ç”¨ç»Ÿè®¡ -->
          <div class="flex items-center justify-between p-2 rounded-lg" style="background: var(--xhs-bg-solid);">
            <div class="flex items-center gap-2">
              <i class="fas fa-chart-bar text-xs" style="color: #10B981;"></i>
              <span class="text-xs" style="color: var(--xhs-text);">ä½¿ç”¨ç»Ÿè®¡</span>
            </div>
            <div class="flex gap-1">
              <button onclick="exportUsageStats()" class="px-2 py-1 rounded text-[10px] font-medium" style="background: #10B981; color: white;">å¯¼å‡º</button>
              <button onclick="triggerImportUsageStats()" class="px-2 py-1 rounded text-[10px] font-medium border" style="border-color: var(--xhs-border); color: var(--xhs-text);">å¯¼å…¥</button>
            </div>
          </div>
        </div>
      </div>

      <!-- æç¤ºä¿¡æ¯ -->
      <div class="mt-4 p-3 rounded-lg" style="background: #FEF3C7; border: 1px solid #F59E0B;">
        <p class="text-[11px]" style="color: #92400E;">
          <i class="fas fa-lightbulb mr-1"></i>
          <strong>æç¤ºï¼š</strong>å»ºè®®å®šæœŸå¯¼å‡ºå¤‡ä»½æ–‡ä»¶å¹¶å¦¥å–„ä¿å­˜ã€‚åˆ·æ–°é¡µé¢åæ•°æ®ä¼šé‡ç½®ï¼Œéœ€è¦é‡æ–°å¯¼å…¥å¤‡ä»½æ¥æ¢å¤ã€‚
        </p>
      </div>

      <button onclick="closeDataManager()" class="mt-4 w-full py-2 rounded-lg border text-sm" style="border-color: var(--xhs-border); color: var(--xhs-text);">
        å…³é—­
      </button>
    </div>
  </div>

  <!-- Text Edit Overlay -->
  <div id="textEditOverlay" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-40 flex items-center justify-center p-4">
    <div class="xhs-card p-5 w-full max-w-md max-h-[80vh] overflow-y-auto shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-base font-semibold" style="color: var(--xhs-text);">
          <i class="fas fa-edit mr-2" style="color: var(--xhs-red);"></i>
          <span id="textEditTitle">ç¼–è¾‘æ–‡å­—</span>
        </h3>
        <button onclick="closeTextEdit()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <textarea id="textEditArea" class="w-full h-40 p-3 border border-gray-200 dark:border-gray-600 rounded-xl resize-none focus:ring-2 focus:ring-red-400 focus:border-transparent bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white text-base" placeholder="è¾“å…¥æ–‡å­—å†…å®¹..."></textarea>
      <div class="mt-3 flex gap-2">
        <button onclick="closeTextEdit()" class="flex-1 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 text-sm">å–æ¶ˆ</button>
        <button onclick="saveTextEdit()" class="flex-1 py-2 rounded-lg btn-primary text-sm font-semibold">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Add Segment Modal -->
  <div id="segmentModal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="text-base font-bold text-gray-800 dark:text-white mb-3">
        <i class="fas fa-text-height text-pink-500 mr-2"></i>æ·»åŠ ç‰¹æ®Šæ–‡å­—
      </h3>
      <div class="space-y-3">
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">æ–‡å­—å†…å®¹</label>
          <input type="text" id="segmentText" class="w-full p-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white text-sm" placeholder="è¾“å…¥è¦çªå‡ºçš„æ–‡å­—...">
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">å­—å·: <span id="segmentSizeVal">24</span>px</label>
          <input type="range" id="segmentSize" min="12" max="60" value="24" class="w-full slider-custom appearance-none bg-transparent">
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">é¢œè‰²</label>
          <div class="flex gap-2 items-center">
            <input type="color" id="segmentColor" value="#ff2442" class="w-8 h-8 rounded cursor-pointer border border-gray-200">
            <div class="flex gap-1">
              <button onclick="document.getElementById('segmentColor').value='#333333'" class="w-6 h-6 rounded-full" style="background:#333333"></button>
              <button onclick="document.getElementById('segmentColor').value='#ff2442'" class="w-6 h-6 rounded-full" style="background:#ff2442"></button>
              <button onclick="document.getElementById('segmentColor').value='#1565c0'" class="w-6 h-6 rounded-full" style="background:#1565c0"></button>
              <button onclick="document.getElementById('segmentColor').value='#27ae60'" class="w-6 h-6 rounded-full" style="background:#27ae60"></button>
            </div>
          </div>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">ä½ç½®</label>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs text-gray-500 mb-1">X: <span id="segmentXVal">50</span>%</label>
              <input type="range" id="segmentX" min="5" max="95" value="50" class="w-full slider-custom appearance-none bg-transparent">
            </div>
            <div>
              <label class="block text-xs text-gray-500 mb-1">Y: <span id="segmentYVal">50</span>%</label>
              <input type="range" id="segmentY" min="5" max="95" value="50" class="w-full slider-custom appearance-none bg-transparent">
            </div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <input type="checkbox" id="segmentBold" class="rounded">
          <label class="text-xs text-gray-600 dark:text-gray-400">åŠ ç²—</label>
        </div>
      </div>
      <div class="mt-4 flex gap-2">
        <button onclick="closeSegmentModal()" class="flex-1 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 text-sm">å–æ¶ˆ</button>
        <button onclick="saveSegment()" class="flex-1 py-2 rounded-lg btn-primary text-sm font-semibold">æ·»åŠ </button>
      </div>
    </div>
  </div>

  <!-- Alert Modal -->
  <div id="alertModal" class="modal-overlay">
    <div class="modal-content text-center">
      <div id="alertIcon" class="text-4xl mb-3">âœ…</div>
      <h3 id="alertTitle" class="text-lg font-bold text-gray-800 dark:text-white mb-2">æ“ä½œæˆåŠŸ</h3>
      <p id="alertMessage" class="text-gray-600 dark:text-gray-300 mb-4 text-sm"></p>
      <button onclick="closeAlert()" class="btn-primary px-6 py-2 rounded-lg font-semibold text-sm">ç¡®å®š</button>
    </div>
  </div>

  <!-- Hidden inputs -->
  <input type="file" id="templateImageInput" accept="image/*,.psd" class="hidden">
  <input type="file" id="templateImportInput" accept=".json" class="hidden">
  <input type="file" id="rolesConfigInput" accept=".json" class="hidden">
  <canvas id="exportCanvas" class="hidden"></canvas>

  <script>
    // ğŸ” å¤šè§’è‰²å¯†ç é…ç½®
    const USER_ROLES = {
      admin: {
        password: 'adminhxd202507',
        name: 'ç®¡ç†å‘˜',
        icon: 'fa-user-shield',
        color: '#FF2442',
        expiryDate: null, // null = æ°¸ä¸è¿‡æœŸ
        permissions: {
          generate: true,      // ç”Ÿæˆå°é¢
          download: true,      // ä¸‹è½½å°é¢
          uploadTemplate: true, // ä¸Šä¼ æ¨¡ç‰ˆ
          exportImport: true,  // å¯¼å‡º/å¯¼å…¥æ¨¡ç‰ˆ
          styleSettings: true, // æ ·å¼è®¾ç½®
          advancedEdit: true,  // é«˜çº§ç¼–è¾‘
          deleteTemplate: true // åˆ é™¤æ¨¡ç‰ˆ
        }
      },
      vip: {
        password: 'buyan2025',
        name: 'æ­¥è¨€',
        icon: 'fa-crown',
        color: '#8B5CF6',
        expiryDate: null, // æ°¸ä¸è¿‡æœŸ
        permissions: {
          generate: true,
          download: true,
          uploadTemplate: true,
          exportImport: true,
          styleSettings: true,
          advancedEdit: true,
          deleteTemplate: true
        }
      },
      user: {
        password: 'user202507',
        name: 'æ™®é€šç”¨æˆ·',
        icon: 'fa-user',
        color: '#3B82F6',
        expiryDate: '2026-04-30', // åˆ°æœŸæ—¥æœŸ YYYY-MM-DD æ ¼å¼
        permissions: {
          generate: true,
          download: true,
          uploadTemplate: true,
          exportImport: true,
          styleSettings: true,
          advancedEdit: true,
          deleteTemplate: false
        }
      },
      staff: {
        password: 'hxd202507',
        name: 'å‘˜å·¥',
        icon: 'fa-user-tie',
        color: '#F59E0B',
        expiryDate: '2026-04-30',
        permissions: {
          generate: true,
          download: true,
          uploadTemplate: true,
          exportImport: true,
          styleSettings: true,
          advancedEdit: true,
          deleteTemplate: false
        }
      },
      guest: {
        password: 'fangke202507',
        name: 'è®¿å®¢',
        icon: 'fa-user-clock',
        color: '#10B981',
        expiryDate: '2026-04-30',
        permissions: {
          generate: true,
          download: false,
          uploadTemplate: false,
          exportImport: false,
          styleSettings: false,
          advancedEdit: false,
          deleteTemplate: false
        }
      }
    };

    // å½“å‰ç”¨æˆ·è§’è‰²
    let currentRole = null;

    // State (éœ€è¦åœ¨ checkPassword ä¹‹å‰å®šä¹‰)
    let state = {
      splitMode: false,
      title: '',
      text: '',
      templateId: 'minimal-white',
      fontId: 'noto-sans',
      fontSize: 20,
      lineHeight: 1.8,
      textColor: '#333333',
      alignment: 'center',
      titleFontId: 'noto-sans',
      titleFontSize: 32,
      titleColor: '#333333',
      titleAlignment: 'center',
      maxCharsPerPage: 500,
      pages: [],
      currentPage: 0,
      currentStyleTab: 'content',
      editMode: false,
      editTab: 'position',
      titleYOffset: 0,
      contentYOffset: 0,
      paddingTop: 8,
      paddingBottom: 8,
      paddingLeft: 8,
      paddingRight: 8,
      decorations: [],
      selectedDecoration: null,
      watermark: null,
      watermarkX: 50,
      watermarkY: 90,
      watermarkSize: 15,
      watermarkOpacity: 80,
      textSegments: [],
      selectedSegment: null,
      clickEditEnabled: true,
      editingTarget: null,
      multiPreviewMode: false,
      multiPageStart: 0,
      loginTime: null
    };

    // Online sessions tracking
    let onlineSessions = [];

    // ä½¿ç”¨ç»Ÿè®¡æ•°æ®
    let usageStats = {};

    // æ£€æŸ¥æƒé™
    function hasPermission(permission) {
      if (!currentRole) return false;
      return USER_ROLES[currentRole]?.permissions[permission] || false;
    }

    // å¯†ç éªŒè¯å‡½æ•°
    function checkPassword() {
      const input = document.getElementById('loginPassword');
      const errorMsg = document.getElementById('loginError');
      const password = input.value.trim();

      // æ£€æŸ¥æ‰€æœ‰è§’è‰²çš„å¯†ç 
      let matchedRole = null;
      for (const [role, config] of Object.entries(USER_ROLES)) {
        if (password === config.password) {
          matchedRole = role;
          break;
        }
      }

      if (matchedRole) {
        const roleConfig = USER_ROLES[matchedRole];

        // æ£€æŸ¥è´¦å·æ˜¯å¦å·²è¿‡æœŸ
        if (roleConfig.expiryDate) {
          const expiryDate = new Date(roleConfig.expiryDate + 'T23:59:59');
          const now = new Date();
          if (now > expiryDate) {
            // è´¦å·å·²è¿‡æœŸ
            errorMsg.textContent = `è´¦å·å·²äº ${roleConfig.expiryDate} åˆ°æœŸï¼Œè¯·è”ç³»ç®¡ç†å‘˜ç»­æœŸ`;
            errorMsg.classList.remove('hidden');
            input.style.borderColor = '#ef4444';
            input.value = '';
            input.focus();
            setTimeout(() => {
              errorMsg.classList.add('hidden');
              errorMsg.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
              input.style.borderColor = 'var(--xhs-border)';
            }, 5000);
            return;
          }
        }

        // å¯†ç æ­£ç¡®ä¸”æœªè¿‡æœŸï¼Œè®¾ç½®å½“å‰è§’è‰²
        currentRole = matchedRole;

        // è®°å½•ç™»å½•æ—¶é—´
        state.loginTime = new Date();

        // æ·»åŠ åˆ°åœ¨çº¿ä¼šè¯åˆ—è¡¨
        const sessionId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        onlineSessions.push({
          id: sessionId,
          role: matchedRole,
          roleName: roleConfig.name,
          roleColor: roleConfig.color,
          roleIcon: roleConfig.icon,
          loginTime: state.loginTime,
          lastActive: new Date()
        });

        // éšè—ç™»å½•ç•Œé¢ï¼Œæ˜¾ç¤ºä¸»åº”ç”¨
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('app').classList.remove('hidden');

        // åˆå§‹åŒ–åº”ç”¨
        init();

        // åº”ç”¨æƒé™æ§åˆ¶
        applyPermissions();

        // æ˜¾ç¤ºæ¬¢è¿æç¤º
        setTimeout(() => {
          showAlert('success', `æ¬¢è¿ï¼Œ${roleConfig.name}`, 'å·²æˆåŠŸç™»å½•');
        }, 500);
      } else {
        // å¯†ç é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
        errorMsg.classList.remove('hidden');
        input.style.borderColor = '#ef4444';
        input.value = '';
        input.focus();

        // 3ç§’åéšè—é”™è¯¯æç¤º
        setTimeout(() => {
          errorMsg.classList.add('hidden');
          input.style.borderColor = 'var(--xhs-border)';
        }, 3000);
      }
    }

    // åº”ç”¨æƒé™æ§åˆ¶
    function applyPermissions() {
      if (!currentRole) return;

      const roleConfig = USER_ROLES[currentRole];

      // æ›´æ–°è§’è‰²æ˜¾ç¤º
      updateRoleDisplay();

      // ä¸‹è½½æŒ‰é’®
      const downloadBtns = document.querySelectorAll('[data-permission="download"]');
      downloadBtns.forEach(btn => {
        if (!hasPermission('download')) {
          btn.classList.add('opacity-50', 'cursor-not-allowed');
          btn.setAttribute('disabled', 'true');
          btn.onclick = (e) => {
            e.preventDefault();
            showAlert('warning', 'æƒé™ä¸è¶³', 'è®¿å®¢æ— æ³•ä¸‹è½½å°é¢');
          };
        }
      });

      // ä¸Šä¼ æ¨¡ç‰ˆæŒ‰é’®
      const uploadTemplateArea = document.getElementById('uploadTemplateArea');
      if (uploadTemplateArea && !hasPermission('uploadTemplate')) {
        uploadTemplateArea.style.display = 'none';
      }

      // å¯¼å‡ºå¯¼å…¥æŒ‰é’®
      const exportBtn = document.getElementById('exportBtn');
      const importBtn = document.getElementById('importBtn');
      if (!hasPermission('exportImport')) {
        if (exportBtn) exportBtn.style.display = 'none';
        if (importBtn) importBtn.style.display = 'none';
      }

      // æ ·å¼è®¾ç½®åŒºåŸŸ
      if (!hasPermission('styleSettings')) {
        const styleSection = document.getElementById('styleSection');
        const styleSectionToggle = styleSection?.previousElementSibling;
        if (styleSection) styleSection.style.display = 'none';
        if (styleSectionToggle) styleSectionToggle.style.display = 'none';

        // é«˜çº§è®¾ç½®åŒºåŸŸ
        const advancedSection = document.getElementById('advancedSection');
        const advancedSectionToggle = advancedSection?.previousElementSibling;
        if (advancedSection) advancedSection.style.display = 'none';
        if (advancedSectionToggle) advancedSectionToggle.style.display = 'none';
      }

      // é«˜çº§ç¼–è¾‘æ¨¡å¼
      if (!hasPermission('advancedEdit')) {
        const editModeBtn = document.getElementById('editModeBtn');
        if (editModeBtn) editModeBtn.style.display = 'none';
      }
    }

    // æ›´æ–°è§’è‰²æ˜¾ç¤º
    function updateRoleDisplay() {
      const roleConfig = USER_ROLES[currentRole];
      const roleIndicator = document.getElementById('roleIndicator');
      if (roleIndicator && roleConfig) {
        roleIndicator.innerHTML = `
          <i class="fas ${roleConfig.icon}" style="color: ${roleConfig.color};"></i>
          <span style="color: ${roleConfig.color};">${roleConfig.name}</span>
        `;
        roleIndicator.classList.remove('hidden');
      }

      // æ˜¾ç¤ºç®¡ç†å‘˜è®¾ç½®æŒ‰é’®
      const adminSettingsBtn = document.getElementById('adminSettingsBtn');
      if (adminSettingsBtn) {
        if (currentRole === 'admin') {
          adminSettingsBtn.classList.remove('hidden');
        } else {
          adminSettingsBtn.classList.add('hidden');
        }
      }

      // æ˜¾ç¤ºæ•°æ®ç®¡ç†æŒ‰é’®ï¼ˆç®¡ç†å‘˜å’ŒVIPå¯è§ï¼‰
      const dataManageBtn = document.getElementById('dataManageBtn');
      if (dataManageBtn) {
        if (currentRole === 'admin' || currentRole === 'vip') {
          dataManageBtn.classList.remove('hidden');
        } else {
          dataManageBtn.classList.add('hidden');
        }
      }
    }

    // é»˜è®¤è§’è‰²é…ç½®ï¼ˆç”¨äºæ¢å¤ï¼‰
    const DEFAULT_ROLES = JSON.parse(JSON.stringify(USER_ROLES));

    // æ‰“å¼€ç®¡ç†å‘˜é¢æ¿
    function openAdminPanel() {
      if (currentRole !== 'admin') {
        showAlert('warning', 'æƒé™ä¸è¶³', 'ä»…ç®¡ç†å‘˜å¯è®¿é—®æ­¤åŠŸèƒ½');
        return;
      }
      renderRolesList();
      updateUsageStatsDisplay();
      updateOnlineStatus();
      document.getElementById('adminPanelOverlay').classList.remove('hidden');
    }

    // æ›´æ–°åœ¨çº¿çŠ¶æ€æ˜¾ç¤º
    function updateOnlineStatus() {
      const container = document.getElementById('onlineStatusContent');
      if (!container) return;

      // æ›´æ–°å½“å‰ä¼šè¯çš„æœ€åæ´»è·ƒæ—¶é—´
      const currentSession = onlineSessions.find(s => s.role === currentRole);
      if (currentSession) {
        currentSession.lastActive = new Date();
      }

      // ç”Ÿæˆåœ¨çº¿ç”¨æˆ·åˆ—è¡¨HTML
      let html = `
        <div class="flex items-center justify-between py-2 px-3 rounded-lg" style="background: var(--xhs-card);">
          <div class="flex items-center gap-2">
            <span class="text-lg font-bold" style="color: var(--xhs-red);">${onlineSessions.length}</span>
            <span class="text-xs" style="color: var(--xhs-text-secondary);">äººåœ¨çº¿</span>
          </div>
          <div class="text-xs" style="color: var(--xhs-text-secondary);">
            <i class="fas fa-clock mr-1"></i>
            ${new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}
          </div>
        </div>
      `;

      // æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·è¯¦æƒ…
      html += '<div class="mt-2 space-y-1.5">';
      onlineSessions.forEach((session, index) => {
        const loginDuration = getTimeDuration(session.loginTime);
        const isCurrentUser = session.role === currentRole;
        html += `
          <div class="flex items-center justify-between py-1.5 px-2 rounded-lg text-xs ${isCurrentUser ? 'ring-1' : ''}"
               style="background: ${session.roleColor}15; ${isCurrentUser ? `ring-color: ${session.roleColor};` : ''}">
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 rounded-full flex items-center justify-center text-white text-[10px]" style="background: ${session.roleColor};">
                <i class="fas ${session.roleIcon}"></i>
              </div>
              <span style="color: var(--xhs-text);">
                ${session.roleName}
                ${isCurrentUser ? '<span class="text-[10px] ml-1" style="color: var(--xhs-text-secondary);">(å½“å‰)</span>' : ''}
              </span>
            </div>
            <div class="flex items-center gap-2">
              <span style="color: var(--xhs-text-secondary);">
                <i class="fas fa-hourglass-half mr-1"></i>${loginDuration}
              </span>
            </div>
          </div>
        `;
      });
      html += '</div>';

      container.innerHTML = html;
    }

    // è®¡ç®—åœ¨çº¿æ—¶é•¿
    function getTimeDuration(startTime) {
      const now = new Date();
      const diff = now - new Date(startTime);
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(minutes / 60);

      if (hours > 0) {
        return `${hours}å°æ—¶${minutes % 60}åˆ†é’Ÿ`;
      } else if (minutes > 0) {
        return `${minutes}åˆ†é’Ÿ`;
      } else {
        return 'åˆšåˆšç™»å½•';
      }
    }

    // å…³é—­ç®¡ç†å‘˜é¢æ¿
    function closeAdminPanel() {
      document.getElementById('adminPanelOverlay').classList.add('hidden');
    }

    // æ›´æ–°ä½¿ç”¨ç»Ÿè®¡æ˜¾ç¤º
    function updateUsageStatsDisplay() {
      const container = document.getElementById('usageStatsContent');
      if (!container) return;

      const today = new Date().toISOString().split('T')[0];
      let todayTotal = 0;
      let allTotal = 0;

      // è®¡ç®—ç»Ÿè®¡æ•°æ®
      for (const [roleId, dates] of Object.entries(usageStats)) {
        for (const [date, stats] of Object.entries(dates)) {
          allTotal += stats.downloads || 0;
          if (date === today) {
            todayTotal += stats.downloads || 0;
          }
        }
      }

      // æŒ‰è§’è‰²ç”Ÿæˆç»Ÿè®¡
      let html = `
        <div class="flex items-center justify-between py-2 px-3 rounded-lg" style="background: var(--xhs-card);">
          <div class="flex items-center gap-3">
            <div class="text-center">
              <div class="text-lg font-bold" style="color: var(--xhs-red);">${todayTotal}</div>
              <div class="text-[10px]" style="color: var(--xhs-text-secondary);">ä»Šæ—¥ä¸‹è½½</div>
            </div>
            <div class="w-px h-8" style="background: var(--xhs-border);"></div>
            <div class="text-center">
              <div class="text-lg font-bold" style="color: #3B82F6;">${allTotal}</div>
              <div class="text-[10px]" style="color: var(--xhs-text-secondary);">æ€»ä¸‹è½½é‡</div>
            </div>
          </div>
          <div class="text-[10px]" style="color: var(--xhs-text-secondary);">
            ${Object.keys(usageStats).length} ä¸ªç”¨æˆ·æœ‰è®°å½•
          </div>
        </div>
      `;

      // æ˜¾ç¤ºå„è§’è‰²ä»Šæ—¥ç»Ÿè®¡
      html += '<div class="mt-2 space-y-1">';
      for (const [roleId, config] of Object.entries(USER_ROLES)) {
        const todayStats = getTodayStats(roleId);
        if (todayStats.downloads > 0) {
          html += `
            <div class="flex items-center justify-between py-1 px-2 rounded text-xs" style="background: ${config.color}10;">
              <div class="flex items-center gap-1.5">
                <i class="fas ${config.icon}" style="color: ${config.color}; font-size: 10px;"></i>
                <span style="color: var(--xhs-text);">${config.name}</span>
              </div>
              <span style="color: ${config.color}; font-weight: 600;">
                <i class="fas fa-download mr-1" style="font-size: 9px;"></i>${todayStats.downloads}
              </span>
            </div>
          `;
        }
      }
      if (todayTotal === 0) {
        html += `<div class="text-center py-2 text-xs" style="color: var(--xhs-text-secondary);">ä»Šæ—¥æš‚æ— ä¸‹è½½è®°å½•</div>`;
      }
      html += '</div>';

      container.innerHTML = html;
    }

    // æ˜¾ç¤ºä½¿ç”¨è¯¦æƒ…å¼¹çª—
    function showUsageDetails() {
      // å¡«å……è§’è‰²é€‰æ‹©ä¸‹æ‹‰æ¡†
      const select = document.getElementById('usageRoleSelect');
      select.innerHTML = '<option value="all">å…¨éƒ¨è§’è‰²</option>';
      for (const [roleId, config] of Object.entries(USER_ROLES)) {
        select.innerHTML += `<option value="${roleId}">${config.name}</option>`;
      }

      updateUsageDetailsView();
      document.getElementById('usageDetailsOverlay').classList.remove('hidden');
    }

    // å…³é—­ä½¿ç”¨è¯¦æƒ…å¼¹çª—
    function closeUsageDetails() {
      document.getElementById('usageDetailsOverlay').classList.add('hidden');
    }

    // æ›´æ–°ä½¿ç”¨è¯¦æƒ…è§†å›¾
    function updateUsageDetailsView() {
      const selectedRole = document.getElementById('usageRoleSelect').value;
      const today = new Date().toISOString().split('T')[0];

      let totalDownloads = 0;
      let todayDownloads = 0;
      const dailyData = {}; // { date: { roleId: downloads, ... } }

      // æ”¶é›†æ•°æ®
      for (const [roleId, dates] of Object.entries(usageStats)) {
        if (selectedRole !== 'all' && roleId !== selectedRole) continue;

        for (const [date, stats] of Object.entries(dates)) {
          if (!dailyData[date]) dailyData[date] = {};
          dailyData[date][roleId] = stats.downloads || 0;
          totalDownloads += stats.downloads || 0;
          if (date === today) {
            todayDownloads += stats.downloads || 0;
          }
        }
      }

      // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
      document.getElementById('totalDownloadsDisplay').textContent = totalDownloads;
      document.getElementById('todayDownloadsDisplay').textContent = todayDownloads;

      // ç”Ÿæˆè¡¨æ ¼
      const tableContainer = document.getElementById('usageDetailsTable');
      const sortedDates = Object.keys(dailyData).sort((a, b) => b.localeCompare(a)); // æœ€æ–°çš„åœ¨å‰

      if (sortedDates.length === 0) {
        tableContainer.innerHTML = `
          <div class="p-4 text-center text-sm" style="color: var(--xhs-text-secondary);">
            <i class="fas fa-inbox text-2xl mb-2 opacity-50"></i>
            <p>æš‚æ— ä½¿ç”¨è®°å½•</p>
          </div>
        `;
        return;
      }

      let tableHtml = '';
      sortedDates.forEach(date => {
        const dateData = dailyData[date];
        const isToday = date === today;
        const dateLabel = isToday ? 'ä»Šå¤©' : formatDate(date);

        tableHtml += `
          <div class="border-b last:border-b-0" style="border-color: var(--xhs-border);">
            <div class="flex items-center justify-between px-3 py-2 ${isToday ? 'bg-red-50 dark:bg-red-900/10' : ''}" style="background: ${isToday ? '' : 'var(--xhs-card)'};">
              <div class="flex items-center gap-2">
                <span class="text-xs font-medium ${isToday ? 'text-red-500' : ''}" style="color: ${isToday ? '' : 'var(--xhs-text)'};">
                  ${isToday ? '<i class="fas fa-star mr-1"></i>' : ''}${dateLabel}
                </span>
                <span class="text-[10px]" style="color: var(--xhs-text-secondary);">${date}</span>
              </div>
              <div class="flex items-center gap-2">
        `;

        // æ˜¾ç¤ºæ¯ä¸ªè§’è‰²çš„ä¸‹è½½æ•°
        for (const [roleId, downloads] of Object.entries(dateData)) {
          if (downloads > 0) {
            const roleConfig = USER_ROLES[roleId];
            if (roleConfig) {
              tableHtml += `
                <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px]" style="background: ${roleConfig.color}20; color: ${roleConfig.color};">
                  <i class="fas ${roleConfig.icon}" style="font-size: 8px;"></i>
                  ${downloads}
                </span>
              `;
            }
          }
        }

        tableHtml += `
              </div>
            </div>
          </div>
        `;
      });

      tableContainer.innerHTML = tableHtml;
    }

    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
      return `${month}æœˆ${day}æ—¥ ${weekdays[date.getDay()]}`;
    }

    // å¯¼å‡ºç»Ÿè®¡æ•°æ®
    function exportUsageStats() {
      const exportData = {
        exportTime: new Date().toISOString(),
        stats: usageStats
      };

      const jsonStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = `ä½¿ç”¨ç»Ÿè®¡_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.json`;
      link.click();

      URL.revokeObjectURL(url);
      showAlert('success', 'å¯¼å‡ºæˆåŠŸ', 'ç»Ÿè®¡æ•°æ®å·²ä¿å­˜');
    }

    // æ¸…ç©ºç»Ÿè®¡æ•°æ®
    function clearUsageStats() {
      showConfirmDialog('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä½¿ç”¨ç»Ÿè®¡æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', () => {
        usageStats = {};
        updateUsageStatsDisplay();
        updateUsageDetailsView();
        showAlert('success', 'å·²æ¸…ç©º', 'æ‰€æœ‰ç»Ÿè®¡æ•°æ®å·²åˆ é™¤');
      });
    }

    // ç¡®è®¤å¯¹è¯æ¡†
    function showConfirmDialog(message, onConfirm) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg max-w-sm w-full mx-4">
          <p class="text-sm mb-4" style="color: var(--xhs-text);">${message}</p>
          <div class="flex justify-end gap-2">
            <button class="px-4 py-2 text-sm rounded-lg border transition-colors" style="border-color: var(--xhs-border); color: var(--xhs-text);" onclick="this.closest('.fixed').remove()">å–æ¶ˆ</button>
            <button class="px-4 py-2 text-sm rounded-lg text-white transition-colors" style="background: #EF4444;" onclick="this.closest('.fixed').remove(); (${onConfirm.toString()})()">ç¡®å®š</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // ==================== æ•°æ®ç®¡ç†åŠŸèƒ½ ====================

    // æ‰“å¼€æ•°æ®ç®¡ç†å¼¹çª—
    function openDataManager() {
      updateDataOverview();
      document.getElementById('dataManagerOverlay').classList.remove('hidden');
    }

    // å…³é—­æ•°æ®ç®¡ç†å¼¹çª—
    function closeDataManager() {
      document.getElementById('dataManagerOverlay').classList.add('hidden');
    }

    // æ›´æ–°æ•°æ®æ¦‚è§ˆ
    function updateDataOverview() {
      document.getElementById('dataRolesCount').textContent = Object.keys(USER_ROLES).length;
      document.getElementById('dataTemplatesCount').textContent = customTemplates.length;

      // è®¡ç®—ç»Ÿè®¡è®°å½•å¤©æ•°
      let statsDays = 0;
      for (const dates of Object.values(usageStats)) {
        statsDays += Object.keys(dates).length;
      }
      document.getElementById('dataStatsCount').textContent = statsDays;
    }

    // å¯¼å‡ºæ‰€æœ‰æ•°æ®ï¼ˆä¸€é”®å¤‡ä»½ï¼‰
    function exportAllData() {
      // æ”¶é›†è§’è‰²é…ç½®
      const rolesData = {};
      for (const [roleId, config] of Object.entries(USER_ROLES)) {
        rolesData[roleId] = {
          password: config.password,
          name: config.name,
          icon: config.icon,
          color: config.color,
          enabled: config.enabled !== false,
          expiryDate: config.expiryDate || null,
          permissions: { ...config.permissions }
        };
      }

      // æ”¶é›†æ¨¡ç‰ˆæ•°æ®ï¼ˆéœ€è¦å‹ç¼©å›¾ç‰‡æ•°æ®ï¼‰
      const templatesData = customTemplates.map(t => ({
        id: t.id,
        name: t.name,
        image: t.image // Base64 å›¾ç‰‡æ•°æ®
      }));

      // ç»„åˆæ‰€æœ‰æ•°æ®
      const exportData = {
        version: '1.0',
        exportTime: new Date().toISOString(),
        appName: 'å°çº¢ä¹¦å›¾æ–‡å°é¢ç”Ÿæˆå™¨',
        data: {
          roles: rolesData,
          templates: templatesData,
          usageStats: usageStats
        }
      };

      const jsonStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = `å°çº¢ä¹¦å°é¢_å®Œæ•´å¤‡ä»½_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.json`;
      link.click();

      URL.revokeObjectURL(url);
      showAlert('success', 'å¤‡ä»½æˆåŠŸ', 'å®Œæ•´æ•°æ®å·²å¯¼å‡ºï¼Œè¯·å¦¥å–„ä¿å­˜æ–‡ä»¶');
    }

    // è§¦å‘å¯¼å…¥æ‰€æœ‰æ•°æ®
    function triggerImportAllData() {
      document.getElementById('allDataImportInput').click();
    }

    // å¯¼å…¥æ‰€æœ‰æ•°æ®ï¼ˆä¸€é”®æ¢å¤ï¼‰
    async function importAllData(file) {
      try {
        const text = await file.text();
        const importData = JSON.parse(text);

        // éªŒè¯æ•°æ®æ ¼å¼
        if (!importData.data || typeof importData.data !== 'object') {
          throw new Error('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼');
        }

        let importedItems = [];

        // å¯¼å…¥è§’è‰²é…ç½®
        if (importData.data.roles && importData.data.roles.admin) {
          // æ¸…é™¤ç°æœ‰éé»˜è®¤è§’è‰²
          for (const roleId of Object.keys(USER_ROLES)) {
            if (roleId !== 'admin') {
              delete USER_ROLES[roleId];
            }
          }
          // å¯¼å…¥æ‰€æœ‰è§’è‰²
          for (const [roleId, config] of Object.entries(importData.data.roles)) {
            USER_ROLES[roleId] = {
              password: config.password || 'default123',
              name: config.name || roleId,
              icon: config.icon || 'fa-user',
              color: config.color || '#666666',
              enabled: config.enabled !== false,
              expiryDate: config.expiryDate || null,
              permissions: config.permissions || {
                generate: true, download: false, uploadTemplate: false,
                exportImport: false, styleSettings: false, advancedEdit: false, deleteTemplate: false
              }
            };
          }
          importedItems.push(`${Object.keys(importData.data.roles).length} ä¸ªè§’è‰²`);
        }

        // å¯¼å…¥æ¨¡ç‰ˆ
        if (importData.data.templates && Array.isArray(importData.data.templates)) {
          customTemplates.length = 0; // æ¸…ç©ºç°æœ‰æ¨¡ç‰ˆ
          for (const template of importData.data.templates) {
            if (template.id && template.image) {
              customTemplates.push({
                id: template.id,
                name: template.name || 'æœªå‘½åæ¨¡ç‰ˆ',
                image: template.image
              });
            }
          }
          renderCustomTemplates();
          importedItems.push(`${importData.data.templates.length} ä¸ªæ¨¡ç‰ˆ`);
        }

        // å¯¼å…¥ä½¿ç”¨ç»Ÿè®¡
        if (importData.data.usageStats && typeof importData.data.usageStats === 'object') {
          usageStats = importData.data.usageStats;
          let days = 0;
          for (const dates of Object.values(usageStats)) {
            days += Object.keys(dates).length;
          }
          importedItems.push(`${days} æ¡ç»Ÿè®¡è®°å½•`);
        }

        updateDataOverview();
        showAlert('success', 'æ¢å¤æˆåŠŸ', `å·²å¯¼å…¥: ${importedItems.join('ã€')}`);

      } catch (error) {
        console.error('Import all data error:', error);
        showAlert('error', 'å¯¼å…¥å¤±è´¥', 'å¤‡ä»½æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–å·²æŸå');
      }
    }

    // è§¦å‘å¯¼å…¥ä½¿ç”¨ç»Ÿè®¡
    function triggerImportUsageStats() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        if (e.target.files[0]) {
          importUsageStatsFile(e.target.files[0]);
        }
      };
      input.click();
    }

    // å¯¼å…¥ä½¿ç”¨ç»Ÿè®¡æ–‡ä»¶
    async function importUsageStatsFile(file) {
      try {
        const text = await file.text();
        const importData = JSON.parse(text);

        // æ”¯æŒä¸¤ç§æ ¼å¼ï¼šç›´æ¥çš„ç»Ÿè®¡æ•°æ®æˆ–åŒ…å«statsçš„å¯¹è±¡
        const statsData = importData.stats || importData;

        if (typeof statsData !== 'object') {
          throw new Error('Invalid format');
        }

        usageStats = statsData;
        updateDataOverview();
        showAlert('success', 'å¯¼å…¥æˆåŠŸ', 'ä½¿ç”¨ç»Ÿè®¡å·²æ¢å¤');

      } catch (error) {
        console.error('Import usage stats error:', error);
        showAlert('error', 'å¯¼å…¥å¤±è´¥', 'æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
      }
    }

    // æ¸²æŸ“è§’è‰²åˆ—è¡¨
    function renderRolesList() {
      const container = document.getElementById('rolesList');
      let html = '';

      for (const [roleId, config] of Object.entries(USER_ROLES)) {
        const isAdmin = roleId === 'admin';
        const isEnabled = config.enabled !== false;

        html += `
          <div class="p-4 rounded-xl border ${isEnabled ? '' : 'opacity-50'}" style="border-color: var(--xhs-border); background: var(--xhs-card);">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: ${config.color}20;">
                  <i class="fas ${config.icon}" style="color: ${config.color};"></i>
                </div>
                <div>
                  <h4 class="font-semibold text-sm" style="color: var(--xhs-text);">${config.name}</h4>
                  <p class="text-xs" style="color: var(--xhs-text-secondary);">ID: ${roleId}</p>
                </div>
              </div>
              ${!isAdmin ? `
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="toggleRole('${roleId}')" class="sr-only peer">
                  <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-green-500"></div>
                </label>
              ` : '<span class="text-xs px-2 py-1 rounded-full bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400">ä¸å¯ç¦ç”¨</span>'}
            </div>

            <!-- å¯†ç ä¿®æ”¹ -->
            <div class="flex items-center gap-2">
              <div class="flex-1 relative">
                <input type="password" id="pwd-${roleId}" value="${config.password}"
                  class="w-full px-3 py-2 pr-8 text-sm rounded-lg border"
                  style="border-color: var(--xhs-border); background: var(--xhs-bg-solid); color: var(--xhs-text);"
                  ${!isEnabled ? 'disabled' : ''}>
                <button onclick="togglePasswordVisibility('pwd-${roleId}')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <i class="fas fa-eye text-xs"></i>
                </button>
              </div>
              <button onclick="updatePassword('${roleId}')" class="px-3 py-2 rounded-lg text-xs font-medium text-white transition-colors" style="background: var(--xhs-red);" ${!isEnabled ? 'disabled' : ''}>
                ä¿å­˜
              </button>
            </div>

            <!-- åˆ°æœŸæ—¶é—´è®¾ç½® -->
            <div class="mt-3 pt-3 border-t" style="border-color: var(--xhs-border);">
              <p class="text-xs font-medium mb-2" style="color: var(--xhs-text-secondary);">
                <i class="fas fa-calendar-alt mr-1"></i> è´¦å·æœ‰æ•ˆæœŸï¼š
              </p>
              <div class="flex items-center gap-2">
                <div class="flex-1 relative">
                  <input type="date" id="expiry-${roleId}" value="${config.expiryDate || ''}"
                    class="w-full px-3 py-2 text-sm rounded-lg border"
                    style="border-color: var(--xhs-border); background: var(--xhs-bg-solid); color: var(--xhs-text);"
                    ${isAdmin ? 'disabled' : ''}>
                </div>
                <button onclick="updateExpiryDate('${roleId}')" class="px-3 py-2 rounded-lg text-xs font-medium text-white transition-colors" style="background: ${config.expiryDate ? '#F59E0B' : '#10B981'};" ${isAdmin ? 'disabled' : ''}>
                  ${config.expiryDate ? 'ä¿®æ”¹' : 'è®¾ç½®'}
                </button>
                ${config.expiryDate && !isAdmin ? `
                  <button onclick="clearExpiryDate('${roleId}')" class="px-2 py-2 rounded-lg text-xs text-gray-500 hover:text-red-500 transition-colors" title="è®¾ä¸ºæ°¸ä¸è¿‡æœŸ">
                    <i class="fas fa-infinity"></i>
                  </button>
                ` : ''}
              </div>
              <p class="text-[10px] mt-1" style="color: ${getExpiryStatusColor(config.expiryDate)};">
                ${getExpiryStatusText(config.expiryDate)}
              </p>
            </div>

            <!-- æƒé™åˆ—è¡¨ -->
            <div class="mt-3 pt-3 border-t" style="border-color: var(--xhs-border);">
              <p class="text-xs font-medium mb-2" style="color: var(--xhs-text-secondary);">æƒé™è®¾ç½®ï¼š</p>
              <div class="grid grid-cols-2 gap-2">
                ${Object.entries(config.permissions).map(([perm, enabled]) => `
                  <label class="flex items-center gap-2 text-xs ${!isEnabled ? 'opacity-50' : ''}">
                    <input type="checkbox" ${enabled ? 'checked' : ''}
                      onchange="togglePermission('${roleId}', '${perm}')"
                      class="w-4 h-4 rounded border-gray-300 text-red-500 focus:ring-red-500"
                      ${isAdmin || !isEnabled ? 'disabled' : ''}>
                    <span style="color: var(--xhs-text);">${getPermissionName(perm)}</span>
                  </label>
                `).join('')}
              </div>
            </div>

            ${!isAdmin && isEnabled ? `
              <button onclick="deleteRole('${roleId}')" class="mt-3 w-full py-2 rounded-lg text-xs font-medium text-red-500 border border-red-200 hover:bg-red-50 dark:border-red-800 dark:hover:bg-red-900/20 transition-colors">
                <i class="fas fa-trash-alt mr-1"></i> åˆ é™¤æ­¤è§’è‰²
              </button>
            ` : ''}
          </div>
        `;
      }

      container.innerHTML = html;
    }

    // è·å–æƒé™åç§°
    function getPermissionName(perm) {
      const names = {
        generate: 'ç”Ÿæˆå°é¢',
        download: 'ä¸‹è½½å°é¢',
        uploadTemplate: 'ä¸Šä¼ æ¨¡ç‰ˆ',
        exportImport: 'å¯¼å‡º/å¯¼å…¥',
        styleSettings: 'æ ·å¼è®¾ç½®',
        advancedEdit: 'é«˜çº§ç¼–è¾‘',
        deleteTemplate: 'åˆ é™¤æ¨¡ç‰ˆ'
      };
      return names[perm] || perm;
    }

    // è·å–åˆ°æœŸçŠ¶æ€æ–‡æœ¬
    function getExpiryStatusText(expiryDate) {
      if (!expiryDate) {
        return 'âœ¨ æ°¸ä¸è¿‡æœŸ';
      }
      const expiry = new Date(expiryDate + 'T23:59:59');
      const now = new Date();
      const diffDays = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));

      if (diffDays < 0) {
        return `âŒ å·²äº ${expiryDate} è¿‡æœŸ`;
      } else if (diffDays === 0) {
        return 'âš ï¸ ä»Šå¤©åˆ°æœŸ';
      } else if (diffDays <= 7) {
        return `âš ï¸ ${diffDays} å¤©ååˆ°æœŸ`;
      } else if (diffDays <= 30) {
        return `ğŸ“… ${diffDays} å¤©ååˆ°æœŸ (${expiryDate})`;
      } else {
        return `âœ… æœ‰æ•ˆè‡³ ${expiryDate}`;
      }
    }

    // è·å–åˆ°æœŸçŠ¶æ€é¢œè‰²
    function getExpiryStatusColor(expiryDate) {
      if (!expiryDate) {
        return '#10B981'; // ç»¿è‰² - æ°¸ä¸è¿‡æœŸ
      }
      const expiry = new Date(expiryDate + 'T23:59:59');
      const now = new Date();
      const diffDays = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));

      if (diffDays < 0) {
        return '#EF4444'; // çº¢è‰² - å·²è¿‡æœŸ
      } else if (diffDays <= 7) {
        return '#F59E0B'; // æ©™è‰² - å³å°†è¿‡æœŸ
      } else {
        return '#10B981'; // ç»¿è‰² - æ­£å¸¸
      }
    }

    // æ›´æ–°åˆ°æœŸæ—¶é—´
    function updateExpiryDate(roleId) {
      if (roleId === 'admin') {
        showAlert('warning', 'æ— æ³•ä¿®æ”¹', 'ç®¡ç†å‘˜è´¦å·ä¸èƒ½è®¾ç½®åˆ°æœŸæ—¶é—´');
        return;
      }
      const input = document.getElementById(`expiry-${roleId}`);
      const newDate = input.value;

      if (!newDate) {
        showAlert('warning', 'è¯·é€‰æ‹©æ—¥æœŸ', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ°æœŸæ—¥æœŸ');
        return;
      }

      USER_ROLES[roleId].expiryDate = newDate;
      renderRolesList();
      showAlert('success', 'å·²æ›´æ–°', `${USER_ROLES[roleId].name}çš„åˆ°æœŸæ—¶é—´å·²è®¾ä¸º ${newDate}`);
    }

    // æ¸…é™¤åˆ°æœŸæ—¶é—´ï¼ˆè®¾ä¸ºæ°¸ä¸è¿‡æœŸï¼‰
    function clearExpiryDate(roleId) {
      if (roleId === 'admin') return;
      USER_ROLES[roleId].expiryDate = null;
      renderRolesList();
      showAlert('success', 'å·²æ›´æ–°', `${USER_ROLES[roleId].name}å·²è®¾ä¸ºæ°¸ä¸è¿‡æœŸ`);
    }

    // åˆ‡æ¢è§’è‰²å¯ç”¨çŠ¶æ€
    function toggleRole(roleId) {
      if (roleId === 'admin') return;
      USER_ROLES[roleId].enabled = !USER_ROLES[roleId].enabled;
      renderRolesList();
      showAlert('success', 'å·²æ›´æ–°', `${USER_ROLES[roleId].name}å·²${USER_ROLES[roleId].enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
    }

    // åˆ‡æ¢æƒé™
    function togglePermission(roleId, permission) {
      if (roleId === 'admin') return;
      USER_ROLES[roleId].permissions[permission] = !USER_ROLES[roleId].permissions[permission];
      showAlert('success', 'æƒé™å·²æ›´æ–°', `${USER_ROLES[roleId].name}çš„${getPermissionName(permission)}å·²${USER_ROLES[roleId].permissions[permission] ? 'å¼€å¯' : 'å…³é—­'}`);
    }

    // æ›´æ–°å¯†ç 
    function updatePassword(roleId) {
      const input = document.getElementById(`pwd-${roleId}`);
      const newPassword = input.value.trim();
      if (!newPassword) {
        showAlert('error', 'å¯†ç ä¸èƒ½ä¸ºç©º', 'è¯·è¾“å…¥æœ‰æ•ˆçš„å¯†ç ');
        return;
      }
      USER_ROLES[roleId].password = newPassword;
      showAlert('success', 'å¯†ç å·²æ›´æ–°', `${USER_ROLES[roleId].name}çš„å¯†ç å·²ä¿®æ”¹`);
    }

    // åˆ‡æ¢å¯†ç æ˜¾ç¤º
    function togglePasswordVisibility(inputId) {
      const input = document.getElementById(inputId);
      const icon = input.nextElementSibling.querySelector('i');
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }

    // åˆ é™¤è§’è‰²
    function deleteRole(roleId) {
      if (roleId === 'admin') return;

      // åˆ›å»ºç¡®è®¤å¼¹çª—
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]';
      modal.innerHTML = `
        <div class="xhs-card p-5 max-w-sm mx-4 shadow-2xl">
          <h3 class="text-base font-semibold mb-2" style="color: var(--xhs-text);">
            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>ç¡®è®¤åˆ é™¤
          </h3>
          <p class="text-sm mb-4" style="color: var(--xhs-text-secondary);">
            ç¡®å®šè¦åˆ é™¤ã€Œ${USER_ROLES[roleId].name}ã€è§’è‰²å—ï¼Ÿæ­¤æ“ä½œåœ¨åˆ·æ–°é¡µé¢å‰æœ‰æ•ˆã€‚
          </p>
          <div class="flex gap-2">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 text-sm">å–æ¶ˆ</button>
            <button onclick="confirmDeleteRole('${roleId}'); this.closest('.fixed').remove()" class="flex-1 py-2 rounded-lg bg-red-500 text-white text-sm font-semibold hover:bg-red-600">åˆ é™¤</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // ç¡®è®¤åˆ é™¤è§’è‰²
    function confirmDeleteRole(roleId) {
      const roleName = USER_ROLES[roleId].name;
      delete USER_ROLES[roleId];
      renderRolesList();
      showAlert('success', 'å·²åˆ é™¤', `${roleName}è§’è‰²å·²åˆ é™¤`);
    }

    // æ¢å¤é»˜è®¤è®¾ç½®
    function resetRoles() {
      // åˆ é™¤éé»˜è®¤è§’è‰²
      for (const roleId of Object.keys(USER_ROLES)) {
        if (!DEFAULT_ROLES[roleId]) {
          delete USER_ROLES[roleId];
        }
      }
      // æ¢å¤é»˜è®¤è§’è‰²è®¾ç½®
      for (const [roleId, config] of Object.entries(DEFAULT_ROLES)) {
        USER_ROLES[roleId] = JSON.parse(JSON.stringify(config));
      }
      renderRolesList();
      showAlert('success', 'å·²æ¢å¤', 'æ‰€æœ‰è§’è‰²å·²æ¢å¤é»˜è®¤è®¾ç½®');
    }

    // æ˜¾ç¤ºæ·»åŠ è§’è‰²è¡¨å•
    function showAddRoleForm() {
      document.getElementById('addRoleForm').classList.remove('hidden');
      document.getElementById('addRoleBtn').classList.add('hidden');
      // æ¸…ç©ºè¡¨å•
      document.getElementById('newRoleId').value = '';
      document.getElementById('newRoleName').value = '';
      document.getElementById('newRolePassword').value = '';
      document.getElementById('newRoleColor').value = '#8B5CF6';
    }

    // éšè—æ·»åŠ è§’è‰²è¡¨å•
    function hideAddRoleForm() {
      document.getElementById('addRoleForm').classList.add('hidden');
      document.getElementById('addRoleBtn').classList.remove('hidden');
    }

    // åˆ›å»ºæ–°è§’è‰²
    function createNewRole() {
      const roleId = document.getElementById('newRoleId').value.trim().toLowerCase();
      const roleName = document.getElementById('newRoleName').value.trim();
      const password = document.getElementById('newRolePassword').value.trim();
      const color = document.getElementById('newRoleColor').value;

      // éªŒè¯
      if (!roleId) {
        showAlert('error', 'è¯·è¾“å…¥è§’è‰²ID', 'è§’è‰²IDä¸èƒ½ä¸ºç©º');
        return;
      }
      if (!/^[a-z][a-z0-9_]*$/.test(roleId)) {
        showAlert('error', 'IDæ ¼å¼é”™è¯¯', 'è§’è‰²IDå¿…é¡»ä»¥å­—æ¯å¼€å¤´ï¼Œåªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
        return;
      }
      if (USER_ROLES[roleId]) {
        showAlert('error', 'IDå·²å­˜åœ¨', 'è¯¥è§’è‰²IDå·²è¢«ä½¿ç”¨ï¼Œè¯·æ¢ä¸€ä¸ª');
        return;
      }
      if (!roleName) {
        showAlert('error', 'è¯·è¾“å…¥è§’è‰²åç§°', 'è§’è‰²åç§°ä¸èƒ½ä¸ºç©º');
        return;
      }
      if (!password) {
        showAlert('error', 'è¯·è®¾ç½®å¯†ç ', 'ç™»å½•å¯†ç ä¸èƒ½ä¸ºç©º');
        return;
      }
      if (password.length < 6) {
        showAlert('error', 'å¯†ç å¤ªçŸ­', 'å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦');
        return;
      }

      // è·å–æƒé™è®¾ç½®
      const permissions = {
        generate: document.getElementById('newPerm_generate').checked,
        download: document.getElementById('newPerm_download').checked,
        uploadTemplate: document.getElementById('newPerm_uploadTemplate').checked,
        exportImport: document.getElementById('newPerm_exportImport').checked,
        styleSettings: document.getElementById('newPerm_styleSettings').checked,
        advancedEdit: document.getElementById('newPerm_advancedEdit').checked,
        deleteTemplate: document.getElementById('newPerm_deleteTemplate').checked
      };

      // è·å–åˆ°æœŸæ—¶é—´
      const expiryDate = document.getElementById('newRoleExpiry').value || null;

      // é€‰æ‹©å›¾æ ‡ï¼ˆæ ¹æ®æƒé™è‡ªåŠ¨é€‰æ‹©ï¼‰
      let icon = 'fa-user';
      if (permissions.uploadTemplate && permissions.deleteTemplate) {
        icon = 'fa-user-tie';
      } else if (permissions.download) {
        icon = 'fa-user-check';
      } else {
        icon = 'fa-user-clock';
      }

      // åˆ›å»ºæ–°è§’è‰²
      USER_ROLES[roleId] = {
        password: password,
        name: roleName,
        icon: icon,
        color: color,
        enabled: true,
        expiryDate: expiryDate,
        permissions: permissions
      };

      // æ›´æ–°ç•Œé¢
      hideAddRoleForm();
      renderRolesList();
      showAlert('success', 'åˆ›å»ºæˆåŠŸ', `è§’è‰²ã€Œ${roleName}ã€å·²åˆ›å»ºï¼Œå¯†ç ï¼š${password}`);
    }

    // å¯¼å‡ºè§’è‰²é…ç½®
    function exportRolesConfig() {
      const exportData = {};
      for (const [roleId, config] of Object.entries(USER_ROLES)) {
        exportData[roleId] = {
          password: config.password,
          name: config.name,
          icon: config.icon,
          color: config.color,
          enabled: config.enabled !== false,
          expiryDate: config.expiryDate || null,
          permissions: { ...config.permissions }
        };
      }

      const jsonStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = `è§’è‰²é…ç½®_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.json`;
      link.click();

      URL.revokeObjectURL(url);
      showAlert('success', 'å¯¼å‡ºæˆåŠŸ', 'è§’è‰²é…ç½®å·²ä¿å­˜ï¼Œè¯·å¦¥å–„ä¿ç®¡æ­¤æ–‡ä»¶');
    }

    // è§¦å‘å¯¼å…¥è§’è‰²é…ç½®
    function triggerImportRolesConfig() {
      document.getElementById('rolesConfigInput').click();
    }

    // å¯¼å…¥è§’è‰²é…ç½®
    async function importRolesConfig(file) {
      try {
        const text = await file.text();
        const importData = JSON.parse(text);

        if (typeof importData !== 'object' || Array.isArray(importData)) {
          throw new Error('Invalid format');
        }

        // éªŒè¯å¿…é¡»æœ‰ admin è§’è‰²
        if (!importData.admin) {
          showAlert('error', 'é…ç½®æ— æ•ˆ', 'å¿…é¡»åŒ…å«ç®¡ç†å‘˜(admin)è§’è‰²');
          return;
        }

        // æ¸…é™¤ç°æœ‰éé»˜è®¤è§’è‰²
        for (const roleId of Object.keys(USER_ROLES)) {
          if (roleId !== 'admin') {
            delete USER_ROLES[roleId];
          }
        }

        // å¯¼å…¥æ‰€æœ‰è§’è‰²
        let importedCount = 0;
        for (const [roleId, config] of Object.entries(importData)) {
          USER_ROLES[roleId] = {
            password: config.password || 'default123',
            name: config.name || roleId,
            icon: config.icon || 'fa-user',
            color: config.color || '#666666',
            enabled: config.enabled !== false,
            expiryDate: config.expiryDate || null,
            permissions: config.permissions || {
              generate: true,
              download: false,
              uploadTemplate: false,
              exportImport: false,
              styleSettings: false,
              advancedEdit: false,
              deleteTemplate: false
            }
          };
          importedCount++;
        }

        renderRolesList();
        showAlert('success', 'å¯¼å…¥æˆåŠŸ', `å·²å¯¼å…¥ ${importedCount} ä¸ªè§’è‰²é…ç½®`);

      } catch (error) {
        console.error('Import roles error:', error);
        showAlert('error', 'å¯¼å…¥å¤±è´¥', 'æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
      }
    }

    // Configure PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Dark mode
    if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      document.documentElement.classList.toggle('dark', e.matches);
    });

    // Toggle dark mode manually
    function toggleDarkMode() {
      document.documentElement.classList.toggle('dark');
    }

    // Fonts
    const fonts = [
      // åŸºç¡€å­—ä½“ (Web Fonts)
      { id: 'noto-sans', name: 'æ€æºé»‘ä½“', family: '"Noto Sans SC", sans-serif' },
      { id: 'noto-serif', name: 'æ€æºå®‹ä½“', family: '"Noto Serif SC", serif' },
      { id: 'xiaowei', name: 'ç«™é…·å°è–‡', family: '"ZCOOL XiaoWei", serif' },
      { id: 'kuaile', name: 'ç«™é…·å¿«ä¹', family: '"ZCOOL KuaiLe", cursive' },
      { id: 'qingke', name: 'åº†ç§‘é»„æ²¹', family: '"ZCOOL QingKe HuangYou", cursive' },
      { id: 'mashan', name: 'é©¬å–„æ”¿æ¥·', family: '"Ma Shan Zheng", cursive' },
      { id: 'liujian', name: 'åˆ˜å»ºæ¯›è‰', family: '"Liu Jian Mao Cao", cursive' },
      { id: 'longcang', name: 'é¾™è—ä½“', family: '"Long Cang", cursive' },
      { id: 'zhimang', name: 'å¿—èŠ’æ˜Ÿ', family: '"Zhi Mang Xing", cursive' },
      { id: 'system-hei', name: 'å¾®è½¯é›…é»‘', family: '"Microsoft YaHei", sans-serif' },
      { id: 'system-kai', name: 'æ¥·ä½“', family: 'KaiTi, serif' },
      // è‰ºæœ¯é»‘ä½“ç³»åˆ—
      { id: 'lifang', name: 'åŠ›æ–¹ä½“', family: '"åŠ›æ–¹ä½“", "Noto Sans SC", sans-serif' },
      { id: 'jiamu', name: 'å˜‰æœ¨ä½“', family: '"å˜‰æœ¨ä½“", "Noto Sans SC", sans-serif' },
      { id: 'xinyi', name: 'æ–°è‰ºä½“', family: '"æ–°è‰ºä½“", "Noto Sans SC", sans-serif' },
      { id: 'jianheicu', name: 'ç®€é»‘ç²—', family: '"ç®€é»‘ç²—", "Noto Sans SC", sans-serif' },
      { id: 'pangdun', name: 'èƒ–å¢©ä½“', family: '"èƒ–å¢©ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'legao', name: 'ä¹é«˜ä½“', family: '"ä¹é«˜ä½“", "Noto Sans SC", sans-serif' },
      { id: 'fengmang', name: 'é”‹èŠ’ä½“', family: '"é”‹èŠ’ä½“", "Noto Sans SC", sans-serif' },
      { id: 'shaonian', name: 'å°‘å¹´ä½“', family: '"å°‘å¹´ä½“", "Noto Sans SC", sans-serif' },
      { id: 'yifei', name: 'é€¸é£ä½“', family: '"é€¸é£ä½“", "Noto Sans SC", sans-serif' },
      { id: 'bohan', name: 'åšç€šä½“', family: '"åšç€šä½“", "Noto Sans SC", sans-serif' },
      { id: 'menghei', name: 'æ¢¦é»‘ä½“', family: '"æ¢¦é»‘ä½“", "Noto Sans SC", sans-serif' },
      { id: 'cangqiong', name: 'è‹ç©¹ä½“', family: '"è‹ç©¹ä½“", "Noto Sans SC", sans-serif' },
      { id: 'heifeng', name: 'é»‘é£ä½“', family: '"é»‘é£ä½“", "Noto Sans SC", sans-serif' },
      { id: 'heiyan', name: 'é»‘å²©ä½“', family: '"é»‘å²©ä½“", "Noto Sans SC", sans-serif' },
      { id: 'yanhei', name: 'è¨€é»‘ä½“', family: '"è¨€é»‘ä½“", "Noto Sans SC", sans-serif' },
      { id: 'wushihei', name: 'æ­¦å£«é»‘', family: '"æ­¦å£«é»‘", "Noto Sans SC", sans-serif' },
      // å›½æ½®é£æ ¼ç³»åˆ—
      { id: 'guochao', name: 'å›½æ½®ä½“', family: '"å›½æ½®ä½“", "ZCOOL QingKe HuangYou", cursive' },
      { id: 'sanguo', name: 'ä¸‰å›½ä½“', family: '"ä¸‰å›½ä½“", "Ma Shan Zheng", cursive' },
      { id: 'zhanren', name: 'æˆ˜åˆƒä½“', family: '"æˆ˜åˆƒä½“", "Noto Sans SC", sans-serif' },
      { id: 'zhanji', name: 'æˆ˜æˆŸä½“', family: '"æˆ˜æˆŸä½“", "Noto Sans SC", sans-serif' },
      { id: 'shanhe', name: 'å±±æ²³ä½“', family: '"å±±æ²³ä½“", "Noto Serif SC", serif' },
      { id: 'shanchuan', name: 'å±±å·ä½“', family: '"å±±å·ä½“", "Noto Serif SC", serif' },
      { id: 'kunlun', name: 'æ˜†ä»‘ä½“', family: '"æ˜†ä»‘ä½“", "Noto Serif SC", serif' },
      { id: 'qiankun', name: 'ä¹¾å¤ä½“', family: '"ä¹¾å¤ä½“", "Noto Sans SC", sans-serif' },
      { id: 'changcheng', name: 'é•¿åŸä½“', family: '"é•¿åŸä½“", "Noto Sans SC", sans-serif' },
      { id: 'jingang', name: 'é‡‘åˆšä½“', family: '"é‡‘åˆšä½“", "Noto Sans SC", sans-serif' },
      { id: 'huxiao', name: 'è™å•¸ä½“', family: '"è™å•¸ä½“", "Noto Sans SC", sans-serif' },
      // å®‹ä½“/æ¥·ä½“ç³»åˆ—
      { id: 'yusong', name: 'å¾¡å®‹ä½“', family: '"å¾¡å®‹ä½“", "Noto Serif SC", serif' },
      { id: 'xuansong', name: 'è½©å®‹ä½“', family: '"è½©å®‹ä½“", "Noto Serif SC", serif' },
      { id: 'guosong', name: 'å›½å®‹ä½“', family: '"å›½å®‹ä½“", "Noto Serif SC", serif' },
      { id: 'jinsong', name: 'é”¦å®‹ä½“', family: '"é”¦å®‹ä½“", "Noto Serif SC", serif' },
      { id: 'xiansong', name: 'çº¤å®‹ä½“', family: '"çº¤å®‹ä½“", "Noto Serif SC", serif' },
      { id: 'kesong', name: 'åˆ»å®‹ä½“', family: '"åˆ»å®‹ä½“", "Noto Serif SC", serif' },
      { id: 'liesong', name: 'çƒˆå®‹ä½“', family: '"çƒˆå®‹ä½“", "Noto Serif SC", serif' },
      { id: 'diansong', name: 'å…¸å®‹ä½“', family: '"å…¸å®‹ä½“", "Noto Serif SC", serif' },
      { id: 'gusong', name: 'å¤å®‹ä½“', family: '"å¤å®‹ä½“", "Noto Serif SC", serif' },
      { id: 'beikai', name: 'ç¢‘æ¥·ä½“', family: '"ç¢‘æ¥·ä½“", KaiTi, serif' },
      { id: 'cukai', name: 'ç²—æ¥·ä½“', family: '"ç²—æ¥·ä½“", KaiTi, serif' },
      // å¯çˆ±/åœ†ä½“ç³»åˆ—
      { id: 'xiongmao', name: 'ç†ŠçŒ«ä½“', family: '"ç†ŠçŒ«ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'yiyuan', name: 'è‰ºåœ†ä½“', family: '"è‰ºåœ†ä½“", "Noto Sans SC", sans-serif' },
      { id: 'yuyuan', name: 'èŠ‹åœ†ä½“', family: '"èŠ‹åœ†ä½“", "Noto Sans SC", sans-serif' },
      { id: 'mengdong', name: 'èŒåŠ¨ä½“', family: '"èŒåŠ¨ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'miaowei', name: 'å–µå°¾ä½“', family: '"å–µå°¾ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'qupao', name: 'è¶£æ³¡ä½“', family: '"è¶£æ³¡ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'yuandun', name: 'åœ†ç›¾ä½“', family: '"åœ†ç›¾ä½“", "Noto Sans SC", sans-serif' },
      { id: 'yunrun', name: 'äº‘æ¶¦ä½“', family: '"äº‘æ¶¦ä½“", "Noto Sans SC", sans-serif' },
      // æ‰‹å†™/è‰ºæœ¯ç³»åˆ—
      { id: 'fenbi', name: 'ç²‰ç¬”ä½“', family: '"ç²‰ç¬”ä½“", "ZCOOL XiaoWei", serif' },
      { id: 'shouhua', name: 'æ‰‹åˆ·ä½“', family: '"æ‰‹åˆ·ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'xingchen', name: 'æ˜Ÿè¾°ä½“', family: '"æ˜Ÿè¾°ä½“", "Noto Sans SC", sans-serif' },
      { id: 'xingmang', name: 'æ˜ŸèŠ’ä½“', family: '"æ˜ŸèŠ’ä½“", "Noto Sans SC", sans-serif' },
      { id: 'xingji', name: 'æ˜Ÿé™…ä½“', family: '"æ˜Ÿé™…ä½“", "Noto Sans SC", sans-serif' },
      { id: 'xingyao', name: 'æ˜Ÿè€€ä½“', family: '"æ˜Ÿè€€ä½“", "Noto Sans SC", sans-serif' },
      { id: 'yixing', name: 'å¥•æ˜Ÿä½“', family: '"å¥•æ˜Ÿä½“", "Noto Sans SC", sans-serif' },
      { id: 'xiaoyao', name: 'é€é¥ä½“', family: '"é€é¥ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'hongzhi', name: 'é¸¿å¿—ä½“', family: '"é¸¿å¿—ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'shaohua', name: 'éŸ¶åä½“', family: '"éŸ¶åä½“", "ZCOOL XiaoWei", serif' },
      // ç‰¹è‰²é£æ ¼ç³»åˆ—
      { id: 'gete', name: 'å“¥ç‰¹ä½“', family: '"å“¥ç‰¹ä½“", "Noto Sans SC", sans-serif' },
      { id: 'xuanzang', name: 'ç„è—ä½“', family: '"ç„è—ä½“", "Ma Shan Zheng", cursive' },
      { id: 'hefeng', name: 'å’Œé£ä½“', family: '"å’Œé£ä½“", "Noto Sans SC", sans-serif' },
      { id: 'yingfeng', name: 'è¿é£ä½“', family: '"è¿é£ä½“", "Noto Sans SC", sans-serif' },
      { id: 'taikong', name: 'å¤ªç©ºä½“', family: '"å¤ªç©ºä½“", "Noto Sans SC", sans-serif' },
      { id: 'xiamu', name: 'å¤æœ¨ä½“', family: '"å¤æœ¨ä½“", "ZCOOL XiaoWei", serif' },
      { id: 'zhenya', name: 'æ­£é›…ä½“', family: '"æ­£é›…ä½“", "Noto Serif SC", serif' },
      { id: 'ruifeng', name: 'é”é”‹ä½“', family: '"é”é”‹ä½“", "Noto Sans SC", sans-serif' },
      { id: 'shengzun', name: 'åœ£å°Šä½“', family: '"åœ£å°Šä½“", "Ma Shan Zheng", cursive' },
      { id: 'moyun', name: 'æ¼ äº‘ä½“', family: '"æ¼ äº‘ä½“", "Noto Sans SC", sans-serif' },
      { id: 'kufang', name: 'é…·æ–¹ä½“', family: '"é…·æ–¹ä½“", "Noto Sans SC", sans-serif' },
      { id: 'yuli', name: 'ç‰ç«‹ä½“', family: '"ç‰ç«‹ä½“", "Noto Serif SC", serif' },
      // å•†åŠ¡/æ­£å¼ç³»åˆ—
      { id: 'yuanzheng', name: 'å…ƒæ­£ä½“', family: '"å…ƒæ­£ä½“", "Noto Sans SC", sans-serif' },
      { id: 'kuanyan', name: 'å®½è¨€ä½“', family: '"å®½è¨€ä½“", "Noto Sans SC", sans-serif' },
      { id: 'luoma', name: 'ç½—é©¬ä½“', family: '"ç½—é©¬ä½“", "Noto Serif SC", serif' },
      { id: 'kufeng', name: 'é…·å³°ä½“', family: '"ï¿½ï¿½ï¿½å³°ä½“", "Noto Sans SC", sans-serif' },
      { id: 'ruyi', name: 'å¦‚æ„ä½“', family: '"å¦‚æ„ä½“", "Noto Serif SC", serif' },
      { id: 'yinfu', name: 'éŸ³ç¬¦ä½“', family: '"éŸ³ç¬¦ä½“", "Noto Sans SC", sans-serif' },
      { id: 'xuanzheng', name: 'è½©æ­£ä½“', family: '"è½©æ­£ä½“", "Noto Sans SC", sans-serif' },
      { id: 'yifang', name: 'å£¹æ–¹ä½“', family: '"å£¹æ–¹ä½“", "Noto Sans SC", sans-serif' },
      { id: 'fangzhou', name: 'æ–¹èˆŸä½“', family: '"æ–¹èˆŸä½“", "Noto Sans SC", sans-serif' },
      { id: 'aoding', name: 'å¥¥ä¸ä½“', family: '"å¥¥ä¸ä½“", "Noto Sans SC", sans-serif' },
      { id: 'zhuangyuan', name: 'çŠ¶å…ƒä½“', family: '"çŠ¶å…ƒä½“", "Noto Serif SC", serif' },
      { id: 'yanwei', name: 'ç‡•å°¾ä½“', family: '"ç‡•å°¾ä½“", "Noto Serif SC", serif' },
      { id: 'songyu', name: 'æ¾ç¾½ä½“', family: '"æ¾ç¾½ä½“", "Noto Sans SC", sans-serif' },
      { id: 'jianmo', name: 'ç®€å¢¨ä½“', family: '"ç®€å¢¨ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'benke', name: 'æœ¬åˆ»ä½“', family: '"æœ¬åˆ»ä½“", "Noto Serif SC", serif' },
      { id: 'zheyan', name: 'æŠ˜è¨€ä½“', family: '"æŠ˜è¨€ä½“", "Noto Sans SC", sans-serif' },
      // ä¸ªæ€§å­—ä½“ç³»åˆ—
      { id: 'tingyati', name: 'å©·é›…ä½“', family: '"å©·é›…ä½“", "ZCOOL XiaoWei", serif' },
      { id: 'xiha', name: 'å˜»å“ˆä½“', family: '"å˜»å“ˆä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'yuanqi', name: 'å…ƒæ°”ä½“', family: '"å…ƒæ°”ä½“", "ZCOOL KuaiLe", cursive' },
      // æ–°å¢å­—ä½“ç³»åˆ—ä¸€
      { id: 'yongganhei', name: 'å‹‡æ•¢é»‘', family: '"å‹‡æ•¢é»‘", "Noto Sans SC", sans-serif' },
      { id: 'deyihei', name: 'å¾—æ„é»‘', family: '"å¾—æ„é»‘", "Noto Sans SC", sans-serif' },
      { id: 'teheiti', name: 'ç‰¹é»‘ä½“', family: '"ç‰¹é»‘ä½“", "Noto Sans SC", sans-serif' },
      { id: 'xiti', name: 'ç»†ä½“', family: '"ç»†ä½“", "Noto Sans SC", sans-serif' },
      { id: 'yongsongti', name: 'å’å®‹ä½“', family: '"å’å®‹ä½“", "Noto Serif SC", serif' },
      { id: 'xinqingnian', name: 'æ–°é’å¹´', family: '"æ–°é’å¹´", "Noto Sans SC", sans-serif' },
      { id: 'huimoti', name: 'æŒ¥å¢¨ä½“', family: '"æŒ¥å¢¨ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'houxiandai', name: 'åç°ä»£ä½“', family: '"åç°ä»£ä½“", "Noto Sans SC", sans-serif' },
      // æ–°å¢å­—ä½“ç³»åˆ—äºŒ - æ´»å­—/å®‹ä½“ç³»åˆ—
      { id: 'hanchanhuokai', name: 'å¯’è‰æ´»æ¥·ä½“', family: '"å¯’è‰æ´»æ¥·ä½“", KaiTi, serif' },
      { id: 'hanchanhuofang', name: 'å¯’è‰æ´»ä»¿å®‹', family: '"å¯’è‰æ´»ä»¿å®‹", "Noto Serif SC", serif' },
      { id: 'jinghualaosong', name: 'äº¬åè€å®‹ä½“', family: '"äº¬åè€å®‹ä½“", "Noto Serif SC", serif' },
      { id: 'huiwenmingchao', name: 'æ±‡æ–‡æ˜æœä½“', family: '"æ±‡æ–‡æ˜æœä½“", "Noto Serif SC", serif' },
      { id: 'huiwenganghei', name: 'æ±‡æ–‡æ¸¯é»‘ä½“', family: '"æ±‡æ–‡æ¸¯é»‘ä½“", "Noto Sans SC", sans-serif' },
      { id: 'yufanxinyu', name: 'ä½™ç¹æ–°è¯­ä½“', family: '"ä½™ç¹æ–°è¯­ä½“", "Noto Sans SC", sans-serif' },
      { id: 'zhulangmengnai', name: 'é€æµªèŒå¥¶ä½“', family: '"é€æµªèŒå¥¶ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'ziwangetehei', name: 'å“¥ç‰¹é»‘ç™½æ— å¸¸', family: '"å­—ç©å“¥ç‰¹é»‘ç™½æ— å¸¸ä½“", "Noto Sans SC", sans-serif' },
      { id: 'luyaming', name: 'æ»·é›…æ˜ä½“', family: '"æ»·é›…æ˜ä½“", "Noto Serif SC", serif' },
      { id: 'cangerfeibai', name: 'è‹è€³éç™½ä½“', family: '"è‹è€³éç™½ä½“", "Noto Sans SC", sans-serif' },
      { id: 'linhailishu', name: 'ä¸´æµ·éš¶ä¹¦', family: '"ä¸´æµ·éš¶ä¹¦", "Noto Serif SC", serif' },
      { id: 'xiangcuidengcusong', name: 'é¦™èƒç­‰ç²—å®‹', family: '"é¦™èƒç­‰ç²—å®‹", "Noto Serif SC", serif' },
      { id: 'xiangcuilingduhei', name: 'é¦™èƒé›¶åº¦é»‘', family: '"é¦™èƒé›¶åº¦é»‘", "Noto Sans SC", sans-serif' },
      { id: 'xiangganminjian', name: 'é¦™æ¸¯æ°‘é—´å­—é›†', family: '"é¦™æ¸¯æ°‘é—´å­—é›†", "Noto Sans TC", sans-serif' },
      { id: 'siyuansong', name: 'æ€æºå®‹ï¿½ï¿½ï¿½', family: '"Noto Serif SC", serif' },
      { id: 'xinyugongpinbo', name: 'æ–°æ„šå…¬æ‹¼æä½“', family: '"æ–°æ„šå…¬æ‹¼æä½“", "Noto Sans SC", sans-serif' },
      { id: 'chuangketiejingang', name: 'åˆ›å®¢è´´é‡‘åˆšä½“', family: '"åˆ›å®¢è´´é‡‘åˆšä½“", "Noto Sans SC", sans-serif' },
      { id: 'zikutaqitezhandui', name: 'å­—åº“å¡”å¥‡ç‰¹æˆ˜é˜Ÿ', family: '"å­—åº“å¡”å¥‡ç‰¹æˆ˜é˜Ÿ", "Noto Sans SC", sans-serif' },
      { id: 'qingkongmingchaothin', name: 'æ™´ç©ºæ˜æœThin', family: '"æ™´ç©ºæ˜æœThin", "Noto Serif SC", serif' },
      { id: 'namikongxinghei', name: 'çº³ç±³ç©ºå‹é»‘', family: '"çº³ç±³ç©ºå‹é»‘", "Noto Sans SC", sans-serif' },
      { id: 'ximaixihuanti', name: 'å–œè„‰å–œæ¬¢ä½“', family: '"å–œè„‰å–œæ¬¢ä½“", "ZCOOL KuaiLe", cursive' },
      // æ–°å¢å­—ä½“ç³»åˆ—ä¸‰ - æ–¹æ­£/è…¾ç¥¥ç³»åˆ—
      { id: 'fzlantingtehei', name: 'æ–¹æ­£å…°äº­ç‰¹é»‘', family: '"æ–¹æ­£å…°äº­ç‰¹é»‘", "Noto Sans SC", sans-serif' },
      { id: 'tengxiangjialishuanghei', name: 'è…¾ç¥¥å˜‰ä¸½çº¿é»‘', family: '"è…¾ç¥¥å˜‰ä¸½çº¿é»‘ç®€ä½“", "Noto Sans SC", sans-serif' },
      { id: 'jiangxizhuokai', name: 'æ±Ÿè¥¿æ‹™æ¥·ä½“', family: '"æ±Ÿè¥¿æ‹™æ¥·ä½“", KaiTi, serif' },
      { id: 'xiquezhaopai', name: 'å–œé¹Šæ‹›ç‰Œä½“', family: '"å–œé¹Šæ‹›ç‰Œä½“", "Noto Sans SC", sans-serif' },
      { id: 'wenyuehouxiandai', name: 'æ–‡æ‚¦åç°ä»£ä½“', family: '"æ–‡æ‚¦åç°ä»£ä½“", "Noto Sans SC", sans-serif' },
      { id: 'zhejianminjianshuke', name: 'æµ™æ±Ÿæ°‘é—´ä¹¦åˆ»', family: '"æµ™æ±Ÿæ°‘é—´ä¹¦åˆ»ä½“", "Noto Serif SC", serif' },
      // è‹±æ–‡å­—ä½“ç³»åˆ— (English Fonts)
      { id: 'rubik-bubbles', name: 'Rubik Bubbles', family: '"Rubik Bubbles", cursive' },
      { id: 'rubik-bold-italic', name: 'Rubik Bold Italic', family: '"Rubik", sans-serif' },
      { id: 'playfair-display', name: 'Playfair Display', family: '"Playfair Display", serif' },
      { id: 'amelina', name: 'Amelina', family: '"Amelina", cursive' },
      { id: 'nunito', name: 'Nunito Semibold', family: '"Nunito", sans-serif' },
      { id: 'tondu', name: 'Tondu', family: '"Tondu", sans-serif' },
      { id: 'yay', name: 'Yay!', family: '"Yay", cursive' },
      { id: 'aidan-signature', name: 'Aidan Signature', family: '"Aidan Signature", cursive' },
      { id: 'thinoo-thin', name: 'Thinoo Thin', family: '"Thinoo Thin", sans-serif' },
      { id: 'hey-november', name: 'Hey November', family: '"Hey November", cursive' },
      { id: 'love-light', name: 'Love Light', family: '"Love Light", cursive' },
      { id: 'arizonia', name: 'Arizonia', family: '"Arizonia", cursive' },
      { id: 'henny-penny', name: 'Henny Penny', family: '"Henny Penny", cursive' },
      { id: 'oi', name: 'Oi', family: '"Oi", cursive' },
      { id: 'chomsky', name: 'Chomsky', family: '"Chomsky", serif' },
      { id: 'cinzel', name: 'Cinzel', family: '"Cinzel", serif' },
      { id: 'shrikhand', name: 'Shrikhand', family: '"Shrikhand", cursive' },
      { id: 'ticking-timebomb', name: 'Ticking Timebomb', family: '"Ticking TimebombBB-Italic", cursive' },
      // æ±‰ä»ªç³»åˆ—å­—ä½“
      { id: 'hynuomituan', name: 'æ±‰ä»ªç³¯ç±³å›¢', family: '"æ±‰ä»ªç³¯ç±³å›¢", "ZCOOL KuaiLe", cursive' },
      { id: 'hyzhuzishudaixiong', name: 'æ±‰ä»ªé“¸å­—æ ‘è¢‹ç†Š', family: '"æ±‰ä»ªé“¸å­—æ ‘è¢‹ç†Š", "ZCOOL KuaiLe", cursive' },
      { id: 'hyzhuzitongnianti', name: 'æ±‰ä»ªé“¸å­—ç«¥å¹´ä½“', family: '"æ±‰ä»ªé“¸å­—ç«¥å¹´ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'hyqiqiaoban', name: 'æ±‰ä»ªä¸ƒå·§æ¿', family: '"æ±‰ä»ªä¸ƒå·§æ¿", "Noto Sans SC", sans-serif' },
      { id: 'hyniunaitusi', name: 'æ±‰ä»ªç‰›å¥¶åå¸', family: '"æ±‰ä»ªç‰›å¥¶åå¸", "ZCOOL KuaiLe", cursive' },
      { id: 'hytuantuanyuanyuan', name: 'æ±‰ä»ªå›¢å›¢åœ†åœ†', family: '"æ±‰ä»ªå›¢å›¢åœ†åœ†", "ZCOOL KuaiLe", cursive' },
      { id: 'hytaijiti', name: 'æ±‰ä»ªå¤ªæä½“ç®€', family: '"æ±‰ä»ªå¤ªæä½“ç®€", "Ma Shan Zheng", cursive' },
      { id: 'hychaocuheijian', name: 'æ±‰ä»ªè¶…ç²—é»‘ç®€', family: '"æ±‰ï¿½ï¿½ï¿½è¶…ç²—é»‘ç®€", "Noto Sans SC", sans-serif' },
      { id: 'hyzhonglishujian', name: 'æ±‰ä»ªä¸­éš¶ä¹¦ç®€', family: '"æ±‰ä»ªä¸­éš¶ä¹¦ç®€", "Noto Serif SC", serif' },
      { id: 'hytiantianquan', name: 'æ±‰ä»ªç”œç”œåœˆ', family: '"æ±‰ä»ªç”œç”œåœˆ", "ZCOOL KuaiLe", cursive' },
      { id: 'hybaiqingtijian', name: 'æ±‰ä»ªæŸé’ä½“ç®€', family: '"æ±‰ä»ªæŸé’ä½“ç®€", "Noto Sans SC", sans-serif' },
      { id: 'hymanbuti', name: 'æ±‰ä»ªæ¼«æ­¥ä½“ç®€', family: '"æ±‰ä»ªæ¼«æ­¥ä½“ç®€", "Liu Jian Mao Cao", cursive' },
      // ååº·ç³»åˆ—å­—ä½“
      { id: 'hkpop', name: 'ååº·POP', family: '"ååº·POP", "ZCOOL KuaiLe", cursive' },
      { id: 'hkwawa', name: 'ååº·å¨ƒå¨ƒä½“', family: '"ååº·å¨ƒå¨ƒä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'hkhaibao', name: 'ååº·æµ·æŠ¥ä½“', family: '"ååº·æµ·æŠ¥ä½“", "Noto Sans SC", sans-serif' },
      { id: 'hkshaonv', name: 'ååº·å°‘å¥³æ–‡å­—', family: '"ååº·å°‘å¥³æ–‡å­—", "ZCOOL KuaiLe", cursive' },
      // æ–¹æ­£ç³»åˆ—å­—ä½“
      { id: 'fzhupojian', name: 'æ–¹æ­£ç¥ç€ç®€ä½“', family: '"æ–¹æ­£ç¥ç€ç®€ä½“", "Noto Sans SC", sans-serif' },
      { id: 'fzdahei', name: 'æ–¹æ­£å¤§é»‘', family: '"æ–¹æ­£å¤§é»‘", "Noto Sans SC", sans-serif' },
      { id: 'fzxingkai', name: 'æ–¹æ­£è¡Œæ¥·', family: '"æ–¹æ­£è¡Œæ¥·", KaiTi, serif' },
      { id: 'fzxiaobiaosong', name: 'æ–¹æ­£å°æ ‡å®‹', family: '"æ–¹æ­£å°æ ‡å®‹", "Noto Serif SC", serif' },
      { id: 'fzshoujinshu', name: 'æ–¹æ­£ç˜¦é‡‘ä¹¦ç®€ä½“', family: '"æ–¹æ­£ç˜¦é‡‘ä¹¦ç®€ä½“", "Noto Serif SC", serif' },
      { id: 'fzzhiyi', name: 'æ–¹æ­£ç¨šè‰ºç®€ä½“', family: '"æ–¹æ­£ç¨šè‰ºç®€ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'fzyingbikai', name: 'æ–¹æ­£ç¡¬ç¬”æ¥·ä¹¦', family: '"æ–¹æ­£ç¡¬ç¬”æ¥·ä¹¦", KaiTi, serif' },
      // ä¸Šé¦–ç³»åˆ—å­—ä½“
      { id: 'sscangqiongshufa', name: 'ä¸Šé¦–è‹ç©¹ä¹¦æ³•ä½“', family: '"ä¸Šé¦–è‹ç©¹ä¹¦æ³•ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'ssxindong', name: 'ä¸Šé¦–å¿ƒåŠ¨ä½“', family: '"ä¸Šé¦–å¿ƒåŠ¨ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'sstuya', name: 'ä¸Šé¦–æ¶‚é¸¦ä½“', family: '"ä¸Šé¦–æ¶‚é¸¦ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'ssfangtang', name: 'ä¸Šé¦–æ–¹ç³–ä½“', family: '"ä¸Šé¦–æ–¹ç³–ä½“", "ZCOOL KuaiLe", cursive' },
      // é€ å­—å·¥æˆ¿ç³»åˆ—
      { id: 'zzgfsuhei', name: 'é€ å­—å·¥æˆ¿ç´ é»‘ä½“', family: '"é€ å­—å·¥æˆ¿ç´ é»‘ä½“", "Noto Sans SC", sans-serif' },
      { id: 'zzgfzhixiasenlin', name: 'é€ å­—å·¥æˆ¿çŸ¥å¤æ£®æ—', family: '"é€ å­—å·¥æˆ¿çŸ¥å¤æ£®æ—ä½“", "ZCOOL XiaoWei", serif' },
      // å…¶ä»–å¯çˆ±/è‰ºæœ¯å­—ä½“
      { id: 'dianzimanhei', name: 'ç‚¹å­—æ¼«é»‘', family: '"ç‚¹å­—æ¼«é»‘", "Noto Sans SC", sans-serif' },
      { id: 'benmojinsong', name: 'æœ¬å¢¨ä»Šå®‹', family: '"æœ¬å¢¨ä»Šå®‹", "Noto Serif SC", serif' },
      { id: 'mailafengxingchen', name: 'éº¦æ‹‰é£æ˜Ÿè¾°ä½“', family: '"éº¦æ‹‰é£æ˜Ÿè¾°ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'yixuesong', name: 'æ„é›ªæ¾ä½“', family: '"æ„é›ªæ¾ä½“", "Noto Serif SC", serif' },
      { id: 'miaobukeyan', name: 'å–µä¸å¯è¨€', family: '"å–µä¸å¯è¨€", "ZCOOL KuaiLe", cursive' },
      { id: 'erziyuanxinyou', name: 'äºŒå­—å…ƒå¿ƒæ¸¸æ‰‹ç»˜', family: '"äºŒå­—å…ƒå¿ƒæ¸¸æ‰‹ç»˜", "ZCOOL KuaiLe", cursive' },
      { id: 'wenshuaixiaokeai', name: 'æ¸©å¸…å°å¯çˆ±', family: '"æ¸©å¸…å°å¯çˆ±", "ZCOOL KuaiLe", cursive' },
      { id: 'miaomengmeng', name: 'æç»˜ç€é‚£åœºç¾æ¢¦', family: '"æç»˜ç€é‚£åœºç¾æ¢¦", cursive' },
      { id: 'xingyelangman', name: 'æ˜Ÿå¤œæµªæ¼«å®‡å®™æ¸©æŸ”', family: '"æ˜Ÿå¤œæµªæ¼«å®‡å®™æ¸©æŸ”", cursive' },
      // å­—é­‚/å­—çµ/å­—è¯­ç³»åˆ—æ‰‹å†™å­—ä½“
      { id: 'zxhcanglanxingkai', name: 'å­—å°é­‚æ²§æµªè¡Œæ¥·', family: '"å­—å°é­‚æ²§æµªè¡Œæ¥·", "Liu Jian Mao Cao", cursive' },
      { id: 'zyyunmengshoushu', name: 'å­—è¯­äº‘æ¢¦æ‰‹ä¹¦', family: '"å­—è¯­äº‘æ¢¦æ‰‹ä¹¦", "Liu Jian Mao Cao", cursive' },
      { id: 'zququinghe', name: 'å­—è¶£æ¸…è·ä½“', family: '"å­—è¶£æ¸…è·ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'zxhfuyaoshoushu', name: 'å­—å°é­‚æ‰¶æ‘‡æ‰‹ä¹¦', family: '"å­—å°é­‚æ‰¶æ‘‡æ‰‹ä¹¦", "Liu Jian Mao Cao", cursive' },
      { id: 'eyfenghuangshoushu', name: 'å°”é›…å‡¤å‡°æ‰‹ä¹¦', family: '"å°”é›…å‡¤å‡°æ‰‹ä¹¦", "Liu Jian Mao Cao", cursive' },
      { id: 'zwnvxialiangyu', name: 'å­—ç©å¥³ä¾ è‰¯ç‰', family: '"å­—ç©å¥³ä¾ è‰¯ç‰-é—ªä¼ ç¥", "Liu Jian Mao Cao", cursive' },
      { id: 'zlyufeng', name: 'å­—çµå¾¡é£ä½“', family: '"å­—çµå¾¡é£ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'zlfengyunshoushu', name: 'å­—çµé£äº‘æ‰‹ä¹¦', family: '"å­—çµé£äº‘æ‰‹ä¹¦", "Liu Jian Mao Cao", cursive' },
      { id: 'zlxiaosong', name: 'å­—çµå°æ·ä½“', family: '"å­—çµå°æ·ä½“", "Noto Sans SC", sans-serif' },
      { id: 'hongdouzhiqingchun', name: 'çº¢è±†è‡´é’æ˜¥', family: '"çº¢è±†è‡´é’æ˜¥", "Noto Serif SC", serif' },
      { id: 'zlbaihuashoushu', name: 'å­—çµç™¾èŠ±æ‰‹ä¹¦', family: '"å­—çµç™¾èŠ±æ‰‹ä¹¦", "Liu Jian Mao Cao", cursive' },
      { id: 'zyqingwuti', name: 'å­—è¯­è½»èˆä½“', family: '"å­—è¯­è½»èˆä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'zlruyixingkai', name: 'å­—çµå¦‚æ„è¡Œæ¥·', family: '"å­—çµå¦‚æ„è¡Œæ¥·", "Liu Jian Mao Cao", cursive' },
      { id: 'zlqingyunshoushu', name: 'å­—çµé’äº‘æ‰‹ä¹¦', family: '"å­—çµé’äº‘æ‰‹ä¹¦", "Liu Jian Mao Cao", cursive' },
      { id: 'duanningmaobixiaokai', name: 'æ®µå®æ¯›ç¬”å°æ¥·', family: '"æ®µå®æ¯›ç¬”å°æ¥·", "Ma Shan Zheng", cursive' },
      { id: 'zhundanfengshoushu', name: 'å­—é­‚ä¸¹æ«æ‰‹ä¹¦', family: '"å­—é­‚ä¸¹æ«æ‰‹ä¹¦", "Liu Jian Mao Cao", cursive' },
      { id: 'yizhiqingshu', name: 'ä¸€çº¸æƒ…ä¹¦', family: '"ä¸€çº¸æƒ…ä¹¦", "Liu Jian Mao Cao", cursive' },
      { id: 'momohaijingshouji', name: 'é»˜é™Œæµ·é²¸æ‰‹è¿¹', family: '"é»˜é™Œæµ·é²¸æ‰‹è¿¹", "Liu Jian Mao Cao", cursive' },
      { id: 'hefengshudao', name: 'å’Œé£ä¹¦é“æ˜­å’Œé£é¾™', family: '"å’Œé£ä¹¦é“æ˜­å’Œé£é¾™ä½“-é—ª", "Liu Jian Mao Cao", cursive' },
      { id: 'geyixiaoshouji', name: 'æ­Œä»¥æ™“æ‰‹è¿¹è¡Œæ¥·', family: '"æ­Œä»¥æ™“æ‰‹è¿¹è¡Œæ¥·ä½“", "Liu Jian Mao Cao", cursive' },
      // æ›´å¤šè‰ºæœ¯è®¾è®¡å­—ä½“
      { id: 'ruantang', name: 'è½¯ç³–ä½“', family: '"è½¯ç³–ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'buding', name: 'å¸ƒä¸ä½“', family: '"å¸ƒä¸ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'jianyuanti', name: 'ç®€åœ†ä½“', family: '"ç®€åœ†ä½“", "Noto Sans SC", sans-serif' },
      { id: 'chuanqi', name: 'ä¼ å¥‡ä½“', family: '"ä¼ å¥‡ä½“", "Noto Sans SC", sans-serif' },
      { id: 'jiansongxi', name: 'ç®€å®‹ç»†', family: '"ç®€å®‹ç»†", "Noto Serif SC", serif' },
      { id: 'jianheiji', name: 'ç®€é»‘æ', family: '"ç®€é»‘æ", "Noto Sans SC", sans-serif' },
      { id: 'lingfengti', name: 'å‡Œé£ä½“', family: '"å‡Œé£ä½“", "Noto Sans SC", sans-serif' },
      { id: 'dunheiti', name: 'é’é»‘ä½“', family: '"é’é»‘ä½“", "Noto Sans SC", sans-serif' },
      { id: 'ruiyuanti', name: 'é”åœ†ä½“', family: '"é”åœ†ä½“", "Noto Sans SC", sans-serif' },
      { id: 'runheiti', name: 'æ¶¦é»‘ä½“', family: '"æ¶¦é»‘ä½“", "Noto Sans SC", sans-serif' },
      { id: 'shuiditi', name: 'æ°´æ»´ä½“', family: '"æ°´æ»´ä½“", "Noto Sans SC", sans-serif' },
      { id: 'huafengti', name: 'åå‡¤ä½“', family: '"åå‡¤ä½“", "ZCOOL XiaoWei", serif' },
      { id: 'xiuyuanti', name: 'ç§€åœ†ä½“', family: '"ç§€åœ†ä½“", "Noto Sans SC", sans-serif' },
      { id: 'checheti', name: 'è½¦è½¦ä½“', family: '"è½¦è½¦ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'dingdangti', name: 'å®å½“ä½“', family: '"å®å½“ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'kuanyunti', name: 'å®½äº‘ä½“', family: '"å®½äº‘ä½“", "Noto Sans SC", sans-serif' },
      { id: 'jingdongti', name: 'äº¬ä¸œä½“', family: '"äº¬ä¸œä½“", "Noto Sans SC", sans-serif' },
      { id: 'wenzhengti', name: 'æ–‡æ­£ä½“', family: '"æ–‡æ­£ä½“", "Noto Serif SC", serif' },
      { id: 'kuankuanti', name: 'å®½å®½ä½“', family: '"å®½å®½ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'shishangti', name: 'æ—¶å°šä½“', family: '"æ—¶å°šä½“", "Noto Sans SC", sans-serif' },
      { id: 'xiuheiti', name: 'ç§€é»‘ä½“', family: '"ç§€é»‘ä½“", "Noto Sans SC", sans-serif' },
      { id: 'fangyuanti', name: 'æ–¹åœ†ä½“', family: '"æ–¹åœ†ä½“", "Noto Sans SC", sans-serif' },
      { id: 'weiheiti', name: 'ç»´é»‘ä½“', family: '"ç»´é»‘ä½“", "Noto Sans SC", sans-serif' },
      { id: 'ruiboti', name: 'é”åšä½“', family: '"é”åšä½“", "Noto Sans SC", sans-serif' },
      { id: 'langqingti', name: 'æœ—å€©ä½“', family: '"æœ—å€©ä½“", "Noto Sans SC", sans-serif' },
      { id: 'jinniuti', name: 'é‡‘ç‰›ä½“', family: '"é‡‘ç‰›ä½“", "Noto Sans SC", sans-serif' },
      { id: 'jimuti', name: 'ç§¯æœ¨ä½“', family: '"ç§¯æœ¨ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'jianheizhong', name: 'ç®€é»‘ä¸­', family: '"ç®€é»‘ä¸­", "Noto Sans SC", sans-serif' },
      { id: 'fangtangti', name: 'æ–¹ç³–ä½“', family: '"æ–¹ç³–ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'qianqianti', name: 'èŠŠèŠŠä½“', family: '"èŠŠèŠŠä½“", "ZCOOL XiaoWei", serif' },
      { id: 'jianheixian', name: 'ç®€é»‘çº¤', family: '"ç®€é»‘çº¤", "Noto Sans SC", sans-serif' },
      { id: 'qingchengti', name: 'å€¾åŸä½“', family: '"å€¾åŸä½“", "ZCOOL XiaoWei", serif' },
      { id: 'xianfengti', name: 'å…ˆé”‹ä½“', family: '"å…ˆé”‹ä½“", "Noto Sans SC", sans-serif' },
      { id: 'xingyan', name: 'æ˜Ÿå²©ä½“', family: '"æ˜Ÿå²©ä½“", "Noto Sans SC", sans-serif' },
      { id: 'ruilengti', name: 'é”æ£±ä½“', family: '"é”æ£±ä½“", "Noto Sans SC", sans-serif' },
      { id: 'yuefengti', name: 'æ‚¦é£ä½“', family: '"æ‚¦é£ä½“", "Noto Sans SC", sans-serif' },
      { id: 'shengzunti', name: 'åœ£å°Šä½“', family: '"åœ£å°Šä½“", "Ma Shan Zheng", cursive' },
      // JIUYILIANSUCAI è‰ºæœ¯å­—ä½“ç³»åˆ—
      { id: 'congmingdeyixiu', name: 'èªæ˜çš„ä¸€ä¼‘', family: '"èªæ˜çš„ä¸€ä¼‘", "Noto Sans SC", sans-serif' },
      { id: 'youyuquan', name: 'é±¿é±¼åœˆ', family: '"é±¿é±¼åœˆ", "ZCOOL KuaiLe", cursive' },
      { id: 'guaiwugongyu', name: 'æ€ªç‰©å…¬å¯“', family: '"æ€ªç‰©å…¬å¯“", "Noto Sans SC", sans-serif' },
      { id: 'touqiedeyishu', name: 'å·çªƒçš„è‰ºæœ¯', family: '"å·çªƒçš„è‰ºæœ¯", "Liu Jian Mao Cao", cursive' },
      { id: 'zhiqinaideni', name: 'è‡´äº²çˆ±çš„ä½ ', family: '"è‡´äº²çˆ±çš„ä½ ", cursive' },
      { id: 'qingmeizhuma', name: 'é’æ¢…ç«¹é©¬', family: '"é’æ¢…ç«¹é©¬", "Noto Sans SC", sans-serif' },
      { id: 'shaonvxiaoyu', name: 'å°‘å¥³å°æ¸”', family: '"å°‘å¥³å°æ¸”", "ZCOOL KuaiLe", cursive' },
      { id: 'haijieriji', name: 'æµ·è¡—æ—¥è®°', family: '"æµ·è¡—æ—¥è®°", "Noto Sans SC", sans-serif' },
      { id: 'youranjiannanshan', name: 'æ‚ ç„¶è§å—å±±', family: '"æ‚ ç„¶è§å—å±±", "Liu Jian Mao Cao", cursive' },
      { id: 'datouerzhi', name: 'å¤§å¤´å„¿å­', family: '"å¤§å¤´å„¿å­", "ZCOOL KuaiLe", cursive' },
      { id: 'guduwansui', name: 'å­¤ç‹¬ä¸‡å²', family: '"å­¤ç‹¬ä¸‡å²", "Liu Jian Mao Cao", cursive' },
      { id: 'ningmengcha', name: 'æŸ æª¬èŒ¶', family: '"æŸ æª¬èŒ¶", "ZCOOL KuaiLe", cursive' },
      { id: 'chunzhenniandai', name: 'çº¯çœŸå¹´ä»£', family: '"çº¯çœŸå¹´ä»£", "Noto Sans SC", sans-serif' },
      { id: 'haidizongdongyuan', name: 'æµ·åº•æ€»åŠ¨å‘˜', family: '"æµ·åº•æ€»åŠ¨å‘˜", "Noto Sans SC", sans-serif' },
      { id: 'xiajieyinxiang', name: 'å°è¡—å°è±¡', family: '"å°è¡—å°è±¡", "Noto Sans SC", sans-serif' },
      { id: 'maidougushi', name: 'éº¦å…œæ•…äº‹', family: '"éº¦å…œæ•…äº‹", "ZCOOL KuaiLe", cursive' },
      { id: 'dishinigongzhu', name: 'è¿ªå£«å°¼å…¬ä¸»', family: '"è¿ªå£«å°¼å…¬ä¸»", "ZCOOL KuaiLe", cursive' },
      { id: 'danaolingong', name: 'å¤§é—¹å¤©å®«', family: '"å¤§é—¹å¤©å®«", "Noto Sans SC", sans-serif' },
      { id: 'shenbimaliang', name: 'ç¥ç¬”é©¬è‰¯', family: '"ç¥ç¬”é©¬è‰¯", "Noto Sans SC", sans-serif' },
      { id: 'zaijiannanhai', name: 'å†è§ç”·å­©', family: '"å†è§,ç”·å­©", "Noto Sans SC", sans-serif' },
      { id: 'kuailexingqiu', name: 'å¿«ä¹æ˜Ÿçƒ', family: '"å¿«ä¹æ˜Ÿçƒ", "ZCOOL KuaiLe", cursive' },
      // å¤é£å­—ä½“æ¨èç³»åˆ— (å¯å•†ç”¨)
      { id: 'hongleizhuoshujian', name: 'é¸¿é›·æ‹™ä¹¦ç®€ä½“', family: '"é¸¿é›·æ‹™ä¹¦ç®€ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'jinnianjiayouya', name: 'ä»Šå¹´ä¹Ÿè¦åŠ æ²¹é¸­', family: '"ä»Šå¹´ä¹Ÿè¦åŠ æ²¹é¸­", "ZCOOL KuaiLe", cursive' },
      { id: 'yunfenghanchan', name: 'äº‘å³°å¯’è‰ä½“', family: '"äº‘å³°å¯’è‰ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'yanshixiaxingkai', name: 'æ¼”ç¤ºå¤è¡Œæ¥·', family: '"æ¼”ç¤ºå¤è¡Œæ¥·", KaiTi, serif' },
      { id: 'yanshiyouranxiaokai', name: 'æ¼”ç¤ºæ‚ ç„¶å°æ¥·', family: '"æ¼”ç¤ºæ‚ ç„¶å°æ¥·", "Ma Shan Zheng", cursive' },
      { id: 'yunfengjinglongxingshu', name: 'äº‘å³°é™é¾™è¡Œä¹¦', family: '"äº‘å³°é™é¾™è¡Œä¹¦", "Liu Jian Mao Cao", cursive' },
      { id: 'huxiaobesaobaoti', name: 'èƒ¡æ™“æ³¢éªšåŒ…ä½“', family: '"èƒ¡æ™“æ³¢éªšåŒ…ä½“", "ZCOOL KuaiLe", cursive' },
      { id: 'muyaoruanbishouxie', name: 'æ²ç‘¶è½¯ç¬”æ‰‹å†™ä½“', family: '"æ²ç‘¶è½¯ç¬”æ‰‹å†™ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'muyaosuixinshouxie', name: 'æ²ç‘¶éšå¿ƒæ‰‹å†™ä½“', family: '"æ²ç‘¶éšå¿ƒæ‰‹å†™ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'pfpinfanhutu', name: 'PFé¢‘å‡¡èƒ¡æ¶‚ä½“', family: '"PFé¢‘å‡¡èƒ¡æ¶‚ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'yanshifoxiti', name: 'æ¼”ç¤ºä½›ç³»ä½“', family: '"æ¼”ç¤ºä½›ç³»ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'pingfanglaijianghufeiyangti', name: 'å¹³æ–¹èµ–æ±Ÿæ¹–é£æ‰¬ä½“', family: '"å¹³æ–¹èµ–æ±Ÿæ¹–é£æ‰¬ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'gongfanmianfeiti', name: 'é¾šå¸†å…è´¹ä½“', family: '"é¾šå¸†å…è´¹ä½“", "Liu Jian Mao Cao", cursive' },
      { id: 'pingfanglaijianghuhuaiguti', name: 'å¹³æ–¹èµ–æ±Ÿæ¹–æ€€å¤ä½“', family: '"å¹³æ–¹èµ–æ±Ÿæ¹–æ€€å¤ä½“", "Liu Jian Mao Cao", cursive' },
    ];

    // Colors - including Traditional Chinese colors (ä¸­å›½ä¼ ç»Ÿè‰²è°±)
    const colors = [
      // Basic colors åŸºç¡€è‰²
      '#000000', '#1a1a1a', '#333333', '#4a4a4a', '#666666', '#888888', '#ffffff',
      '#ff2442', '#e74c3c', '#c0392b', '#ff6b6b', '#b71540',
      '#e67e22', '#d35400', '#f39c12', '#ff9f43',
      '#f1c40f', '#ffc312', '#fed330',
      '#27ae60', '#2ecc71', '#1abc9c', '#16a085', '#2d5a27',
      '#00cec9', '#17a2b8', '#0abde3',
      '#3498db', '#2980b9', '#1565c0', '#0984e3', '#2d3436',
      '#9b59b6', '#8e44ad', '#6a1b9a', '#a55eea', '#7c3aed',
      '#e84393', '#fd79a8', '#ff6b81', '#c44569',
      '#8b4513', '#5d4037', '#795548',
      '#9a8c7b', '#8f9779', '#a49592', '#7d8491',
      '#00ffff', '#ff00ff', '#ff1493',
      // ç‰è‰²ç³» (Jade/White series) ä¸­å›½ä¼ ç»Ÿç‰è‰²
      '#f8f4ed', '#f5f0e6', '#f0ece3', '#ebe5d6', '#e8e0d0', '#e3d9c6',
      '#ddd3bc', '#d8ccb3', '#f7f4ef', '#efe9dc', '#e6dece', '#ddd5c0',
      '#d4cbb2', '#cac0a4', '#bfb496', '#b4a888', '#cfc4a8', '#c5ba9a',
      // ç»¿è‰²ç³» (Green series) ä¸­å›½ä¼ ç»Ÿç»¿è‰²
      '#8a9c5f', '#7d9051', '#708444', '#637837', '#566c2a', '#496020',
      '#3c5414', '#2f4808', '#a4b87c', '#97ac6e', '#8aa060', '#7d9452',
      '#708844', '#637c36', '#567028', '#49641a', '#bcc99a', '#afbd8c',
      '#a2b17e', '#95a570', '#889962', '#7b8d54', '#6e8146', '#617538',
      '#c5d4a0', '#bacb91', '#afc182', '#a4b873', '#99ae64', '#8ea555',
      '#839b46', '#789237', '#425234', '#5a6b46', '#728458', '#8a9d6a',
      // é’è‰²ç³» (Cyan/Teal series) ä¸­å›½ä¼ ç»Ÿé’è‰²
      '#70a3b5', '#6298ab', '#548da1', '#468297', '#38778d', '#2a6c83',
      '#1c6179', '#0e566f', '#88b5c5', '#7aabbc', '#6ca1b3', '#5e97aa',
      '#508da1', '#428398', '#34798f', '#266f86', '#a0c7d5', '#92becc',
      '#84b5c3', '#76acba', '#68a3b1', '#5a9aa8', '#4c919f', '#3e8896',
      '#1a5566', '#2d6677', '#407788', '#538899', '#6699aa', '#79aabb',
      '#8cbbcc', '#9fccdd', '#21373b', '#2b474c', '#35575d', '#3f676e',
      // é»„è‰²ç³» (Yellow series) ä¸­å›½ä¼ ç»Ÿé»„è‰²
      '#f9e8c5', '#f6e0b0', '#f3d89b', '#f0d086', '#edc871', '#eac05c',
      '#e7b847', '#e4b032', '#fcefd6', '#fae7c1', '#f8dfac', '#f6d797',
      '#f4cf82', '#f2c76d', '#f0bf58', '#eeb743', '#e5c88a', '#dfc076',
      '#d9b862', '#d3b04e', '#cda83a', '#c7a026', '#c19812', '#bb9000',
      '#d4a86a', '#cda05a', '#c6984a', '#bf903a', '#b8882a', '#b1801a',
      '#aa780a', '#a37000', '#c8a060', '#c19850', '#ba9040', '#b38830',
      // æ©™è‰²ç³» (Orange series) ä¸­å›½ä¼ ç»Ÿæ©™è‰²
      '#f9a857', '#f79d45', '#f59233', '#f38721', '#f17c0f', '#ef7100',
      '#e86800', '#e15f00', '#fbb876', '#f9ad64', '#f7a252', '#f59740',
      '#f38c2e', '#f1811c', '#ef760a', '#ed6b00', '#f5c08c', '#f3b57a',
      '#f1aa68', '#ef9f56', '#ed9444', '#eb8932', '#e97e20', '#e7730e',
      '#e8883b', '#e57e2d', '#e2741f', '#df6a11', '#dc6003', '#d95600',
      '#d64c00', '#d34200', '#cb6a32', '#c66026', '#c1561a', '#bc4c0e',
      // çº¢è‰²ç³» (Red series) ä¸­å›½ä¼ ç»Ÿçº¢è‰²
      '#c93756', '#c22d4c', '#bb2342', '#b41938', '#ad0f2e', '#a60524',
      '#9f001a', '#980010', '#d64d6a', '#cf4360', '#c83956', '#c12f4c',
      '#ba2542', '#b31b38', '#ac112e', '#a50724', '#e3647e', '#dc5a74',
      '#d5506a', '#ce4660', '#c73c56', '#c0324c', '#b92842', '#b21e38',
      '#8c1f2a', '#7d1b26', '#6e1722', '#5f131e', '#500f1a', '#410b16',
      '#c45a5a', '#bc5050', '#b44646', '#ac3c3c', '#a43232', '#9c2828',
      // ç²‰è‰²ç³» (Pink series) ä¸­å›½ä¼ ç»Ÿç²‰è‰²
      '#f2c4c4', '#eeb8b8', '#eaacac', '#e6a0a0', '#e29494', '#de8888',
      '#da7c7c', '#d67070', '#f5d0d0', '#f1c4c4', '#edb8b8', '#e9acac',
      '#e5a0a0', '#e19494', '#dd8888', '#d97c7c', '#f8dcdc', '#f4d0d0',
      '#f0c4c4', '#ecb8b8', '#e8acac', '#e4a0a0', '#e09494', '#dc8888',
      '#d4a4a8', '#cc9a9e', '#c49094', '#bc868a', '#b47c80', '#ac7276',
      '#a4686c', '#9c5e62', '#e8b4b8', '#e0aaae', '#d8a0a4', '#d0969a',
      // ç´«è‰²ç³» (Purple series) ä¸­å›½ä¼ ç»Ÿç´«è‰²
      '#8b668b', '#7f5a7f', '#734e73', '#674267', '#5b365b', '#4f2a4f',
      '#431e43', '#371237', '#9f7a9f', '#936e93', '#876287', '#7b567b',
      '#6f4a6f', '#633e63', '#573257', '#4b264b', '#b38eb3', '#a782a7',
      '#9b769b', '#8f6a8f', '#835e83', '#775277', '#6b466b', '#5f3a5f',
      '#5d3f6a', '#533562', '#492b5a', '#3f2152', '#35174a', '#2b0d42',
      '#6b4d78', '#614370', '#573968', '#4d2f60', '#432558', '#391b50',
      // é»‘è‰²ç³» (Black series) ä¸­å›½ä¼ ç»Ÿé»‘è‰²
      '#2b333e', '#252d38', '#1f2732', '#19212c', '#131b26', '#0d1520',
      '#070f1a', '#010914', '#3d4550', '#374050', '#313a4a', '#2b3444',
      '#252e3e', '#1f2838', '#192232', '#131c2c', '#4f5762', '#49515c',
      '#434b56', '#3d4550', '#373f4a', '#313944', '#2b333e', '#252d38',
      '#1c1c1c', '#161616', '#101010', '#0a0a0a', '#282828', '#222222',
    ];

    // Templates
    const defaultTemplates = [
      { id: 'minimal-white', name: 'ç®€çº¦ç™½', preview: 'linear-gradient(180deg, #fff 0%, #f8f9fa 100%)',
        background: (ctx, w, h) => { ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, w, h); }, defaultColor: '#2d3436' },
      { id: 'warm-gradient', name: 'æš–é˜³æ©˜', preview: 'linear-gradient(135deg, #fff6e9 0%, #ffd4a3 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#fff6e9'); g.addColorStop(1,'#ffd4a3'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#8b4513' },
      { id: 'pink-dream', name: 'å°‘å¥³ç²‰', preview: 'linear-gradient(135deg, #ffeef8 0%, #ffb6c1 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#ffeef8'); g.addColorStop(1,'#ffb6c1'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#c44569' },
      { id: 'mint-fresh', name: 'è–„è·ç»¿', preview: 'linear-gradient(135deg, #e8f5e9 0%, #a5d6a7 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#e8f5e9'); g.addColorStop(1,'#a5d6a7'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#2d5a27' },
      { id: 'ocean-blue', name: 'æµ·æ´‹è“', preview: 'linear-gradient(135deg, #e3f2fd 0%, #90caf9 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#e3f2fd'); g.addColorStop(1,'#90caf9'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#1565c0' },
      { id: 'lavender', name: 'è–°è¡£è‰', preview: 'linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#f3e5f5'); g.addColorStop(1,'#ce93d8'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#6a1b9a' },
      { id: 'vintage', name: 'ç‰›çš®çº¸', preview: 'linear-gradient(180deg, #f5e6d3 0%, #d4c4a8 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#f5e6d3'); g.addColorStop(1,'#d4c4a8'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#5d4037' },
      { id: 'dark', name: 'é«˜çº§é»‘', preview: 'linear-gradient(135deg, #2d3436 0%, #0a0a0a 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#2d3436'); g.addColorStop(1,'#0a0a0a'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#ffffff' },
      { id: 'morandi-gray', name: 'è«å…°è¿ªç°', preview: 'linear-gradient(180deg, #d5d5d5 0%, #b8b4af 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#d5d5d5'); g.addColorStop(1,'#b8b4af'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#4a4a4a' },
      { id: 'morandi-pink', name: 'è«å…°è¿ªç²‰', preview: 'linear-gradient(180deg, #e8d5d5 0%, #d0b5b5 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#e8d5d5'); g.addColorStop(1,'#d0b5b5'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#6b4a4a' },
      { id: 'sunset', name: 'æ—¥è½æ©™', preview: 'linear-gradient(180deg, #ffecd2 0%, #ff8a80 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#ffecd2'); g.addColorStop(1,'#ff8a80'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#c62828' },
      { id: 'cyber', name: 'èµ›åšéœ“è™¹', preview: 'linear-gradient(135deg, #0f0c29 0%, #24243e 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#0f0c29'); g.addColorStop(1,'#24243e'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#00ffff' },
      { id: 'milk-tea', name: 'å¥¶èŒ¶è‰²', preview: 'linear-gradient(180deg, #f5ebe0 0%, #d5c4a1 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#f5ebe0'); g.addColorStop(1,'#d5c4a1'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#5d4e37' },
      { id: 'forest', name: 'æ£®æ—ç»¿', preview: 'linear-gradient(180deg, #a8e6cf 0%, #56ab7b 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#a8e6cf'); g.addColorStop(1,'#56ab7b'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#1b4332' },
      { id: 'cherry', name: 'æ¨±èŠ±ç²‰', preview: 'linear-gradient(180deg, #fce4ec 0%, #f48fb1 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#fce4ec'); g.addColorStop(1,'#f48fb1'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#880e4f' },
      // ä¸­å›½ä¼ ç»Ÿè‰²è°±æ¨¡æ¿ (Traditional Chinese Color Templates)
      { id: 'cn-jade', name: 'ç‰è‰²', preview: 'linear-gradient(180deg, #f8f4ed 0%, #e3d9c6 50%, #cac0a4 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#f8f4ed'); g.addColorStop(0.5,'#e3d9c6'); g.addColorStop(1,'#cac0a4'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#5d4037' },
      { id: 'cn-jade2', name: 'å‡è„‚', preview: 'linear-gradient(135deg, #f5f0e6 0%, #ddd3bc 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#f5f0e6'); g.addColorStop(1,'#ddd3bc'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#4a4a4a' },
      { id: 'cn-green', name: 'ç¿ ç«¹', preview: 'linear-gradient(180deg, #c5d4a0 0%, #8a9c5f 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#c5d4a0'); g.addColorStop(1,'#8a9c5f'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#2f4808' },
      { id: 'cn-green2', name: 'æŸ³è‰²', preview: 'linear-gradient(135deg, #bcc99a 0%, #708844 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#bcc99a'); g.addColorStop(1,'#708844'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#ffffff' },
      { id: 'cn-green3', name: 'é’è‹”', preview: 'linear-gradient(180deg, #728458 0%, #425234 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#728458'); g.addColorStop(1,'#425234'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#f8f4ed' },
      { id: 'cn-cyan', name: 'å¤©é’', preview: 'linear-gradient(180deg, #a0c7d5 0%, #70a3b5 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#a0c7d5'); g.addColorStop(1,'#70a3b5'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#1a5566' },
      { id: 'cn-cyan2', name: 'è”šè“', preview: 'linear-gradient(135deg, #88b5c5 0%, #468297 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#88b5c5'); g.addColorStop(1,'#468297'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#ffffff' },
      { id: 'cn-cyan3', name: 'é›é’', preview: 'linear-gradient(180deg, #538899 0%, #21373b 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#538899'); g.addColorStop(1,'#21373b'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#f8f4ed' },
      { id: 'cn-yellow', name: 'å§œé»„', preview: 'linear-gradient(180deg, #fcefd6 0%, #e5c88a 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#fcefd6'); g.addColorStop(1,'#e5c88a'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#5d4037' },
      { id: 'cn-yellow2', name: 'æ €å­', preview: 'linear-gradient(135deg, #f9e8c5 0%, #d4a86a 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#f9e8c5'); g.addColorStop(1,'#d4a86a'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#5d4037' },
      { id: 'cn-yellow3', name: 'ç§‹é¦™', preview: 'linear-gradient(180deg, #d9b862 0%, #a37000 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#d9b862'); g.addColorStop(1,'#a37000'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#ffffff' },
      { id: 'cn-orange', name: 'æé»„', preview: 'linear-gradient(180deg, #fbb876 0%, #f59233 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#fbb876'); g.addColorStop(1,'#f59233'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#5d4037' },
      { id: 'cn-orange2', name: 'æ©˜çº¢', preview: 'linear-gradient(135deg, #f5c08c 0%, #e86800 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#f5c08c'); g.addColorStop(1,'#e86800'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#ffffff' },
      { id: 'cn-orange3', name: 'æŸ¿çº¢', preview: 'linear-gradient(180deg, #e8883b 0%, #bc4c0e 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#e8883b'); g.addColorStop(1,'#bc4c0e'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#ffffff' },
      { id: 'cn-red', name: 'æœ±çº¢', preview: 'linear-gradient(180deg, #e3647e 0%, #c93756 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#e3647e'); g.addColorStop(1,'#c93756'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#ffffff' },
      { id: 'cn-red2', name: 'èƒ­è„‚', preview: 'linear-gradient(135deg, #d64d6a 0%, #9f001a 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#d64d6a'); g.addColorStop(1,'#9f001a'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#f8f4ed' },
      { id: 'cn-red3', name: 'ç»›çº¢', preview: 'linear-gradient(180deg, #8c1f2a 0%, #410b16 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#8c1f2a'); g.addColorStop(1,'#410b16'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#f8f4ed' },
      { id: 'cn-pink', name: 'æ¡ƒçº¢', preview: 'linear-gradient(180deg, #f5d0d0 0%, #e29494 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#f5d0d0'); g.addColorStop(1,'#e29494'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#5f131e' },
      { id: 'cn-pink2', name: 'æµ·æ£ ', preview: 'linear-gradient(135deg, #f2c4c4 0%, #d4a4a8 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#f2c4c4'); g.addColorStop(1,'#d4a4a8'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#5f131e' },
      { id: 'cn-pink3', name: 'ç»›ç´«', preview: 'linear-gradient(180deg, #d4a4a8 0%, #9c5e62 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#d4a4a8'); g.addColorStop(1,'#9c5e62'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#ffffff' },
      { id: 'cn-purple', name: 'ç´«è—¤', preview: 'linear-gradient(180deg, #b38eb3 0%, #8b668b 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#b38eb3'); g.addColorStop(1,'#8b668b'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#ffffff' },
      { id: 'cn-purple2', name: 'ä¸é¦™', preview: 'linear-gradient(135deg, #9f7a9f 0%, #5b365b 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#9f7a9f'); g.addColorStop(1,'#5b365b'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#f8f4ed' },
      { id: 'cn-purple3', name: 'ç´«éœ„', preview: 'linear-gradient(180deg, #6b4d78 0%, #2b0d42 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#6b4d78'); g.addColorStop(1,'#2b0d42'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#f8f4ed' },
      { id: 'cn-black', name: 'å¢¨è‰²', preview: 'linear-gradient(180deg, #4f5762 0%, #1c1c1c 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#4f5762'); g.addColorStop(1,'#1c1c1c'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#f8f4ed' },
      { id: 'cn-black2', name: 'ç„é’', preview: 'linear-gradient(135deg, #2b333e 0%, #010914 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#2b333e'); g.addColorStop(1,'#010914'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#9fccdd' },
      { id: 'cn-black3', name: 'æ¼†é»‘', preview: 'linear-gradient(180deg, #252d38 0%, #0a0a0a 100%)',
        background: (ctx, w, h) => { const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#252d38'); g.addColorStop(1,'#0a0a0a'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); }, defaultColor: '#edc871' },
    ];

    let customTemplates = [];
    let templates = [...defaultTemplates];
    const customImageCache = {};

    // IndexedDB Configuration
    const DB_NAME = 'XHSCoverTemplatesDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'templates';
    let db = null;
    let indexedDBAvailable = false;

    // Initialize IndexedDB
    async function initIndexedDB() {
      return new Promise((resolve) => {
        if (!window.indexedDB) {
          console.log('IndexedDB not supported');
          updateStorageStatus(false);
          resolve(false);
          return;
        }

        try {
          const request = indexedDB.open(DB_NAME, DB_VERSION);

          request.onerror = (event) => {
            console.log('IndexedDB error:', event.target.error);
            updateStorageStatus(false);
            resolve(false);
          };

          request.onsuccess = (event) => {
            db = event.target.result;
            indexedDBAvailable = true;
            console.log('IndexedDB initialized successfully');
            updateStorageStatus(true);
            resolve(true);
          };

          request.onupgradeneeded = (event) => {
            const database = event.target.result;
            if (!database.objectStoreNames.contains(STORE_NAME)) {
              database.createObjectStore(STORE_NAME, { keyPath: 'id' });
            }
          };
        } catch (e) {
          console.log('IndexedDB init error:', e);
          updateStorageStatus(false);
          resolve(false);
        }
      });
    }

    // Update storage status display
    async function updateStorageStatus(available) {
      const statusEl = document.getElementById('storageStatus');
      if (!statusEl) return;

      if (!available) {
        statusEl.innerHTML = '<span class="text-yellow-500">ä¸´æ—¶å­˜å‚¨</span>';
        return;
      }

      try {
        // Try to get storage estimate
        if (navigator.storage && navigator.storage.estimate) {
          const estimate = await navigator.storage.estimate();
          const usedMB = (estimate.usage / (1024 * 1024)).toFixed(1);
          const quotaMB = (estimate.quota / (1024 * 1024)).toFixed(0);
          const count = customTemplates.length;
          statusEl.innerHTML = `<span class="text-green-500">${count}å¼  Â· ${usedMB}MB</span>`;
        } else {
          const count = customTemplates.length;
          statusEl.innerHTML = `<span class="text-green-500">${count}å¼ å·²å­˜</span>`;
        }
      } catch (e) {
        statusEl.innerHTML = '<span class="text-green-500">æŒä¹…å­˜å‚¨</span>';
      }
    }

    // Save template to IndexedDB
    async function saveTemplateToDB(templateData) {
      if (!indexedDBAvailable || !db) return false;

      return new Promise((resolve) => {
        try {
          const transaction = db.transaction([STORE_NAME], 'readwrite');
          const store = transaction.objectStore(STORE_NAME);
          const request = store.put(templateData);

          request.onsuccess = () => {
            console.log('Template saved to IndexedDB:', templateData.id);
            updateStorageStatus(true);
            resolve(true);
          };

          request.onerror = (event) => {
            console.log('Error saving template:', event.target.error);
            resolve(false);
          };
        } catch (e) {
          console.log('Save error:', e);
          resolve(false);
        }
      });
    }

    // Delete template from IndexedDB
    async function deleteTemplateFromDB(templateId) {
      if (!indexedDBAvailable || !db) return false;

      return new Promise((resolve) => {
        try {
          const transaction = db.transaction([STORE_NAME], 'readwrite');
          const store = transaction.objectStore(STORE_NAME);
          const request = store.delete(templateId);

          request.onsuccess = () => {
            console.log('Template deleted from IndexedDB:', templateId);
            updateStorageStatus(true);
            resolve(true);
          };

          request.onerror = (event) => {
            console.log('Error deleting template:', event.target.error);
            resolve(false);
          };
        } catch (e) {
          console.log('Delete error:', e);
          resolve(false);
        }
      });
    }

    // Load all templates from IndexedDB
    async function loadTemplatesFromDB() {
      if (!indexedDBAvailable || !db) return [];

      return new Promise((resolve) => {
        try {
          const transaction = db.transaction([STORE_NAME], 'readonly');
          const store = transaction.objectStore(STORE_NAME);
          const request = store.getAll();

          request.onsuccess = (event) => {
            const templates = event.target.result || [];
            console.log('Loaded templates from IndexedDB:', templates.length);
            resolve(templates);
          };

          request.onerror = (event) => {
            console.log('Error loading templates:', event.target.error);
            resolve([]);
          };
        } catch (e) {
          console.log('Load error:', e);
          resolve([]);
        }
      });
    }

    // Restore templates from IndexedDB data
    async function restoreTemplatesFromDB() {
      const savedTemplates = await loadTemplatesFromDB();

      for (const templateData of savedTemplates) {
        try {
          // Create image from base64
          const img = new Image();
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
            img.src = templateData.imageData;
          });

          // Cache the image
          customImageCache[templateData.id] = img;

          // Create template object
          const template = {
            id: templateData.id,
            name: templateData.name,
            preview: templateData.imageData,
            background: (ctx, w, h) => {
              const cachedImg = customImageCache[templateData.id];
              if (cachedImg) {
                const scale = Math.max(w / cachedImg.width, h / cachedImg.height);
                const sw = cachedImg.width * scale;
                const sh = cachedImg.height * scale;
                ctx.drawImage(cachedImg, (w - sw) / 2, (h - sh) / 2, sw, sh);
              }
            },
            isCustom: true
          };

          customTemplates.push(template);
        } catch (e) {
          console.log('Error restoring template:', templateData.id, e);
        }
      }

      if (customTemplates.length > 0) {
        templates = [...customTemplates, ...defaultTemplates];
        renderTemplates();
        updateStorageStatus(true);
        updateExportButton();
      }
    }

    // è®°å½•ä½¿ç”¨ç»Ÿè®¡
    function recordUsage(action) {
      if (!currentRole) return;

      const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

      if (!usageStats[currentRole]) {
        usageStats[currentRole] = {};
      }
      if (!usageStats[currentRole][today]) {
        usageStats[currentRole][today] = { downloads: 0, generates: 0 };
      }

      if (action === 'download') {
        usageStats[currentRole][today].downloads++;
      } else if (action === 'generate') {
        usageStats[currentRole][today].generates++;
      }
    }

    // è·å–è§’è‰²çš„ä½¿ç”¨ç»Ÿè®¡
    function getRoleUsageStats(roleId) {
      return usageStats[roleId] || {};
    }

    // è·å–ä»Šæ—¥ç»Ÿè®¡
    function getTodayStats(roleId) {
      const today = new Date().toISOString().split('T')[0];
      return usageStats[roleId]?.[today] || { downloads: 0, generates: 0 };
    }

    // è·å–æ‰€æœ‰è§’è‰²çš„ç»Ÿè®¡æ‘˜è¦
    function getAllUsageStats() {
      const summary = {};
      for (const [roleId, dates] of Object.entries(usageStats)) {
        let totalDownloads = 0;
        let totalGenerates = 0;
        for (const stats of Object.values(dates)) {
          totalDownloads += stats.downloads || 0;
          totalGenerates += stats.generates || 0;
        }
        summary[roleId] = {
          totalDownloads,
          totalGenerates,
          days: Object.keys(dates).length
        };
      }
      return summary;
    }

    // Watermark image cache
    let watermarkImage = null;

    // Initialize
    async function init() {
      // Initialize IndexedDB first
      await initIndexedDB();

      // Restore templates from IndexedDB if available
      if (indexedDBAvailable) {
        await restoreTemplatesFromDB();
      }

      renderTemplates();
      renderFontSelects();
      renderColors();
      renderTitleColors();
      setupEventListeners();
      setupEditModeListeners();
      updatePreview();
    }

    // Toggle split mode
    function toggleSplitMode() {
      state.splitMode = !state.splitMode;
      document.getElementById('splitModeToggle').classList.toggle('active', state.splitMode);
      document.getElementById('simpleModeContent').classList.toggle('hidden', state.splitMode);
      document.getElementById('splitModeContent').classList.toggle('hidden', !state.splitMode);
      document.getElementById('styleTabs').classList.toggle('hidden', !state.splitMode);
      document.getElementById('titleStyleSection').classList.toggle('hidden', !state.splitMode);
      document.getElementById('fontLabel').textContent = state.splitMode ? 'æ­£æ–‡å­—ä½“' : 'å­—ä½“é£æ ¼';

      syncTextContent();
      splitPages();
      updatePreview();
    }

    // Sync text content between modes
    function syncTextContent() {
      if (state.splitMode) {
        const lines = state.text.split('\n');
        if (lines.length > 0) {
          document.getElementById('titleInput').value = lines[0];
          document.getElementById('contentInput').value = lines.slice(1).join('\n').trim();
          state.title = lines[0];
          state.text = lines.slice(1).join('\n').trim();
        }
      } else {
        const title = document.getElementById('titleInput').value;
        const content = document.getElementById('contentInput').value;
        const combined = title ? title + '\n\n' + content : content;
        document.getElementById('textInput').value = combined;
        state.text = combined;
      }
    }

    // Switch style tab
    function switchStyleTab(tab) {
      state.currentStyleTab = tab;
      document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        btn.classList.toggle('active', (i === 0 && tab === 'title') || (i === 1 && tab === 'content'));
      });
      document.getElementById('titleStyleSection').classList.toggle('hidden', tab !== 'title');
      document.getElementById('contentStyleSection').classList.toggle('hidden', tab !== 'content');
    }

    // Render font selects
    function renderFontSelects() {
      const options = fonts.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
      document.getElementById('fontFamily').innerHTML = options;
      document.getElementById('titleFontFamily').innerHTML = options;
    }

    // Render colors
    function renderColors() {
      const grid = document.getElementById('colorGrid');
      grid.innerHTML = colors.map(c => `
        <button class="color-btn ${state.textColor === c ? 'active' : ''}"
                style="background-color: ${c}; ${c === '#ffffff' ? 'border: 1px solid #ddd;' : ''}"
                onclick="setTextColor('${c}')" data-color="${c}">
        </button>
      `).join('');
    }

    // Render title colors
    function renderTitleColors() {
      const grid = document.getElementById('titleColorGrid');
      grid.innerHTML = colors.map(c => `
        <button class="color-btn ${state.titleColor === c ? 'active' : ''}"
                style="background-color: ${c}; ${c === '#ffffff' ? 'border: 1px solid #ddd;' : ''}"
                onclick="setTitleColor('${c}')" data-color="${c}">
        </button>
      `).join('');
    }

    // Render templates
    function renderTemplates() {
      const grid = document.getElementById('templateGrid');
      let html = `
        <div id="uploadTemplateArea" class="template-card upload-template-card rounded-lg aspect-[3/4]" onclick="triggerTemplateUpload()">
          <i class="fas fa-plus text-lg text-pink-400 mb-1"></i>
          <span class="text-[10px] text-gray-500">ä¸Šä¼ </span>
        </div>
      `;

      // æ£€æŸ¥æ˜¯å¦æœ‰åˆ é™¤æƒé™
      const canDelete = hasPermission('deleteTemplate');

      customTemplates.forEach(t => {
        html += `
          <div class="template-card rounded-lg overflow-hidden ${state.templateId === t.id ? 'active' : ''}"
               onclick="selectTemplate('${t.id}')" data-template="${t.id}">
            ${canDelete ? `<div class="template-delete" onclick="event.stopPropagation(); deleteCustomTemplate('${t.id}')">
              <i class="fas fa-times"></i>
            </div>` : ''}
            <div class="aspect-[3/4] w-full bg-cover bg-center" style="background-image: url('${t.preview}')"></div>
            <div class="p-1 text-center text-[10px] text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 truncate">${t.name}</div>
          </div>
        `;
      });

      defaultTemplates.forEach(t => {
        html += `
          <div class="template-card rounded-lg overflow-hidden ${state.templateId === t.id ? 'active' : ''}"
               onclick="selectTemplate('${t.id}')" data-template="${t.id}">
            <div class="aspect-[3/4] w-full" style="background: ${t.preview}"></div>
            <div class="p-1 text-center text-[10px] text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700">${t.name}</div>
          </div>
        `;
      });

      grid.innerHTML = html;
    }

    function triggerTemplateUpload() {
      // æƒé™æ£€æŸ¥
      if (!hasPermission('uploadTemplate')) {
        showAlert('warning', 'æƒé™ä¸è¶³', 'æ‚¨æ²¡æœ‰ä¸Šä¼ æ¨¡ç‰ˆçš„æƒé™');
        return;
      }
      document.getElementById('templateImageInput').click();
    }

    // Handle template upload (including PSD)
    async function handleTemplateImageUpload(file) {
      if (!file) return;

      // æƒé™æ£€æŸ¥
      if (!hasPermission('uploadTemplate')) {
        showAlert('warning', 'æƒé™ä¸è¶³', 'æ‚¨æ²¡æœ‰ä¸Šä¼ æ¨¡ç‰ˆçš„æƒé™');
        return;
      }

      const ext = file.name.split('.').pop().toLowerCase();
      let imageData;

      try {
        if (ext === 'psd') {
          showLoading('æ­£åœ¨è§£æ PSD æ–‡ä»¶...');
          const arrayBuffer = await file.arrayBuffer();

          // Check if PSD.js is loaded
          if (typeof PSD === 'undefined') {
            hideLoading();
            showAlert('error', 'PSD åº“æœªåŠ è½½', 'è¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            return;
          }

          const psd = await PSD.fromArrayBuffer(arrayBuffer);

          // Get image from PSD - handle both composite and layer methods
          let canvas;
          if (psd.image && psd.image.toCanvas) {
            canvas = psd.image.toCanvas();
          } else {
            hideLoading();
            showAlert('error', 'PSD è§£æå¤±è´¥', 'æ— æ³•è¯»å– PSD å›¾åƒæ•°æ®');
            return;
          }

          // Convert to high quality PNG
          imageData = canvas.toDataURL('image/png', 1.0);
          hideLoading();

        } else if (file.type.startsWith('image/') || ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) {
          showLoading('æ­£åœ¨åŠ è½½å›¾ç‰‡...');
          imageData = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
          hideLoading();
        } else {
          showAlert('error', 'æ ¼å¼é”™è¯¯', 'è¯·ä¸Šä¼ å›¾ç‰‡æˆ– PSD æ–‡ä»¶');
          return;
        }

        const templateId = 'custom-' + Date.now();
        // æå–æ–‡ä»¶åï¼Œå»é™¤æ‰©å±•åå’Œæ‹¬å·å†…å®¹ï¼Œä¿ç•™æ›´å¤šå­—ç¬¦
        let templateName = file.name.replace(/\.[^/.]+$/, ''); // å»é™¤æ‰©å±•å
        templateName = templateName.replace(/[ï¼ˆ(][^ï¼‰)]*[ï¼‰)]/g, '').trim(); // å»é™¤æ‹¬å·å†…å®¹
        templateName = templateName.slice(0, 6) || 'è‡ªå®šä¹‰'; // ä¿ç•™6ä¸ªå­—ç¬¦

        const img = new Image();
        img.onload = () => {
          customImageCache[templateId] = img;

          const newTemplate = {
            id: templateId,
            name: templateName,
            preview: imageData,
            isCustom: true,
            background: (ctx, w, h) => {
              const cachedImg = customImageCache[templateId];
              if (cachedImg) {
                const imgRatio = cachedImg.width / cachedImg.height;
                const canvasRatio = w / h;
                let drawW, drawH, drawX, drawY;
                if (imgRatio > canvasRatio) {
                  drawH = h; drawW = h * imgRatio;
                  drawX = (w - drawW) / 2; drawY = 0;
                } else {
                  drawW = w; drawH = w / imgRatio;
                  drawX = 0; drawY = (h - drawH) / 2;
                }
                ctx.drawImage(cachedImg, drawX, drawY, drawW, drawH);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                ctx.fillRect(0, 0, w, h);
              }
            },
            defaultColor: '#333333'
          };

          customTemplates.unshift(newTemplate);
          templates = [...customTemplates, ...defaultTemplates];
          renderTemplates();
          selectTemplate(templateId);
          updateExportButton();

          // Save to IndexedDB for persistence
          if (indexedDBAvailable) {
            saveTemplateToDB({
              id: templateId,
              name: templateName,
              imageData: imageData
            }).then(saved => {
              if (saved) {
                showAlert('success', 'æ¨¡æ¿å·²ä¿å­˜', `"${templateName}" å·²æ°¸ä¹…ä¿å­˜`);
              } else {
                showAlert('success', 'æ¨¡æ¿å·²æ·»åŠ ', `"${templateName}" å·²æ·»åŠ ï¼ˆä¸´æ—¶ï¼‰`);
              }
            });
          } else {
            showAlert('success', 'æ¨¡æ¿å·²æ·»åŠ ', `"${templateName}" å·²æ·»åŠ ï¼ˆä¸´æ—¶ï¼‰`);
          }
        };
        img.src = imageData;
      } catch (error) {
        hideLoading();
        console.error('Template upload error:', error);
        showAlert('error', 'è§£æå¤±è´¥', 'æ— æ³•è§£æè¯¥æ–‡ä»¶');
      }
    }

    async function deleteCustomTemplate(templateId) {
      customTemplates = customTemplates.filter(t => t.id !== templateId);
      templates = [...customTemplates, ...defaultTemplates];
      delete customImageCache[templateId];
      if (state.templateId === templateId) state.templateId = 'minimal-white';
      renderTemplates();
      updatePreview();
      updateExportButton();

      // Delete from IndexedDB
      if (indexedDBAvailable) {
        await deleteTemplateFromDB(templateId);
      }
    }

    // Update export button visibility
    function updateExportButton() {
      const exportBtn = document.getElementById('exportBtn');
      if (exportBtn) {
        if (customTemplates.length > 0) {
          exportBtn.classList.remove('hidden');
        } else {
          exportBtn.classList.add('hidden');
        }
      }
    }

    // Export templates to JSON file
    function exportTemplates() {
      // æƒé™æ£€æŸ¥
      if (!hasPermission('exportImport')) {
        showAlert('warning', 'æƒé™ä¸è¶³', 'æ‚¨æ²¡æœ‰å¯¼å‡ºæ¨¡ç‰ˆçš„æƒé™');
        return;
      }

      if (customTemplates.length === 0) {
        showAlert('warning', 'æ— æ¨¡æ¿å¯å¯¼å‡º', 'è¯·å…ˆä¸Šä¼ è‡ªå®šä¹‰æ¨¡æ¿');
        return;
      }

      const exportData = customTemplates.map(t => ({
        id: t.id,
        name: t.name,
        imageData: t.preview
      }));

      const jsonStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = `å°çº¢ä¹¦å°é¢æ¨¡æ¿_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.json`;
      link.click();

      URL.revokeObjectURL(url);
      showAlert('success', 'å¯¼å‡ºæˆåŠŸ', `å·²å¯¼å‡º ${customTemplates.length} ä¸ªæ¨¡æ¿`);
    }

    // Trigger import file dialog
    function triggerImportTemplates() {
      // æƒé™æ£€æŸ¥
      if (!hasPermission('exportImport')) {
        showAlert('warning', 'æƒé™ä¸è¶³', 'æ‚¨æ²¡æœ‰å¯¼å…¥æ¨¡ç‰ˆçš„æƒé™');
        return;
      }
      document.getElementById('templateImportInput').click();
    }

    // Import templates from JSON file
    async function importTemplates(file) {
      // æƒé™æ£€æŸ¥
      if (!hasPermission('exportImport')) {
        showAlert('warning', 'æƒé™ä¸è¶³', 'æ‚¨æ²¡æœ‰å¯¼å…¥æ¨¡ç‰ˆçš„æƒé™');
        return;
      }

      try {
        showLoading('æ­£åœ¨å¯¼å…¥æ¨¡æ¿...');

        const text = await file.text();
        const importData = JSON.parse(text);

        if (!Array.isArray(importData)) {
          throw new Error('Invalid format');
        }

        let importedCount = 0;
        let skippedCount = 0;

        for (const templateData of importData) {
          // Check if template already exists
          if (customTemplates.find(t => t.id === templateData.id)) {
            skippedCount++;
            continue;
          }

          try {
            // Create image from base64
            const img = new Image();
            await new Promise((resolve, reject) => {
              img.onload = resolve;
              img.onerror = reject;
              img.src = templateData.imageData;
            });

            // Cache the image
            customImageCache[templateData.id] = img;

            // Create template object
            const template = {
              id: templateData.id,
              name: templateData.name,
              preview: templateData.imageData,
              background: (ctx, w, h) => {
                const cachedImg = customImageCache[templateData.id];
                if (cachedImg) {
                  const imgRatio = cachedImg.width / cachedImg.height;
                  const canvasRatio = w / h;
                  let drawW, drawH, drawX, drawY;
                  if (imgRatio > canvasRatio) {
                    drawH = h; drawW = h * imgRatio;
                    drawX = (w - drawW) / 2; drawY = 0;
                  } else {
                    drawW = w; drawH = w / imgRatio;
                    drawX = 0; drawY = (h - drawH) / 2;
                  }
                  ctx.drawImage(cachedImg, drawX, drawY, drawW, drawH);
                  ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                  ctx.fillRect(0, 0, w, h);
                }
              },
              isCustom: true,
              defaultColor: '#333333'
            };

            customTemplates.push(template);
            importedCount++;

            // Also save to IndexedDB if available
            if (indexedDBAvailable) {
              await saveTemplateToDB({
                id: templateData.id,
                name: templateData.name,
                imageData: templateData.imageData
              });
            }
          } catch (e) {
            console.log('Error importing template:', templateData.id, e);
          }
        }

        hideLoading();

        if (importedCount > 0) {
          templates = [...customTemplates, ...defaultTemplates];
          renderTemplates();
          updatePreview();
          updateExportButton();

          let message = `æˆåŠŸå¯¼å…¥ ${importedCount} ä¸ªæ¨¡æ¿`;
          if (skippedCount > 0) {
            message += `ï¼Œè·³è¿‡ ${skippedCount} ä¸ªé‡å¤æ¨¡æ¿`;
          }
          showAlert('success', 'å¯¼å…¥æˆåŠŸ', message);
        } else if (skippedCount > 0) {
          showAlert('info', 'å…¨éƒ¨è·³è¿‡', `${skippedCount} ä¸ªæ¨¡æ¿å·²å­˜åœ¨`);
        } else {
          showAlert('warning', 'å¯¼å…¥å¤±è´¥', 'æ²¡æœ‰æœ‰æ•ˆçš„æ¨¡æ¿æ•°æ®');
        }

      } catch (error) {
        hideLoading();
        console.error('Import error:', error);
        showAlert('error', 'å¯¼å…¥å¤±è´¥', 'æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
      }
    }

    function selectTemplate(id) {
      state.templateId = id;
      const template = templates.find(t => t.id === id) || defaultTemplates[0];
      if (template?.defaultColor) {
        state.textColor = template.defaultColor;
        state.titleColor = template.defaultColor;
        document.getElementById('textColor').value = template.defaultColor;
        document.getElementById('titleColor').value = template.defaultColor;
        renderColors();
        renderTitleColors();
      }
      document.querySelectorAll('.template-card').forEach(card => {
        card.classList.toggle('active', card.dataset.template === id);
      });
      updatePreview();
    }

    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const icon = document.getElementById(sectionId + 'Icon');
      section.classList.toggle('open');
      icon.style.transform = section.classList.contains('open') ? '' : 'rotate(-90deg)';
    }

    // Event listeners
    function setupEventListeners() {
      const textInput = document.getElementById('textInput');
      const titleInput = document.getElementById('titleInput');
      const contentInput = document.getElementById('contentInput');
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');
      const templateImageInput = document.getElementById('templateImageInput');

      textInput.addEventListener('input', e => {
        state.text = e.target.value;
        updateStats();
        splitPages();
        updatePreview();
      });

      titleInput.addEventListener('input', e => {
        state.title = e.target.value;
        updateStats();
        splitPages();
        updatePreview();
      });

      contentInput.addEventListener('input', e => {
        state.text = e.target.value;
        updateStats();
        splitPages();
        updatePreview();
      });

      dropZone.addEventListener('click', () => fileInput.click());
      dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
      dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });
      fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

      templateImageInput.addEventListener('change', e => {
        if (e.target.files[0]) handleTemplateImageUpload(e.target.files[0]);
        e.target.value = '';
      });

      // Import templates file input
      document.getElementById('templateImportInput').addEventListener('change', e => {
        if (e.target.files[0]) importTemplates(e.target.files[0]);
        e.target.value = '';
      });

      // Import roles config file input
      document.getElementById('rolesConfigInput').addEventListener('change', e => {
        if (e.target.files[0]) importRolesConfig(e.target.files[0]);
        e.target.value = '';
      });

      // Import all data (full backup) file input
      document.getElementById('allDataImportInput').addEventListener('change', e => {
        if (e.target.files[0]) importAllData(e.target.files[0]);
        e.target.value = '';
      });

      document.getElementById('fontFamily').addEventListener('change', e => {
        state.fontId = e.target.value;
        updatePreview();
      });

      document.getElementById('titleFontFamily').addEventListener('change', e => {
        state.titleFontId = e.target.value;
        updatePreview();
      });

      document.getElementById('fontSize').addEventListener('input', e => {
        state.fontSize = parseInt(e.target.value);
        document.getElementById('fontSizeValue').textContent = state.fontSize;
        updatePreview();
      });

      document.getElementById('titleFontSize').addEventListener('input', e => {
        state.titleFontSize = parseInt(e.target.value);
        document.getElementById('titleFontSizeVal').textContent = state.titleFontSize;
        updatePreview();
      });

      document.getElementById('lineHeight').addEventListener('input', e => {
        state.lineHeight = parseFloat(e.target.value);
        document.getElementById('lineHeightValue').textContent = state.lineHeight.toFixed(1);
        updatePreview();
      });

      document.getElementById('maxChars').addEventListener('input', e => {
        state.maxCharsPerPage = parseInt(e.target.value);
        document.getElementById('maxCharsValue').textContent = state.maxCharsPerPage;
        splitPages();
        updatePreview();
      });

      document.getElementById('textColor').addEventListener('input', e => {
        state.textColor = e.target.value;
        renderColors();
        updatePreview();
      });

      document.getElementById('titleColor').addEventListener('input', e => {
        state.titleColor = e.target.value;
        renderTitleColors();
        updatePreview();
      });
    }

    function setTextColor(color) {
      state.textColor = color;
      document.getElementById('textColor').value = color;
      renderColors();
      updatePreview();
    }

    function setTitleColor(color) {
      state.titleColor = color;
      document.getElementById('titleColor').value = color;
      renderTitleColors();
      updatePreview();
    }

    function setAlignment(align) {
      state.alignment = align;
      ['left', 'center', 'right'].forEach(a => {
        const btn = document.getElementById(`align${a.charAt(0).toUpperCase() + a.slice(1)}`);
        btn.classList.toggle('border-pink-500', a === align);
        btn.classList.toggle('bg-pink-50', a === align);
        btn.classList.toggle('dark:bg-pink-900/30', a === align);
        btn.classList.toggle('text-pink-600', a === align);
        btn.classList.toggle('border-gray-200', a !== align);
        btn.classList.toggle('dark:border-gray-600', a !== align);
        btn.classList.toggle('text-gray-600', a !== align);
        btn.classList.toggle('dark:text-gray-300', a !== align);
      });
      updatePreview();
    }

    function setTitleAlignment(align) {
      state.titleAlignment = align;
      ['left', 'center', 'right'].forEach(a => {
        const btn = document.getElementById(`titleAlign${a.charAt(0).toUpperCase() + a.slice(1)}`);
        btn.classList.toggle('border-pink-500', a === align);
        btn.classList.toggle('bg-pink-50', a === align);
        btn.classList.toggle('dark:bg-pink-900/30', a === align);
        btn.classList.toggle('text-pink-600', a === align);
        btn.classList.toggle('border-gray-200', a !== align);
        btn.classList.toggle('dark:border-gray-600', a !== align);
        btn.classList.toggle('text-gray-600', a !== align);
        btn.classList.toggle('dark:text-gray-300', a !== align);
      });
      updatePreview();
    }

    function showLoading(text = 'å¤„ç†ä¸­...') {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }

    async function handleFile(file) {
      if (!file) return;
      const ext = file.name.split('.').pop().toLowerCase();

      try {
        let content = '';
        if (ext === 'txt' || ext === 'md') {
          content = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsText(file);
          });
        } else if (ext === 'pdf') {
          showLoading('è§£æ PDF...');
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            content += textContent.items.map(item => item.str).join(' ') + '\n\n';
          }
        } else if (ext === 'docx' || ext === 'doc' || ext === 'wps') {
          showLoading('è§£ææ–‡æ¡£...');
          const arrayBuffer = await file.arrayBuffer();
          try {
            const result = await mammoth.extractRawText({ arrayBuffer });
            content = result.value;
          } catch {
            content = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = e => resolve(e.target.result);
              reader.onerror = reject;
              reader.readAsText(file);
            });
          }
        } else {
          showAlert('error', 'ä¸æ”¯æŒ', 'è¯·ä¸Šä¼  TXT/PDF/DOCX æ–‡ä»¶');
          return;
        }

        hideLoading();
        content = content.trim();

        if (content) {
          if (state.splitMode) {
            const lines = content.split('\n');
            document.getElementById('titleInput').value = lines[0] || '';
            document.getElementById('contentInput').value = lines.slice(1).join('\n').trim();
            state.title = lines[0] || '';
            state.text = lines.slice(1).join('\n').trim();
          } else {
            document.getElementById('textInput').value = content;
            state.text = content;
          }
          updateStats();
          splitPages();
          updatePreview();
          showAlert('success', 'å¯¼å…¥æˆåŠŸ', `æå– ${content.length} å­—`);
        } else {
          showAlert('warning', 'å†…å®¹ä¸ºç©º', 'æœªèƒ½æå–åˆ°æ–‡å­—');
        }
      } catch (error) {
        hideLoading();
        console.error(error);
        showAlert('error', 'è§£æå¤±è´¥', 'è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
      }
    }

    function updateStats() {
      const total = state.splitMode ? state.title.length + state.text.length : state.text.length;
      document.getElementById('charCount').textContent = `å·²è¾“å…¥ ${total} å­—`;
    }

    function splitPages() {
      const text = state.text.trim();
      if (!text && !state.title) {
        state.pages = [{ title: '', content: '' }];
        state.currentPage = 0;
        updatePageIndicator();
        document.getElementById('pageCount').textContent = 'é¢„è®¡ 1 å¼ å›¾';
        return;
      }

      const paragraphs = text.split(/\n\n+/);
      const pages = [];
      let currentContent = '';

      for (const para of paragraphs) {
        const paraWithBreak = currentContent ? '\n\n' + para : para;
        if ((currentContent + paraWithBreak).length <= state.maxCharsPerPage) {
          currentContent += paraWithBreak;
        } else {
          if (currentContent) pages.push({ title: state.splitMode && pages.length === 0 ? state.title : '', content: currentContent });
          if (para.length > state.maxCharsPerPage) {
            const sentences = para.split(/(?<=[ã€‚ï¼ï¼Ÿ.!?ï¼›;])/);
            let sentenceContent = '';
            for (const sentence of sentences) {
              if ((sentenceContent + sentence).length <= state.maxCharsPerPage) {
                sentenceContent += sentence;
              } else {
                if (sentenceContent) pages.push({ title: '', content: sentenceContent });
                sentenceContent = sentence.length > state.maxCharsPerPage ? '' : sentence;
                if (sentence.length > state.maxCharsPerPage) {
                  for (let i = 0; i < sentence.length; i += state.maxCharsPerPage) {
                    pages.push({ title: '', content: sentence.slice(i, i + state.maxCharsPerPage) });
                  }
                }
              }
            }
            currentContent = sentenceContent;
          } else {
            currentContent = para;
          }
        }
      }
      if (currentContent || (state.splitMode && state.title)) {
        pages.push({ title: state.splitMode && pages.length === 0 ? state.title : '', content: currentContent });
      }

      state.pages = pages.length ? pages : [{ title: state.splitMode ? state.title : '', content: '' }];
      state.currentPage = Math.min(state.currentPage, state.pages.length - 1);
      updatePageIndicator();
      document.getElementById('pageCount').textContent = `é¢„è®¡ ${state.pages.length} å¼ å›¾`;
    }

    function updatePageIndicator() {
      const indicator = document.getElementById('pageIndicator');
      const total = state.pages.length;
      document.getElementById('currentPageLabel').textContent = `${state.currentPage + 1} / ${total}`;
      document.getElementById('prevBtn').disabled = state.currentPage === 0;
      document.getElementById('nextBtn').disabled = state.currentPage >= total - 1;

      // Hide single-page navigation in multi-preview mode
      const singleNavBtns = document.getElementById('prevBtn').parentElement;
      const pageIndicatorContainer = document.getElementById('pageIndicator');
      if (state.multiPreviewMode) {
        singleNavBtns.classList.add('hidden');
        pageIndicatorContainer.classList.add('hidden');
      } else {
        singleNavBtns.classList.remove('hidden');
        pageIndicatorContainer.classList.remove('hidden');
      }

      if (total <= 10) {
        indicator.innerHTML = state.pages.map((_, i) =>
          `<div class="page-dot ${i === state.currentPage ? 'active' : ''}" onclick="goToPage(${i})"></div>`
        ).join('');
      } else {
        indicator.innerHTML = `<span class="text-xs text-gray-500">${state.currentPage + 1} / ${total}</span>`;
      }
    }

    function prevPage() { if (state.currentPage > 0) { state.currentPage--; updatePageIndicator(); updatePreview(); } }
    function nextPage() { if (state.currentPage < state.pages.length - 1) { state.currentPage++; updatePageIndicator(); updatePreview(); } }
    function goToPage(i) { state.currentPage = i; updatePageIndicator(); updatePreview(); }

    // ===== MULTI-PAGE PREVIEW FUNCTIONS =====

    function toggleMultiPreview() {
      state.multiPreviewMode = !state.multiPreviewMode;
      const btn = document.getElementById('multiPreviewBtn');
      const singleContainer = document.getElementById('singlePreviewContainer');
      const multiContainer = document.getElementById('multiPreviewContainer');

      btn.classList.toggle('active', state.multiPreviewMode);

      if (state.multiPreviewMode) {
        btn.innerHTML = '<i class="fas fa-square mr-1"></i> å•é¡µ';
        singleContainer.classList.add('hidden');
        multiContainer.classList.remove('hidden');
        // Set multiPageStart to include current page
        state.multiPageStart = Math.floor(state.currentPage / 4) * 4;
        updateMultiPreview();
      } else {
        btn.innerHTML = '<i class="fas fa-th-large mr-1"></i> å¤šé¡µ';
        singleContainer.classList.remove('hidden');
        multiContainer.classList.add('hidden');
        updatePreview();
      }
      updatePageIndicator();
    }

    function updateMultiPreview() {
      const total = state.pages.length;
      const start = state.multiPageStart;

      // Update each of the 4 preview canvases
      for (let i = 0; i < 4; i++) {
        const pageIndex = start + i;
        const canvas = document.getElementById(`multiCanvas${i}`);
        const container = document.getElementById(`multiPreview${i}`);
        const label = container.querySelector('.multi-preview-label');

        if (pageIndex < total) {
          // Render this page
          renderToCanvas(canvas, pageIndex, 270, 360);
          container.classList.remove('empty');
          container.classList.toggle('active', pageIndex === state.currentPage);
          label.textContent = `ç¬¬${pageIndex + 1}é¡µ`;
          label.style.display = 'block';
        } else {
          // Empty slot
          const ctx = canvas.getContext('2d');
          canvas.width = 270;
          canvas.height = 360;
          ctx.fillStyle = '#e5e7eb';
          ctx.fillRect(0, 0, 270, 360);
          ctx.fillStyle = '#9ca3af';
          ctx.font = '16px "Noto Sans SC", sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText('æ— å†…å®¹', 135, 180);
          container.classList.add('empty');
          container.classList.remove('active');
          label.textContent = `ç¬¬${pageIndex + 1}é¡µ`;
        }
      }

      // Update navigation buttons and range display
      const prevBtn = document.getElementById('prevMultiBtn');
      const nextBtn = document.getElementById('nextMultiBtn');
      const rangeLabel = document.getElementById('multiPageRange');

      prevBtn.disabled = start === 0;
      nextBtn.disabled = start + 4 >= total;

      const endPage = Math.min(start + 4, total);
      rangeLabel.textContent = total > 0 ? `${start + 1}-${endPage} / ${total}` : '0 / 0';
    }

    function selectMultiPreviewPage(slotIndex) {
      const pageIndex = state.multiPageStart + slotIndex;
      if (pageIndex < state.pages.length) {
        state.currentPage = pageIndex;
        updatePageIndicator();
        updateMultiPreview();
        // Also update main preview if we switch back to single view
        updatePreview();
      }
    }

    function prevMultiPage() {
      if (state.multiPageStart >= 4) {
        state.multiPageStart -= 4;
        updateMultiPreview();
      }
    }

    function nextMultiPage() {
      if (state.multiPageStart + 4 < state.pages.length) {
        state.multiPageStart += 4;
        updateMultiPreview();
      }
    }

    function editMultiPreviewPage(slotIndex) {
      const pageIndex = state.multiPageStart + slotIndex;
      if (pageIndex < state.pages.length) {
        // Select the page
        state.currentPage = pageIndex;
        // Switch to single-page mode
        toggleMultiPreview();
        // Enable edit mode
        if (!state.editMode) {
          toggleEditMode();
        }
      }
    }

    function updatePreview() {
      renderToCanvas(document.getElementById('previewCanvas'), state.currentPage, 540, 720);
      // Also update multi-preview if active
      if (state.multiPreviewMode) {
        updateMultiPreview();
      }
    }

    function getFontFamily(fontId) {
      const font = fonts.find(f => f.id === fontId);
      return font ? font.family : '"Noto Sans SC", sans-serif';
    }

    function renderToCanvas(canvas, pageIndex, width, height) {
      const ctx = canvas.getContext('2d');
      canvas.width = width;
      canvas.height = height;

      const template = templates.find(t => t.id === state.templateId) || defaultTemplates[0];
      template.background(ctx, width, height);

      const page = state.pages[pageIndex] || { title: '', content: '' };
      const scale = width / 300;

      // Use custom padding values
      const paddingTop = height * (state.paddingTop / 100);
      const paddingBottom = height * (state.paddingBottom / 100);
      const paddingLeft = width * (state.paddingLeft / 100);
      const paddingRight = width * (state.paddingRight / 100);
      const maxWidth = width - paddingLeft - paddingRight;

      let currentY = paddingTop;

      // Apply title Y offset
      const titleYOffset = height * (state.titleYOffset / 100);
      const contentYOffset = height * (state.contentYOffset / 100);

      // Draw title if exists and split mode
      if (state.splitMode && page.title) {
        const titleFontSize = state.titleFontSize * scale;
        ctx.fillStyle = state.titleColor;
        ctx.font = `bold ${titleFontSize}px ${getFontFamily(state.titleFontId)}`;
        ctx.textAlign = state.titleAlignment;
        ctx.textBaseline = 'top';

        const titleLines = wrapText(ctx, page.title, maxWidth);
        const titleHeight = titleLines.length * titleFontSize * 1.4;

        const titleXPos = state.titleAlignment === 'left' ? paddingLeft :
                         state.titleAlignment === 'right' ? width - paddingRight :
                         width / 2;

        const titleStartY = currentY + titleYOffset;
        titleLines.forEach((line, i) => {
          ctx.fillText(line, titleXPos, titleStartY + i * titleFontSize * 1.4);
        });

        currentY += titleHeight + paddingTop * 0.8;
      }

      // Draw content
      const fontSize = state.fontSize * scale;
      const lineHeight = state.lineHeight;

      ctx.fillStyle = state.textColor;
      ctx.font = `${fontSize}px ${getFontFamily(state.fontId)}`;
      ctx.textAlign = state.alignment;
      ctx.textBaseline = 'top';

      const contentLines = wrapText(ctx, page.content, maxWidth);
      const contentHeight = contentLines.length * fontSize * lineHeight;

      // Calculate start Y for content
      let contentStartY;
      if (state.splitMode && page.title) {
        contentStartY = currentY + contentYOffset;
      } else {
        contentStartY = (height - contentHeight) / 2 + contentYOffset;
        if (contentStartY < paddingTop) contentStartY = paddingTop;
      }

      const xPos = state.alignment === 'left' ? paddingLeft :
                   state.alignment === 'right' ? width - paddingRight :
                   width / 2;

      contentLines.forEach((line, i) => {
        const y = contentStartY + i * fontSize * lineHeight;
        if (y < height - paddingBottom) {
          ctx.fillText(line, xPos, y);
        }
      });

      // Draw decorations
      state.decorations.forEach((deco, idx) => {
        drawDecoration(ctx, deco, width, height, scale, idx === state.selectedDecoration);
      });

      // Draw text segments (special styled text)
      state.textSegments.forEach((seg, idx) => {
        const segX = width * (seg.x / 100);
        const segY = height * (seg.y / 100);
        const segSize = seg.size * scale;

        ctx.fillStyle = seg.color;
        ctx.font = `${seg.bold ? 'bold ' : ''}${segSize}px ${getFontFamily(state.fontId)}`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(seg.text, segX, segY);

        // Draw selection indicator
        if (idx === state.selectedSegment) {
          const textWidth = ctx.measureText(seg.text).width;
          ctx.strokeStyle = '#ff2442';
          ctx.lineWidth = 2;
          ctx.setLineDash([4, 4]);
          ctx.strokeRect(segX - textWidth / 2 - 4, segY - segSize / 2 - 4, textWidth + 8, segSize + 8);
          ctx.setLineDash([]);
        }
      });

      // Draw watermark
      if (watermarkImage && state.watermark) {
        const wmWidth = width * (state.watermarkSize / 100);
        const wmHeight = wmWidth * (watermarkImage.height / watermarkImage.width);
        const wmX = width * (state.watermarkX / 100) - wmWidth / 2;
        const wmY = height * (state.watermarkY / 100) - wmHeight / 2;

        ctx.globalAlpha = state.watermarkOpacity / 100;
        ctx.drawImage(watermarkImage, wmX, wmY, wmWidth, wmHeight);
        ctx.globalAlpha = 1;
      }

      // Page number
      if (state.pages.length > 1) {
        ctx.font = `${10 * scale}px "Noto Sans SC", sans-serif`;
        ctx.fillStyle = 'rgba(128, 128, 128, 0.5)';
        ctx.textAlign = 'center';
        ctx.fillText(`${pageIndex + 1} / ${state.pages.length}`, width / 2, height - 12 * scale);
      }
    }

    // Draw decoration element
    function drawDecoration(ctx, deco, width, height, scale, isSelected) {
      const x = width * (deco.x / 100);
      const y = height * (deco.y / 100);
      const size = deco.size * scale;

      ctx.fillStyle = deco.color;
      ctx.strokeStyle = deco.color;
      ctx.lineWidth = 2 * scale;

      switch (deco.type) {
        case 'line-h':
          ctx.beginPath();
          ctx.moveTo(x - size, y);
          ctx.lineTo(x + size, y);
          ctx.stroke();
          break;
        case 'line-v':
          ctx.beginPath();
          ctx.moveTo(x, y - size);
          ctx.lineTo(x, y + size);
          ctx.stroke();
          break;
        case 'circle':
          ctx.beginPath();
          ctx.arc(x, y, size / 2, 0, Math.PI * 2);
          ctx.stroke();
          break;
        case 'square':
          ctx.strokeRect(x - size / 2, y - size / 2, size, size);
          break;
        case 'star':
          drawStar(ctx, x, y, 5, size / 2, size / 4);
          ctx.fill();
          break;
        case 'heart':
          drawHeart(ctx, x, y, size / 2);
          ctx.fill();
          break;
        case 'dot':
          ctx.beginPath();
          ctx.arc(x, y, size / 4, 0, Math.PI * 2);
          ctx.fill();
          break;
        case 'diamond':
          ctx.beginPath();
          ctx.moveTo(x, y - size / 2);
          ctx.lineTo(x + size / 2, y);
          ctx.lineTo(x, y + size / 2);
          ctx.lineTo(x - size / 2, y);
          ctx.closePath();
          ctx.fill();
          break;
        case 'quote-left':
        case 'quote-right':
        case 'leaf':
        case 'flower':
        case 'sun':
        case 'moon':
        case 'cloud':
        case 'bolt':
          // For these, draw text-based icons
          const icons = {
            'quote-left': '"',
            'quote-right': '"',
            'leaf': 'ğŸƒ',
            'flower': 'âœ¿',
            'sun': 'â˜€',
            'moon': 'â˜½',
            'cloud': 'â˜',
            'bolt': 'âš¡'
          };
          ctx.font = `${size}px "Noto Sans SC", sans-serif`;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(icons[deco.type], x, y);
          break;
      }

      // Draw selection indicator
      if (isSelected) {
        ctx.strokeStyle = '#ff2442';
        ctx.lineWidth = 2;
        ctx.setLineDash([4, 4]);
        ctx.strokeRect(x - size / 2 - 4, y - size / 2 - 4, size + 8, size + 8);
        ctx.setLineDash([]);
      }
    }

    function drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius) {
      let rot = Math.PI / 2 * 3;
      let x = cx, y = cy;
      const step = Math.PI / spikes;
      ctx.beginPath();
      ctx.moveTo(cx, cy - outerRadius);
      for (let i = 0; i < spikes; i++) {
        x = cx + Math.cos(rot) * outerRadius;
        y = cy + Math.sin(rot) * outerRadius;
        ctx.lineTo(x, y);
        rot += step;
        x = cx + Math.cos(rot) * innerRadius;
        y = cy + Math.sin(rot) * innerRadius;
        ctx.lineTo(x, y);
        rot += step;
      }
      ctx.lineTo(cx, cy - outerRadius);
      ctx.closePath();
    }

    function drawHeart(ctx, cx, cy, size) {
      ctx.beginPath();
      ctx.moveTo(cx, cy + size * 0.4);
      ctx.bezierCurveTo(cx - size, cy - size * 0.2, cx - size * 0.5, cy - size, cx, cy - size * 0.4);
      ctx.bezierCurveTo(cx + size * 0.5, cy - size, cx + size, cy - size * 0.2, cx, cy + size * 0.4);
      ctx.closePath();
    }

    function wrapText(ctx, text, maxWidth) {
      if (!text) return [];
      const paragraphs = text.split('\n');
      const lines = [];

      for (const para of paragraphs) {
        if (!para.trim()) { lines.push(''); continue; }
        let currentLine = '';
        for (const char of para) {
          const testLine = currentLine + char;
          if (ctx.measureText(testLine).width > maxWidth && currentLine) {
            lines.push(currentLine);
            currentLine = char;
          } else {
            currentLine = testLine;
          }
        }
        if (currentLine) lines.push(currentLine);
      }
      return lines;
    }

    function downloadCurrent() {
      // æƒé™æ£€æŸ¥
      if (!hasPermission('download')) {
        showAlert('warning', 'æƒé™ä¸è¶³', 'è®¿å®¢æ— æ³•ä¸‹è½½å°é¢ï¼Œè¯·å‡çº§è´¦æˆ·');
        return;
      }

      const canvas = document.getElementById('exportCanvas');
      renderToCanvas(canvas, state.currentPage, 2160, 2880);
      const link = document.createElement('a');
      link.download = `å°çº¢ä¹¦å¡ç‰‡_${state.currentPage + 1}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      // è®°å½•ä¸‹è½½ç»Ÿè®¡
      recordUsage('download');
      showAlert('success', 'ä¸‹è½½æˆåŠŸ', `ç¬¬ ${state.currentPage + 1} å¼ å·²ä¿å­˜`);
    }

    async function downloadAll() {
      // æƒé™æ£€æŸ¥
      if (!hasPermission('download')) {
        showAlert('warning', 'æƒé™ä¸è¶³', 'è®¿å®¢æ— æ³•ä¸‹è½½å°é¢ï¼Œè¯·å‡çº§è´¦æˆ·');
        return;
      }

      const canvas = document.getElementById('exportCanvas');
      for (let i = 0; i < state.pages.length; i++) {
        renderToCanvas(canvas, i, 2160, 2880);
        const link = document.createElement('a');
        link.download = `å°çº¢ä¹¦å¡ç‰‡_${i + 1}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        // è®°å½•ä¸‹è½½ç»Ÿè®¡
        recordUsage('download');
        await new Promise(r => setTimeout(r, 300));
      }
      showAlert('success', 'ä¸‹è½½å®Œæˆ', `å…± ${state.pages.length} å¼ å·²ä¿å­˜`);
    }

    function showAlert(type, title, message) {
      const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸' };
      document.getElementById('alertIcon').textContent = icons[type] || icons.info;
      document.getElementById('alertTitle').textContent = title;
      document.getElementById('alertMessage').textContent = message;
      document.getElementById('alertModal').classList.add('show');
    }

    function closeAlert() {
      document.getElementById('alertModal').classList.remove('show');
    }

    // ===== EDIT MODE FUNCTIONS =====

    function toggleEditMode() {
      state.editMode = !state.editMode;
      const btn = document.getElementById('editModeBtn');
      const panel = document.getElementById('editModePanel');
      const wrapper = document.getElementById('canvasWrapper');

      btn.classList.toggle('active', state.editMode);
      panel.classList.toggle('hidden', !state.editMode);
      wrapper.classList.toggle('edit-mode', state.editMode);

      if (state.editMode) {
        btn.innerHTML = '<i class="fas fa-check mr-1"></i> å®Œæˆç¼–è¾‘';
      } else {
        btn.innerHTML = '<i class="fas fa-edit mr-1"></i> ç¼–è¾‘æ¨¡å¼';
      }
    }

    function switchEditTab(tab) {
      state.editTab = tab;
      const tabs = ['position', 'padding', 'text', 'decoration', 'watermark'];
      tabs.forEach((t, i) => {
        document.getElementById(`editTab${t.charAt(0).toUpperCase() + t.slice(1)}`).classList.toggle('hidden', t !== tab);
        document.querySelectorAll('.edit-tab-btn')[i].classList.toggle('active', t === tab);
      });
    }

    function setupEditModeListeners() {
      // Position sliders
      document.getElementById('titleYOffset').addEventListener('input', e => {
        state.titleYOffset = parseInt(e.target.value);
        document.getElementById('titleYVal').textContent = state.titleYOffset;
        updatePreview();
      });

      document.getElementById('contentYOffset').addEventListener('input', e => {
        state.contentYOffset = parseInt(e.target.value);
        document.getElementById('contentYVal').textContent = state.contentYOffset;
        updatePreview();
      });

      // Padding sliders
      ['Top', 'Bottom', 'Left', 'Right'].forEach(dir => {
        document.getElementById(`padding${dir}`).addEventListener('input', e => {
          state[`padding${dir}`] = parseInt(e.target.value);
          document.getElementById(`padding${dir}Val`).textContent = state[`padding${dir}`];
          updatePreview();
        });
      });

      // Watermark upload
      document.getElementById('watermarkInput').addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) handleWatermarkUpload(file);
        e.target.value = '';
      });

      // Watermark controls
      document.getElementById('watermarkX').addEventListener('input', e => {
        state.watermarkX = parseInt(e.target.value);
        document.getElementById('watermarkXVal').textContent = state.watermarkX;
        updatePreview();
      });

      document.getElementById('watermarkY').addEventListener('input', e => {
        state.watermarkY = parseInt(e.target.value);
        document.getElementById('watermarkYVal').textContent = state.watermarkY;
        updatePreview();
      });

      document.getElementById('watermarkSize').addEventListener('input', e => {
        state.watermarkSize = parseInt(e.target.value);
        document.getElementById('watermarkSizeVal').textContent = state.watermarkSize;
        updatePreview();
      });

      document.getElementById('watermarkOpacity').addEventListener('input', e => {
        state.watermarkOpacity = parseInt(e.target.value);
        document.getElementById('watermarkOpacityVal').textContent = state.watermarkOpacity;
        updatePreview();
      });

      // Canvas click for decoration selection/placement
      const canvas = document.getElementById('previewCanvas');
      canvas.addEventListener('click', handleCanvasClick);

      // Decoration dragging
      let dragDeco = null;
      let dragOffset = { x: 0, y: 0 };

      canvas.addEventListener('mousedown', e => {
        if (!state.editMode || state.editTab !== 'decoration') return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width * 100;
        const y = (e.clientY - rect.top) / rect.height * 100;

        // Check if clicking on a decoration
        for (let i = state.decorations.length - 1; i >= 0; i--) {
          const deco = state.decorations[i];
          const size = deco.size / 3 * (100 / 300); // approximate hit area
          if (Math.abs(deco.x - x) < size && Math.abs(deco.y - y) < size) {
            dragDeco = i;
            state.selectedDecoration = i;
            dragOffset = { x: deco.x - x, y: deco.y - y };
            updatePreview();
            break;
          }
        }
      });

      canvas.addEventListener('mousemove', e => {
        if (dragDeco === null) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width * 100;
        const y = (e.clientY - rect.top) / rect.height * 100;

        state.decorations[dragDeco].x = Math.max(5, Math.min(95, x + dragOffset.x));
        state.decorations[dragDeco].y = Math.max(5, Math.min(95, y + dragOffset.y));
        updatePreview();
      });

      canvas.addEventListener('mouseup', () => {
        dragDeco = null;
      });

      canvas.addEventListener('mouseleave', () => {
        dragDeco = null;
      });

      // Touch support for mobile
      canvas.addEventListener('touchstart', e => {
        if (!state.editMode || state.editTab !== 'decoration') return;
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = (touch.clientX - rect.left) / rect.width * 100;
        const y = (touch.clientY - rect.top) / rect.height * 100;

        for (let i = state.decorations.length - 1; i >= 0; i--) {
          const deco = state.decorations[i];
          const size = deco.size / 3 * (100 / 300);
          if (Math.abs(deco.x - x) < size && Math.abs(deco.y - y) < size) {
            dragDeco = i;
            state.selectedDecoration = i;
            dragOffset = { x: deco.x - x, y: deco.y - y };
            updatePreview();
            e.preventDefault();
            break;
          }
        }
      }, { passive: false });

      canvas.addEventListener('touchmove', e => {
        if (dragDeco === null) return;
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = (touch.clientX - rect.left) / rect.width * 100;
        const y = (touch.clientY - rect.top) / rect.height * 100;

        state.decorations[dragDeco].x = Math.max(5, Math.min(95, x + dragOffset.x));
        state.decorations[dragDeco].y = Math.max(5, Math.min(95, y + dragOffset.y));
        updatePreview();
        e.preventDefault();
      }, { passive: false });

      canvas.addEventListener('touchend', () => {
        dragDeco = null;
      });
    }

    function handleCanvasClick(e) {
      if (!state.editMode) return;

      const canvas = e.target;
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width * 100;
      const y = (e.clientY - rect.top) / rect.height * 100;

      if (state.editTab === 'decoration') {
        // Check if clicking on existing decoration
        let found = false;
        for (let i = state.decorations.length - 1; i >= 0; i--) {
          const deco = state.decorations[i];
          const size = deco.size / 3 * (100 / 300);
          if (Math.abs(deco.x - x) < size && Math.abs(deco.y - y) < size) {
            state.selectedDecoration = i;
            found = true;
            break;
          }
        }
        if (!found) {
          state.selectedDecoration = null;
        }
        updatePreview();
      }
    }

    function resetPositions() {
      state.titleYOffset = 0;
      state.contentYOffset = 0;
      document.getElementById('titleYOffset').value = 0;
      document.getElementById('contentYOffset').value = 0;
      document.getElementById('titleYVal').textContent = '0';
      document.getElementById('contentYVal').textContent = '0';
      updatePreview();
    }

    function resetPadding() {
      state.paddingTop = 8;
      state.paddingBottom = 8;
      state.paddingLeft = 8;
      state.paddingRight = 8;
      ['Top', 'Bottom', 'Left', 'Right'].forEach(dir => {
        document.getElementById(`padding${dir}`).value = 8;
        document.getElementById(`padding${dir}Val`).textContent = '8';
      });
      updatePreview();
    }

    function addDecoration(type) {
      const color = document.getElementById('decorationColor').value;
      const size = parseInt(document.getElementById('decorationSize').value);

      state.decorations.push({
        type,
        x: 50,
        y: 50,
        color,
        size
      });
      state.selectedDecoration = state.decorations.length - 1;
      updatePreview();
    }

    function deleteSelectedDecoration() {
      if (state.selectedDecoration !== null) {
        state.decorations.splice(state.selectedDecoration, 1);
        state.selectedDecoration = null;
        updatePreview();
      }
    }

    function clearAllDecorations() {
      state.decorations = [];
      state.selectedDecoration = null;
      updatePreview();
    }

    function handleWatermarkUpload(file) {
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          watermarkImage = img;
          state.watermark = e.target.result;

          document.getElementById('watermarkPreview').classList.remove('hidden');
          document.getElementById('watermarkControls').classList.remove('hidden');
          document.getElementById('watermarkImg').src = e.target.result;
          document.getElementById('watermarkName').textContent = file.name;

          updatePreview();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function removeWatermark() {
      watermarkImage = null;
      state.watermark = null;
      document.getElementById('watermarkPreview').classList.add('hidden');
      document.getElementById('watermarkControls').classList.add('hidden');
      document.getElementById('watermarkImg').src = '';
      updatePreview();
    }

    // ===== TEXT EDITING FUNCTIONS =====

    function toggleClickEdit() {
      state.clickEditEnabled = !state.clickEditEnabled;
      document.getElementById('clickEditToggle').classList.toggle('active', state.clickEditEnabled);
    }

    function openTextEdit(target) {
      state.editingTarget = target;
      const overlay = document.getElementById('textEditOverlay');
      const area = document.getElementById('textEditArea');
      const title = document.getElementById('textEditTitle');

      if (target === 'title') {
        title.textContent = 'ç¼–è¾‘æ ‡é¢˜';
        area.value = state.title;
      } else {
        title.textContent = 'ç¼–è¾‘æ­£æ–‡';
        area.value = state.text;
      }

      overlay.classList.remove('hidden');
      area.focus();
    }

    function closeTextEdit() {
      document.getElementById('textEditOverlay').classList.add('hidden');
      state.editingTarget = null;
    }

    function saveTextEdit() {
      const area = document.getElementById('textEditArea');
      const newText = area.value;

      if (state.editingTarget === 'title') {
        state.title = newText;
        if (state.splitMode) {
          document.getElementById('titleInput').value = newText;
        }
      } else {
        state.text = newText;
        if (state.splitMode) {
          document.getElementById('contentInput').value = newText;
        } else {
          document.getElementById('textInput').value = newText;
        }
      }

      updateStats();
      splitPages();
      updatePreview();
      closeTextEdit();
    }

    function showAddSegmentModal() {
      document.getElementById('segmentModal').classList.add('show');
      document.getElementById('segmentText').value = '';
      document.getElementById('segmentSize').value = 24;
      document.getElementById('segmentSizeVal').textContent = '24';
      document.getElementById('segmentColor').value = '#ff2442';
      document.getElementById('segmentX').value = 50;
      document.getElementById('segmentY').value = 50;
      document.getElementById('segmentXVal').textContent = '50';
      document.getElementById('segmentYVal').textContent = '50';
      document.getElementById('segmentBold').checked = false;

      // Setup listeners for real-time update
      document.getElementById('segmentSize').oninput = e => {
        document.getElementById('segmentSizeVal').textContent = e.target.value;
      };
      document.getElementById('segmentX').oninput = e => {
        document.getElementById('segmentXVal').textContent = e.target.value;
      };
      document.getElementById('segmentY').oninput = e => {
        document.getElementById('segmentYVal').textContent = e.target.value;
      };
    }

    function closeSegmentModal() {
      document.getElementById('segmentModal').classList.remove('show');
    }

    function saveSegment() {
      const text = document.getElementById('segmentText').value.trim();
      if (!text) {
        showAlert('warning', 'è¯·è¾“å…¥æ–‡å­—', 'æ–‡å­—å†…å®¹ä¸èƒ½ä¸ºç©º');
        return;
      }

      state.textSegments.push({
        text,
        size: parseInt(document.getElementById('segmentSize').value),
        color: document.getElementById('segmentColor').value,
        x: parseInt(document.getElementById('segmentX').value),
        y: parseInt(document.getElementById('segmentY').value),
        bold: document.getElementById('segmentBold').checked
      });

      state.selectedSegment = state.textSegments.length - 1;
      closeSegmentModal();
      renderTextSegmentsList();
      updatePreview();
    }

    function addTextSegment(sizeType) {
      const sizes = { small: 14, normal: 20, large: 28, xlarge: 36 };
      const size = sizes[sizeType] || 20;

      state.textSegments.push({
        text: 'æ–‡å­—',
        size,
        color: state.textColor,
        x: 50,
        y: 50,
        bold: sizeType === 'xlarge'
      });

      state.selectedSegment = state.textSegments.length - 1;
      renderTextSegmentsList();
      updatePreview();
    }

    function renderTextSegmentsList() {
      const list = document.getElementById('textSegmentsList');
      if (state.textSegments.length === 0) {
        list.innerHTML = '<p class="text-xs text-gray-400 italic">æš‚æ— ç‰¹æ®Šæ–‡å­—æ®µè½</p>';
        return;
      }

      list.innerHTML = state.textSegments.map((seg, i) => `
        <div class="flex items-center gap-2 p-2 rounded-lg ${i === state.selectedSegment ? 'bg-pink-50 dark:bg-pink-900/20 border border-pink-300' : 'bg-gray-100 dark:bg-gray-700'}">
          <span class="flex-1 text-xs truncate" style="color:${seg.color}; font-weight:${seg.bold ? 'bold' : 'normal'}; font-size:${Math.min(seg.size, 16)}px">${seg.text}</span>
          <span class="text-xs text-gray-400">${seg.size}px</span>
          <button onclick="selectSegment(${i})" class="text-blue-500 text-xs"><i class="fas fa-mouse-pointer"></i></button>
          <button onclick="deleteSegment(${i})" class="text-red-500 text-xs"><i class="fas fa-trash"></i></button>
        </div>
      `).join('');
    }

    function selectSegment(index) {
      state.selectedSegment = index;
      renderTextSegmentsList();
      updatePreview();
    }

    function deleteSegment(index) {
      state.textSegments.splice(index, 1);
      if (state.selectedSegment === index) {
        state.selectedSegment = null;
      } else if (state.selectedSegment > index) {
        state.selectedSegment--;
      }
      renderTextSegmentsList();
      updatePreview();
    }

    // Add click-to-edit functionality to canvas
    function setupTextEditClickHandler() {
      const canvas = document.getElementById('previewCanvas');

      canvas.addEventListener('dblclick', e => {
        if (!state.editMode || !state.clickEditEnabled) return;
        if (state.editTab !== 'text') return;

        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width * 100;
        const y = (e.clientY - rect.top) / rect.height * 100;

        // Check if clicking on a text segment
        for (let i = state.textSegments.length - 1; i >= 0; i--) {
          const seg = state.textSegments[i];
          const hitSize = seg.size / 300 * 100 * 1.5;
          if (Math.abs(seg.x - x) < hitSize && Math.abs(seg.y - y) < hitSize / 2) {
            state.selectedSegment = i;
            editSelectedSegment();
            return;
          }
        }

        // Check if clicking on title area (top 30%)
        if (state.splitMode && y < 35) {
          openTextEdit('title');
        } else {
          openTextEdit('content');
        }
      });

      // Single click to select segments
      canvas.addEventListener('click', e => {
        if (!state.editMode || state.editTab !== 'text') return;

        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width * 100;
        const y = (e.clientY - rect.top) / rect.height * 100;

        let found = false;
        for (let i = state.textSegments.length - 1; i >= 0; i--) {
          const seg = state.textSegments[i];
          const hitSize = seg.size / 300 * 100 * 1.5;
          if (Math.abs(seg.x - x) < hitSize && Math.abs(seg.y - y) < hitSize / 2) {
            state.selectedSegment = i;
            found = true;
            break;
          }
        }
        if (!found) {
          state.selectedSegment = null;
        }
        renderTextSegmentsList();
        updatePreview();
      });

      // Drag text segments
      let dragSeg = null;
      let dragOffset = { x: 0, y: 0 };

      canvas.addEventListener('mousedown', e => {
        if (!state.editMode || state.editTab !== 'text') return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width * 100;
        const y = (e.clientY - rect.top) / rect.height * 100;

        for (let i = state.textSegments.length - 1; i >= 0; i--) {
          const seg = state.textSegments[i];
          const hitSize = seg.size / 300 * 100 * 1.5;
          if (Math.abs(seg.x - x) < hitSize && Math.abs(seg.y - y) < hitSize / 2) {
            dragSeg = i;
            state.selectedSegment = i;
            dragOffset = { x: seg.x - x, y: seg.y - y };
            renderTextSegmentsList();
            updatePreview();
            break;
          }
        }
      });

      canvas.addEventListener('mousemove', e => {
        if (dragSeg === null) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width * 100;
        const y = (e.clientY - rect.top) / rect.height * 100;

        state.textSegments[dragSeg].x = Math.max(5, Math.min(95, x + dragOffset.x));
        state.textSegments[dragSeg].y = Math.max(5, Math.min(95, y + dragOffset.y));
        updatePreview();
      });

      canvas.addEventListener('mouseup', () => { dragSeg = null; });
      canvas.addEventListener('mouseleave', () => { dragSeg = null; });
    }

    function editSelectedSegment() {
      if (state.selectedSegment === null) return;
      const seg = state.textSegments[state.selectedSegment];

      document.getElementById('segmentModal').classList.add('show');
      document.getElementById('segmentText').value = seg.text;
      document.getElementById('segmentSize').value = seg.size;
      document.getElementById('segmentSizeVal').textContent = seg.size;
      document.getElementById('segmentColor').value = seg.color;
      document.getElementById('segmentX').value = seg.x;
      document.getElementById('segmentY').value = seg.y;
      document.getElementById('segmentXVal').textContent = seg.x;
      document.getElementById('segmentYVal').textContent = seg.y;
      document.getElementById('segmentBold').checked = seg.bold;

      // Setup listeners
      document.getElementById('segmentSize').oninput = e => {
        document.getElementById('segmentSizeVal').textContent = e.target.value;
      };
      document.getElementById('segmentX').oninput = e => {
        document.getElementById('segmentXVal').textContent = e.target.value;
      };
      document.getElementById('segmentY').oninput = e => {
        document.getElementById('segmentYVal').textContent = e.target.value;
      };

      // Replace save function temporarily
      const saveBtn = document.querySelector('#segmentModal .btn-primary');
      saveBtn.onclick = () => {
        const text = document.getElementById('segmentText').value.trim();
        if (!text) {
          showAlert('warning', 'è¯·è¾“å…¥æ–‡å­—', 'æ–‡å­—å†…å®¹ä¸èƒ½ä¸ºç©º');
          return;
        }

        state.textSegments[state.selectedSegment] = {
          text,
          size: parseInt(document.getElementById('segmentSize').value),
          color: document.getElementById('segmentColor').value,
          x: parseInt(document.getElementById('segmentX').value),
          y: parseInt(document.getElementById('segmentY').value),
          bold: document.getElementById('segmentBold').checked
        };

        closeSegmentModal();
        renderTextSegmentsList();
        updatePreview();
        saveBtn.onclick = saveSegment;
      };
    }

    // Initialize text edit click handler
    setupTextEditClickHandler();

    // æ³¨æ„ï¼šinit() ç°åœ¨ç”±ç™»å½•æˆåŠŸåè°ƒç”¨ï¼Œä¸å†è‡ªåŠ¨æ‰§è¡Œ
    // init();
  </script>




</body></html>